# ================================
# 应用配置
# ================================
# 服务运行端口（必填）
PORT=8080

# 运行环境：development | production | test（必填）
# development - 开发环境
# production - 生产环境
# test - 测试环境
NODE_ENV=development

# ================================
# Agent API 配置（AI 智能回复服务）
# ================================
# Agent API 密钥（必填）
# 请联系管理员获取 API Key
AGENT_API_KEY=your-api-key-here

# Agent API 基地址（必填）
# 示例: https://your-agent-api.com/api/v1
AGENT_API_BASE_URL=http://localhost:3000/api/v1

# 默认使用的 AI 模型（必填）
# 推荐使用: anthropic/claude-3-5-haiku-latest (快速、经济)
# 其他可选: anthropic/claude-3-5-sonnet-latest (平衡性能)
# 注意: 模型需要在 Agent API 的可用列表中
AGENT_DEFAULT_MODEL=anthropic/claude-3-5-haiku-latest

# 候选人咨询场景的模型配置（必填）
# 聊天模型 - 用于与候选人对话
AGENT_CHAT_MODEL=anthropic/claude-sonnet-4-5-20250929
# 分类模型 - 用于意图识别和消息分类
AGENT_CLASSIFY_MODEL=openai/gpt-4o
# 回复模型 - 用于生成最终回复
AGENT_REPLY_MODEL=openai/gpt-5-chat-latest

# 允许使用的工具列表（必填，逗号分隔）
# 候选人咨询服务需要以下工具：
# - duliday_job_list: 查询在招岗位列表
# - duliday_job_details: 获取岗位详细信息
# - duliday_interview_booking: 预约面试
# 注意: 工具需要在 Agent API 的可用列表中
AGENT_ALLOWED_TOOLS=duliday_job_list,duliday_job_details,duliday_interview_booking

# Agent API 请求超时时间（毫秒）（必填）
AGENT_API_TIMEOUT=60000

# Agent API 健康检查间隔（毫秒，默认 1 小时）
# 用于定期检查可用的模型和工具，验证配置是否正确
AGENT_HEALTH_CHECK_INTERVAL_MS=3600000

# ================================
# Redis 缓存配置（Upstash）
# ================================
# Upstash Redis REST API URL（必填，用于 Agent 缓存）
# 用于缓存 Agent 响应，避免重复调用
UPSTASH_REDIS_REST_URL=https://enjoyed-cattle-63738.upstash.io

# Upstash Redis REST API Token（必填，用于 Agent 缓存）
UPSTASH_REDIS_REST_TOKEN=Afj6AAIncDFlMmE5YzU0OTg2MjI0NjE4ODBjOGFjMGQ1MWRiMzIxNnAxNjM3Mzg

# Upstash Redis TCP 连接（可选，用于 Bull 队列）
# 获取方式：在 Upstash Console -> Database Details 中找到
# 示例：redis://:your-password@enjoyed-cattle-63738.upstash.io:6379
# UPSTASH_REDIS_TCP_URL=rediss://default:your-password@enjoyed-cattle-63738.upstash.io:6379

# 响应缓存 TTL（秒，默认 1 小时）
# Redis 会自动删除过期的缓存
AGENT_RESPONSE_CACHE_TTL_SECONDS=3600

# 单条缓存最大大小（KB，默认 100KB）
# 超过此大小的响应不会被缓存
AGENT_RESPONSE_CACHE_MAX_ITEM_SIZE_KB=100

# ================================
# DuLiDay API 配置
# ================================
# DuLiDay API Token（必填）
# 用于调用杜力岱招聘工具 API（岗位查询、详情、面试预约等）
# 请联系管理员获取此 Token
DULIDAY_API_TOKEN=your-duliday-token-here

# ================================
# 其他配置
# ================================
# 是否启用 AI 自动回复（可选，默认 true）
ENABLE_AI_REPLY=true

# 是否启用消息分段发送（可选，默认 true）
# 启用后，AI 回复包含换行符时会自动拆分成多条消息发送
# 好处：提升用户阅读体验，避免单条消息过长
# 建议：保持启用，除非有特殊需求
ENABLE_MESSAGE_SPLIT_SEND=true

# ================================
# 托管平台 API 配置
# ================================
# Stride API 基地址 - 小组级接口（必填）
# 企微机器人托管平台的 API 地址
STRIDE_API_BASE_URL=https://stride-bg.dpclouds.com

# Stride API 基地址 - 企业级接口（必填）
# 企业级接口（如发送消息）需要使用此地址
STRIDE_ENTERPRISE_API_BASE_URL=https://stride-bg.dpclouds.com/hub-api

# ================================
# 消息历史管理配置
# ================================
# 每个会话保留的最大消息数（必填）
# 用于 Agent 上下文，超过此数量的旧消息将被移除
MAX_HISTORY_PER_CHAT=30

# 历史消息过期时间（毫秒，默认 2 小时）（必填）
# 超过此时间的消息将被清理
HISTORY_TTL_MS=7200000

# ================================
# 消息聚合配置（智能聚合策略）
# ================================
# 是否启用智能消息聚合功能（默认 true）
# 启用后，系统会在 Agent 处理期间收集新消息，并在响应后智能决策是否重新处理
# 好处：减少 API 调用成本，提升回复质量，更好地捕获用户补充的信息
ENABLE_MESSAGE_MERGE=true

# 首次聚合等待时间（毫秒，默认 1000ms）
# 收到第一条消息后等待此时间，期间收到的消息会聚合处理
# 建议值: 1000ms（1秒）- 平衡响应速度和聚合效果
# 用户体验：单条消息总等待 = 1秒 + Agent处理5秒 = 6秒
INITIAL_MERGE_WINDOW_MS=1000

# 每次请求最多聚合的消息条数（默认 3 条）
# 超过此数量只取最新 N 条（其余记录到历史）
# 建议值: 3 条（符合 95% 的用户行为，保证对话质量）
# 如果用户发送 >3 条消息，会记录告警日志
MAX_MERGED_MESSAGES=3

# Agent 响应后的重试次数限制（默认 1 次）
# 如果 Agent 处理期间收到新消息，最多重试几次
# 建议值: 1 次（避免等待过长，最坏情况 1+5+5=11秒可接受）
# 设为 0 则不重试，设为 2 则最坏情况 16 秒（不推荐）
MAX_RETRY_COUNT=1

# 触发重试的最小消息长度（字符数，默认 2）
# 防止误触或无意义短消息（如单个字符）触发重试
# 建议值: 2 个字符
MIN_MESSAGE_LENGTH_TO_RETRY=2

# 是否在 Agent 处理期间收集新消息（默认 true）
# 启用后，Agent 处理期间收到的新消息会被暂存，处理完成后检查并决定是否重试
COLLECT_MESSAGES_DURING_PROCESSING=true

# 超过消息条数限制时的策略（默认 take-latest）
# take-latest: 只取最新 N 条发送给 Agent（推荐，保证 prompt 质量）
# take-all: 全部聚合发送（不推荐，可能导致 prompt 过长）
OVERFLOW_STRATEGY=take-latest

# ================================
# Bull 队列配置（可选，用于生产环境）
# ================================
# 是否启用 Bull 队列（默认 false）
# 启用后使用 Redis 持久化队列，支持多实例部署和任务重试
# 未启用时使用内存队列（适合单实例、开发环境）
ENABLE_BULL_QUEUE=false

# Redis 连接配置（启用 Bull 队列时必填）
# 方式 1: 使用 Upstash Redis TCP 连接（推荐，生产环境）
# 获取方式：Upstash Console -> Database Details -> Endpoints -> TCP
# 格式: rediss://default:password@host:port
UPSTASH_REDIS_TCP_URL=rediss://default:your-password@enjoyed-cattle-63738.upstash.io:6379

# 方式 2: 使用通用 Redis URL（可选，本地开发或其他 Redis 服务）
# 示例: redis://username:password@host:port/db
# 示例: rediss://username:password@host:port/db (TLS)
# REDIS_URL=redis://localhost:6379

# 方式 3: 使用分离配置（可选，与上述二选一）
# REDIS_HOST=localhost
# REDIS_PORT=6379
# REDIS_PASSWORD=your-password
# REDIS_TLS=false

# 注意：
# 1. Upstash Redis REST API（UPSTASH_REDIS_REST_URL）不支持 Bull
# 2. Bull 队列需要使用 Upstash 的 TCP 端点（UPSTASH_REDIS_TCP_URL）
# 3. REST API 和 TCP 端点使用同一个 Redis 数据库，只是协议不同
# 4. 本地开发可以使用 Docker: docker run -d -p 6379:6379 redis
# 5. 配置优先级: UPSTASH_REDIS_TCP_URL > REDIS_URL > 分离配置

# ================================
# HTTP 客户端配置
# ================================
# HTTP 请求超时时间（毫秒）（必填）
HTTP_CLIENT_TIMEOUT=10000
