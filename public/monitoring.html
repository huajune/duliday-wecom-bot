<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bot ç›‘æ§ä»ªè¡¨ç›˜ - DuLiDay</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
      /* ========================================
         æµ…è‰²ç»ç’ƒé£è®¾è®¡ç³»ç»Ÿ - Light Glass Design
         ======================================== */

      :root {
        /* ä¸»è‰²è°ƒ - ç´«è“æ¸å˜ */
        --primary: #8b5cf6;
        --primary-dark: #7c3aed;
        --primary-light: #a78bfa;
        --accent: #6366f1;
        --accent-light: #818cf8;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --info: #06b6d4;

        /* æ–‡å­—é¢œè‰² */
        --text-primary: #1e293b;
        --text-secondary: #475569;
        --text-muted: #94a3b8;
        --text-on-gradient: rgba(255, 255, 255, 0.95);
        --text-on-gradient-muted: rgba(255, 255, 255, 0.7);

        /* èƒŒæ™¯ä¸è¾¹æ¡† */
        --bg-page: #f0f4ff;
        --bg-card: rgba(255, 255, 255, 0.85);
        --bg-card-hover: rgba(255, 255, 255, 0.98);
        --border: rgba(139, 92, 246, 0.12);
        --border-hover: rgba(139, 92, 246, 0.25);

        /* æ¸å˜ */
        --gradient-sidebar: linear-gradient(180deg, #a78bfa 0%, #818cf8 50%, #6366f1 100%);
        --gradient-primary: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);

        /* æ¯›ç»ç’ƒæ•ˆæœ */
        --glass-blur: 20px;
        --glass-shadow: 0 8px 32px rgba(139, 92, 246, 0.1);
        --glass-shadow-hover: 0 16px 48px rgba(139, 92, 246, 0.18);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: 'PingFang SC', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: var(--bg-page);
        color: var(--text-primary);
        padding: 0;
      }

      /* åŠ¨æ€èƒŒæ™¯æ¸å˜ */
      .background-gradients {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        overflow: hidden;
        background: linear-gradient(135deg, #f5f3ff 0%, #e0e7ff 50%, #dbeafe 100%);
      }

      .bg-blue, .bg-purple {
        position: absolute;
        border-radius: 50%;
        filter: blur(120px);
        opacity: 0.6;
        animation: float 25s infinite ease-in-out;
      }

      .bg-blue {
        top: -15%;
        left: -10%;
        width: 60vw;
        height: 60vw;
        background: radial-gradient(circle, rgba(99, 102, 241, 0.25), transparent 70%);
        animation-delay: 0s;
      }

      .bg-purple {
        bottom: -15%;
        right: -10%;
        width: 55vw;
        height: 55vw;
        background: radial-gradient(circle, rgba(139, 92, 246, 0.3), transparent 70%);
        animation-delay: -12s;
      }

      @keyframes float {
        0%, 100% { transform: translate(0, 0) scale(1); }
        33% { transform: translate(40px, -60px) scale(1.1); }
        66% { transform: translate(-30px, 30px) scale(0.95); }
      }

      .container {
        position: relative;
        z-index: 1;
        max-width: 1440px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .header {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 32px;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .header-top {
        display: flex;
        justify-content: space-between;
        gap: 24px;
        flex-wrap: wrap;
      }

      /* ç»Ÿä¸€æ§åˆ¶é¢æ¿ - åˆå¹¶ header å’Œå¥åº·çŠ¶æ€ */
      .control-panel {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.06) 0%, rgba(147, 51, 234, 0.06) 50%, rgba(236, 72, 153, 0.04) 100%);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 24px 32px;
        position: relative;
        overflow: hidden;
        margin-bottom: 0;
      }

      .control-panel::before {
        content: '';
        position: absolute;
        top: -60%;
        right: -15%;
        width: 400px;
        height: 400px;
        background: radial-gradient(circle, rgba(59, 130, 246, 0.12) 0%, transparent 70%);
        pointer-events: none;
      }

      .control-panel::after {
        content: '';
        position: absolute;
        bottom: -40%;
        left: -5%;
        width: 250px;
        height: 250px;
        background: radial-gradient(circle, rgba(147, 51, 234, 0.08) 0%, transparent 70%);
        pointer-events: none;
      }

      .control-panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 20px;
        margin-bottom: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        position: relative;
        z-index: 1;
      }

      .control-panel-left {
        display: flex;
        align-items: center;
        gap: 24px;
      }

      .control-panel-right {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .control-panel-title {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 8px;
        padding-right: 20px;
        border-right: 1px solid rgba(255, 255, 255, 0.1);
      }

      .control-panel-title::before {
        content: 'âš¡';
        font-size: 16px;
      }

      .control-panel .filters {
        margin: 0;
      }

      .control-panel .health-grid {
        position: relative;
        z-index: 1;
      }

      .control-panel .health-panel-badge {
        font-size: 11px;
        padding: 4px 10px;
        border-radius: 12px;
        background: rgba(34, 197, 94, 0.15);
        color: var(--success);
        font-weight: 500;
      }

      .control-panel .health-panel-badge.warning {
        background: rgba(245, 158, 11, 0.15);
        color: var(--warning);
      }

      .control-panel .health-panel-badge.error {
        background: rgba(239, 68, 68, 0.15);
        color: var(--danger);
      }

      /* è£…é¥°æ€§å…‰ç‚¹æ•ˆæœ */
      .control-panel .decorative-dot {
        position: absolute;
        border-radius: 50%;
        background: rgba(59, 130, 246, 0.3);
        filter: blur(1px);
        pointer-events: none;
        z-index: 0;
      }

      .control-panel .decorative-dot:nth-child(1) {
        top: 20px;
        right: 100px;
        width: 6px;
        height: 6px;
        animation: pulse-dot 3s infinite;
      }

      .control-panel .decorative-dot:nth-child(2) {
        bottom: 30px;
        right: 200px;
        width: 4px;
        height: 4px;
        background: rgba(147, 51, 234, 0.4);
        animation: pulse-dot 4s infinite 1s;
      }

      @keyframes pulse-dot {
        0%, 100% { opacity: 0.3; transform: scale(1); }
        50% { opacity: 0.8; transform: scale(1.5); }
      }

      .header h1 {
        margin: 4px 0 8px;
        font-size: 28px;
      }

      .eyebrow {
        color: var(--text-muted);
        font-size: 13px;
        letter-spacing: 0.2em;
        text-transform: uppercase;
      }

      .header-actions {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .filters {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .filters {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .filters button {
        background: rgba(255, 255, 255, 0.6);
        border: 1px solid var(--border);
        color: var(--text-secondary);
        border-radius: 999px;
        padding: 6px 14px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .filters button:hover {
        border-color: var(--primary);
        background: rgba(139, 92, 246, 0.08);
        color: var(--primary);
      }

      .filters button.active {
        background: var(--gradient-primary);
        border-color: transparent;
        color: #fff;
        box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
      }

      .header-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
      }

      .btn {
        border-radius: 10px;
        padding: 10px 16px;
        border: 1px solid transparent;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .btn-primary {
        background: var(--gradient-primary);
        color: #fff;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
      }

      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(139, 92, 246, 0.4);
      }

      .btn-ghost {
        background: rgba(255, 255, 255, 0.6);
        border-color: var(--border);
        color: var(--text-secondary);
      }

      .btn-ghost:hover {
        background: rgba(255, 255, 255, 0.9);
        border-color: var(--border-hover);
        color: var(--text-primary);
      }

      .auto-refresh {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: var(--text-secondary);
      }

      .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--success);
        box-shadow: 0 0 12px rgba(16, 185, 129, 0.7);
      }

      /* å¼€å…³æ ·å¼ */
      .toggle-switch {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 13px;
        color: var(--text-secondary);
      }

      .toggle-switch input[type='checkbox'] {
        appearance: none;
        width: 44px;
        height: 24px;
        background: rgba(148, 163, 184, 0.2);
        border: 1px solid var(--border);
        border-radius: 12px;
        position: relative;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .toggle-switch input[type='checkbox']::before {
        content: '';
        position: absolute;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--text-muted);
        top: 2px;
        left: 2px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .toggle-switch input[type='checkbox']:checked {
        background: var(--success);
        border-color: var(--success);
      }

      .toggle-switch input[type='checkbox']:checked::before {
        background: white;
        left: 22px;
      }

      .toggle-switch input[type='checkbox']:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .toggle-switch .status-text {
        min-width: 40px;
        font-weight: 500;
      }

      .toggle-switch .status-text.enabled {
        color: var(--success);
      }

      .toggle-switch .status-text.disabled {
        color: var(--danger);
      }

      .last-update {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--text-secondary);
        font-size: 13px;
      }

      .section {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 24px;
      }

      .page-footnote {
        margin-top: 12px;
        text-align: right;
        color: var(--text-muted);
        font-size: 12px;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 12px;
      }

      .btn-ghost.danger-link {
        border-color: transparent;
        color: var(--text-muted);
        padding: 6px 10px;
        font-size: 12px;
      }

      .btn-ghost.danger-link:hover {
        color: var(--danger);
        border-color: rgba(239, 68, 68, 0.3);
      }

      .health-panel {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(147, 51, 234, 0.08) 100%);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 24px 32px;
        position: relative;
        overflow: hidden;
      }

      .health-panel::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 300px;
        height: 300px;
        background: radial-gradient(circle, rgba(59, 130, 246, 0.15) 0%, transparent 70%);
        pointer-events: none;
      }

      .health-panel::after {
        content: '';
        position: absolute;
        bottom: -30%;
        left: -10%;
        width: 200px;
        height: 200px;
        background: radial-gradient(circle, rgba(147, 51, 234, 0.1) 0%, transparent 70%);
        pointer-events: none;
      }

      .health-panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        position: relative;
        z-index: 1;
      }

      .health-panel-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .health-panel-title::before {
        content: 'âš¡';
        font-size: 18px;
      }

      .health-panel-badge {
        font-size: 11px;
        padding: 4px 10px;
        border-radius: 12px;
        background: rgba(34, 197, 94, 0.15);
        color: var(--success);
        font-weight: 500;
      }

      .health-panel-badge.warning {
        background: rgba(245, 158, 11, 0.15);
        color: var(--warning);
      }

      .health-panel-badge.error {
        background: rgba(239, 68, 68, 0.15);
        color: var(--danger);
      }

      .health-grid {
        display: grid;
        gap: 20px;
        grid-template-columns: repeat(3, 1fr);
        position: relative;
        z-index: 1;
      }

      .health-item {
        display: flex;
        gap: 12px;
        align-items: center;
        padding: 16px;
        background: rgba(255, 255, 255, 0.5);
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.15);
        transition: all 0.2s ease;
      }

      .health-item:hover {
        background: rgba(255, 255, 255, 0.8);
        border-color: rgba(148, 163, 184, 0.25);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(148, 163, 184, 0.15);
      }

      .health-item[data-state='error'] {
        border-color: rgba(239, 68, 68, 0.3);
        background: rgba(239, 68, 68, 0.06);
      }

      .health-item[data-state='warning'] {
        border-color: rgba(245, 158, 11, 0.3);
        background: rgba(245, 158, 11, 0.06);
      }

      .health-icon {
        font-size: 28px;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(139, 92, 246, 0.1);
        border-radius: 12px;
      }

      .health-info {
        flex: 1;
      }

      .health-title {
        font-size: 12px;
        color: var(--text-muted);
        letter-spacing: 0.05em;
        margin-bottom: 4px;
      }

      .health-status {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 2px;
      }

      .health-desc {
        color: var(--text-secondary);
        font-size: 12px;
      }

      .metric-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 16px;
      }

      .metric-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 6px;
        position: relative;
        overflow: hidden;
      }

      .metric-card::after {
        content: '';
        position: absolute;
        inset: 0;
        opacity: 0.6;
        pointer-events: none;
        border-radius: inherit;
      }

      .metric-card.primary::after {
        background: radial-gradient(circle at top right, rgba(59, 130, 246, 0.15), transparent 70%);
      }

      /* ç»Ÿä¸€æ¯›ç»ç’ƒå¡ç‰‡æ ·å¼ */
      .metric-card, .chart-card, .insight-card, .health-panel, .control-panel, .section, .sidebar {
        background: var(--bg-card);
        backdrop-filter: blur(var(--glass-blur));
        -webkit-backdrop-filter: blur(var(--glass-blur));
        border: 1px solid var(--border);
        box-shadow: var(--glass-shadow);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .metric-card:hover, .chart-card:hover, .insight-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--glass-shadow-hover);
        border-color: var(--border-hover);
        background: var(--bg-card-hover);
      }

      .metric-value {
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: 700;
        letter-spacing: -0.02em;
      }

      .metric-card.success::after {
        background: radial-gradient(circle at top right, rgba(16, 185, 129, 0.15), transparent 70%);
      }

      .metric-card.warning::after {
        background: radial-gradient(circle at top right, rgba(245, 158, 11, 0.15), transparent 70%);
      }

      .metric-card.danger::after {
        background: radial-gradient(circle at top right, rgba(239, 68, 68, 0.15), transparent 70%);
      }

      .metric-card.info::after {
        background: radial-gradient(circle at top right, rgba(6, 182, 212, 0.15), transparent 70%);
      }

      .metric-label {
        font-size: 13px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .metric-subtitle {
        font-size: 13px;
        color: var(--text-secondary);
      }

      .metric-delta {
        font-size: 13px;
        font-weight: 600;
      }

      .metric-delta.positive {
        color: var(--success);
      }

      .metric-delta.negative {
        color: var(--danger);
      }

      .charts-row {
        display: grid;
        gap: 20px;
        grid-template-columns: 2fr 1fr;
      }

      .chart-card {
        border-radius: 20px;
        border: 1px solid var(--border);
        padding: 24px;
        background: var(--bg-card);
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
      }

      .chart-header h3 {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .chart-header p {
        margin: 2px 0 0;
        color: var(--text-secondary);
        font-size: 13px;
      }

      .chart-kpi {
        text-align: right;
        font-size: 12px;
        color: var(--text-muted);
      }

      .chart-kpi strong {
        display: block;
        font-size: 18px;
        color: var(--text-primary);
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }

      ::-webkit-scrollbar-track {
        background: transparent;
      }

      ::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.3);
        border-radius: 3px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: rgba(148, 163, 184, 0.5);
      }

      canvas {
        width: 100% !important;
        height: 280px !important;
        filter: drop-shadow(0 4px 8px rgba(148, 163, 184, 0.15));
      }

      .chart-container {
        position: relative;
        width: 100%;
        height: 280px;
      }

      .insight-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
      }

      .insight-card {
        border-radius: 18px;
        padding: 24px;
        min-height: 140px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        position: relative;
        overflow: hidden;
      }
      
      .insight-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(45deg, transparent, rgba(139, 92, 246, 0.08), transparent);
        transform: translateX(-100%);
        transition: transform 0.6s;
      }

      .insight-card:hover::before {
        transform: translateX(100%);
      }

      .insight-title {
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        margin-bottom: 12px;
      }

      .insight-metrics {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
      }

      .insight-metrics div span {
        font-size: 12px;
        color: var(--text-secondary);
      }

      .insight-metrics div strong {
        display: block;
        font-size: 20px;
      }

      .percentiles {
        display: grid;
        grid-template-columns: repeat(2, minmax(100px, 1fr));
        gap: 12px;
      }

      .percentiles span {
        font-size: 12px;
        color: var(--text-secondary);
      }

      .percentiles strong {
        display: block;
        font-size: 18px;
      }

      .alert-type-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .alert-type-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        border-bottom: 1px solid var(--border);
      }

      .alert-type-item:last-child {
        border-bottom: none;
      }

      .alert-type-label {
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 100px;
        font-size: 13px;
      }

      .alert-type-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        border-radius: 6px;
        font-size: 11px;
      }

      .alert-type-badge.agent {
        background: rgba(239, 68, 68, 0.2);
        color: var(--danger);
      }

      .alert-type-badge.message {
        background: rgba(245, 158, 11, 0.2);
        color: var(--warning);
      }

      .alert-type-badge.delivery {
        background: rgba(59, 130, 246, 0.2);
        color: var(--primary);
      }

      .alert-type-badge.merge {
        background: rgba(168, 85, 247, 0.2);
        color: #a855f7;
      }

      .alert-type-badge.unknown {
        background: rgba(156, 163, 175, 0.2);
        color: var(--text-muted);
      }

      .alert-type-bar {
        flex: 1;
        height: 6px;
        background: rgba(148, 163, 184, 0.15);
        border-radius: 3px;
        overflow: hidden;
        position: relative;
      }

      .alert-type-bar-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.3s ease;
      }

      .alert-type-bar-fill.agent {
        background: var(--danger);
      }

      .alert-type-bar-fill.message {
        background: var(--warning);
      }

      .alert-type-bar-fill.delivery {
        background: var(--primary);
      }

      .alert-type-bar-fill.merge {
        background: #a855f7;
      }

      .alert-type-bar-fill.unknown {
        background: var(--text-muted);
      }

      .alert-type-stats {
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 80px;
        justify-content: flex-end;
        font-size: 12px;
      }

      .alert-type-count {
        font-weight: 600;
        color: var(--text-primary);
      }

      .alert-type-percentage {
        color: var(--text-secondary);
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }

      .section-header h3 {
        margin: 0;
        font-size: 16px;
      }

      .table-wrapper {
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      thead th {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--text-muted);
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
        text-align: left;
      }

      tbody td {
        padding: 12px;
        border-bottom: 1px solid var(--border);
        font-size: 13px;
        color: var(--text-secondary);
      }

      tbody tr:hover {
        background: rgba(139, 92, 246, 0.04);
      }

      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border-radius: 999px;
        padding: 2px 10px;
        font-size: 12px;
        border: 1px solid transparent;
      }

      .status-badge.success {
        border-color: rgba(16, 185, 129, 0.4);
        color: var(--success);
      }

      .status-badge.warning {
        border-color: rgba(245, 158, 11, 0.4);
        color: var(--warning);
      }

      .status-badge.danger {
        border-color: rgba(239, 68, 68, 0.4);
        color: var(--danger);
      }

      .loading {
        padding: 24px;
        text-align: center;
        color: var(--text-secondary);
      }

      /* åŠ è½½åŠ¨ç”» */
      @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
      }

      .skeleton {
        background: linear-gradient(90deg,
          rgba(148, 163, 184, 0.1) 25%,
          rgba(148, 163, 184, 0.2) 50%,
          rgba(148, 163, 184, 0.1) 75%
        );
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: 4px;
      }

      /* é€‰ä¸­çŠ¶æ€ */
      ::selection {
        background: rgba(139, 92, 246, 0.3);
        color: var(--text-primary);
      }

      @media (max-width: 1200px) {
        .metric-grid {
          grid-template-columns: repeat(3, 1fr);
        }
        .insight-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 960px) {
        .charts-row {
          grid-template-columns: 1fr;
        }
        .health-grid {
          grid-template-columns: 1fr;
        }
        .metric-grid {
          grid-template-columns: repeat(2, 1fr);
        }
        .insight-grid {
          grid-template-columns: 1fr;
        }
      }

      /* App Layout & Sidebar */

      .app-layout {
        display: flex;
        min-height: 100vh;
      }

      .sidebar {
        width: 260px;
        background: var(--gradient-sidebar);
        border-right: none;
        display: flex;
        flex-direction: column;
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        z-index: 50;
        padding: 24px;
        box-shadow: 4px 0 32px rgba(139, 92, 246, 0.2);
      }

      .content {
        flex: 1;
        margin-left: 260px;
        padding: 40px 40px 80px;
        min-width: 0;
      }

      .sidebar-header {
        margin-bottom: 40px;
        padding: 0 12px;
      }

      .sidebar-logo {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-on-gradient);
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .nav-menu {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .nav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        border-radius: 12px;
        color: var(--text-on-gradient-muted);
        text-decoration: none;
        transition: all 0.2s ease;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
      }

      .nav-item:hover {
        background: rgba(255, 255, 255, 0.15);
        color: var(--text-on-gradient);
      }

      .nav-item.active {
        background: rgba(255, 255, 255, 0.95);
        color: var(--primary-dark);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .page-section {
        display: none;
        flex-direction: column;
        gap: 24px;
        animation: fadeIn 0.3s ease;
      }

      .page-section.active {
        display: flex;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }

      /* Adjust container to fit in content area */
      .container {
        margin: 0;
        max-width: 1200px;
      }

      /* Pagination styles */
      .pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border);
      }

      .pagination-info {
        font-size: 13px;
        color: var(--text-secondary);
      }

      .pagination-controls {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .pagination-btn {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text-secondary);
        border-radius: 8px;
        padding: 6px 12px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .pagination-btn:hover:not(:disabled) {
        border-color: var(--primary);
        color: var(--text-primary);
      }

      .pagination-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }

      .pagination-pages {
        display: flex;
        gap: 4px;
      }

      .pagination-page {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text-secondary);
        border-radius: 6px;
        padding: 6px 10px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 32px;
        text-align: center;
      }

      .pagination-page:hover {
        border-color: var(--primary);
        color: var(--text-primary);
      }

      .pagination-page.active {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
      }

      .page-size-select {
        background: var(--bg-card);
        border: 1px solid var(--border);
        color: var(--text-secondary);
        border-radius: 8px;
        padding: 6px 8px;
        font-size: 13px;
        cursor: pointer;
      }

      .page-size-select:focus {
        outline: none;
        border-color: var(--primary);
      }
      .nav-icon {
        width: 24px;
        height: 24px;
        object-fit: contain;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="background-gradients">
      <span class="bg-blue"></span>
      <span class="bg-purple"></span>
    </div>
    <div class="app-layout">
      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-logo">
            <span>ğŸš€</span> ç‹¬ç«‹æ—¥ Bot
          </div>
        </div>
        <nav class="nav-menu">
          <div class="nav-item active" onclick="switchPage('dashboard')" id="nav-dashboard">
            <img src="icons/dashboard.png" class="nav-icon" alt="Dashboard"> ä»ªè¡¨ç›˜
          </div>
          <div class="nav-item" onclick="switchPage('users')" id="nav-users">
            <img src="icons/users.png" class="nav-icon" alt="Users"> ç”¨æˆ·ç®¡ç†
          </div>
          <div class="nav-item" onclick="switchPage('system')" id="nav-system">
            <img src="icons/system.png" class="nav-icon" alt="System"> ç³»ç»Ÿç›‘æ§
          </div>
          <div class="nav-item" onclick="switchPage('logs')" id="nav-logs">
            <img src="icons/logs.png" class="nav-icon" alt="Logs"> æ¶ˆæ¯æ—¥å¿—
          </div>
        </nav>
      </aside>
      <main class="content">
        <div class="container">
          <!-- Page: Dashboard (ä»ªè¡¨ç›˜) -->
          <div id="page-dashboard" class="page-section active">
            <!-- ç»Ÿä¸€æ§åˆ¶é¢æ¿ - åˆå¹¶ç­›é€‰å’Œå¥åº·çŠ¶æ€ -->
            <section class="control-panel">
              <!-- è£…é¥°æ€§å…‰ç‚¹ -->
              <span class="decorative-dot"></span>
              <span class="decorative-dot"></span>
              <div class="control-panel-header">
                <div class="control-panel-left">
                  <div class="control-panel-title">ç³»ç»Ÿæ§åˆ¶</div>
                  <div class="filters">
                    <button class="active" data-range="today">æœ¬æ—¥</button>
                    <button data-range="week">æœ¬å‘¨</button>
                    <button data-range="month">æœ¬æœˆ</button>
                  </div>
                  <label class="toggle-switch">
                    <span>ğŸ¤– æ™ºèƒ½å›å¤</span>
                    <input type="checkbox" id="aiReplyToggle" />
                    <span class="status-text" id="aiReplyStatus">-</span>
                  </label>
                </div>
                <div class="control-panel-right">
                  <span class="health-panel-badge" id="overallHealthBadge">æ£€æŸ¥ä¸­...</span>
                  <label class="auto-refresh">
                    <input type="checkbox" id="autoRefresh" checked />
                    è‡ªåŠ¨åˆ·æ–°
                  </label>
                  <div class="last-update">
                    <span class="status-indicator"></span>
                    <span id="lastUpdate">-</span>
                  </div>
                </div>
              </div>
              <div class="health-grid">
                <article class="health-item" id="overallHealthCard" data-state="loading">
                  <div class="health-icon">ğŸ›°ï¸</div>
                  <div class="health-info">
                    <div class="health-title">æ•´ä½“çŠ¶æ€</div>
                    <div class="health-status" id="overallHealthStatus">-</div>
                    <div class="health-desc" id="overallHealthMessage">æ£€æŸ¥ä¸­...</div>
                  </div>
                </article>
                <article class="health-item" id="modelHealthCard" data-state="loading">
                  <div class="health-icon">ğŸ¤–</div>
                  <div class="health-info">
                    <div class="health-title">AI æ¨¡å‹</div>
                    <div class="health-status" id="modelHealthStatus">-</div>
                    <div class="health-desc" id="modelHealthDetails">æ£€æŸ¥ä¸­...</div>
                  </div>
                </article>
                <article class="health-item" id="toolHealthCard" data-state="loading">
                  <div class="health-icon">ğŸ§°</div>
                  <div class="health-info">
                    <div class="health-title">å·¥å…·æœåŠ¡</div>
                    <div class="health-status" id="toolHealthStatus">-</div>
                    <div class="health-desc" id="toolHealthDetails">æ£€æŸ¥ä¸­...</div>
                  </div>
                </article>
              </div>
            </section>

            <!-- æ ¸å¿ƒæŒ‡æ ‡ -->
            <section class="metric-grid">
              <article class="metric-card primary">
                <div class="metric-label">
                  æ¶ˆæ¯æ€»é‡
                  <span class="time-range-badge" id="timeRangeBadge" style="font-size: 11px; opacity: 0.7;"></span>
                </div>
                <div class="metric-value" id="totalMessages">-</div>
                <div class="metric-subtitle">æˆåŠŸ + å¤±è´¥</div>
                <div class="metric-delta" id="totalMessagesDelta">-</div>
              </article>
              <article class="metric-card success">
                <div class="metric-label">æˆåŠŸç‡</div>
                <div class="metric-value" id="successRate">-</div>
                <div class="metric-subtitle" id="successCount">-</div>
                <div class="metric-delta" id="successRateDelta">-</div>
              </article>
              <article class="metric-card">
                <div class="metric-label">å¹³å‡å“åº”</div>
                <div class="metric-value" id="avgDuration">-</div>
                <div class="metric-subtitle">ç§’</div>
                <div class="metric-delta" id="avgDurationDelta">-</div>
              </article>
              <article class="metric-card">
                <div class="metric-label">æ´»è·ƒç”¨æˆ·</div>
                <div class="metric-value" id="activeUsers">-</div>
                <div class="metric-subtitle" id="activeChats">-</div>
                <div class="metric-delta" id="activeUsersDelta">-</div>
              </article>
              <article class="metric-card" style="border: 1px solid rgba(245, 158, 11, 0.3);">
                <div class="metric-label">é™çº§æ¬¡æ•°</div>
                <div class="metric-value" id="fallbackCount">-</div>
                <div class="metric-subtitle" id="fallbackRate">-</div>
                <div class="metric-delta" id="fallbackDelta">-</div>
              </article>
            </section>

            <!-- ä¸šåŠ¡æŒ‡æ ‡å¡ç‰‡ -->
            <section class="metric-grid" style="grid-template-columns: repeat(3, 1fr);">
              <article class="metric-card" style="border: 1px solid rgba(99, 102, 241, 0.3);">
                <div class="metric-label">
                  æ€»å’¨è¯¢äººæ•°
                  <span class="time-range-badge" id="businessTimeRangeBadge" style="font-size: 11px; opacity: 0.7;"></span>
                </div>
                <div class="metric-value" id="businessConsultationsTotal">-</div>
                <div class="metric-subtitle">
                  æ–°å¢ <span id="businessConsultationsNew">-</span> äºº
                </div>
                <div class="metric-delta" id="businessConsultationsDelta">-</div>
              </article>

              <article class="metric-card" style="border: 1px solid rgba(168, 85, 247, 0.3);">
                <div class="metric-label">é¢„çº¦é¢è¯•æ¬¡æ•°</div>
                <div class="metric-value" id="businessBookingAttempts">-</div>
                <div class="metric-subtitle">
                  æˆåŠŸ <span id="businessBookingSuccessful" style="color: var(--success);">-</span> /
                  å¤±è´¥ <span id="businessBookingFailed" style="color: var(--danger);">-</span>
                </div>
                <div class="metric-delta" id="businessBookingAttemptsDelta">-</div>
              </article>

              <article class="metric-card success" style="border: 1px solid rgba(16, 185, 129, 0.3);">
                <div class="metric-label">é¢„çº¦æˆåŠŸç‡</div>
                <div class="metric-value" id="businessBookingSuccessRate">-</div>
                <div class="metric-subtitle">
                  å’¨è¯¢è½¬åŒ–ç‡ <span id="businessConversionRate">-</span>
                </div>
                <div class="metric-delta" id="businessBookingSuccessRateDelta">-</div>
              </article>
            </section>

            <!-- è¶‹åŠ¿å›¾è¡¨ -->
            <section class="charts-row">
              <div class="chart-card">
                <div class="chart-header">
                  <div>
                    <h3>å’¨è¯¢äººæ•°è¶‹åŠ¿</h3>
                    <p>æ´»è·ƒç”¨æˆ·æ•°é‡å˜åŒ–</p>
                  </div>
                </div>
                <div class="chart-container">
                  <canvas id="consultationsTrendChart"></canvas>
                </div>
              </div>
              <div class="chart-card">
                <div class="chart-header">
                  <div>
                    <h3>é¢„çº¦è½¬åŒ–è¶‹åŠ¿</h3>
                    <p>é¢„çº¦æ¬¡æ•°ä¸æˆåŠŸç‡</p>
                  </div>
                </div>
                <div class="chart-container">
                  <canvas id="bookingTrendChart"></canvas>
                </div>
              </div>
            </section>

          </div>

          <!-- Page: System (ç³»ç»Ÿç›‘æ§) -->
          <div id="page-system" class="page-section">
            <!-- è¿ç»´æ´å¯Ÿ -->
            <section class="insight-grid">
              <article class="insight-card">
                <div class="insight-title">æ’é˜Ÿä¸å“åº”</div>
                <div class="insight-metrics">
                  <div>
                    <span>å®æ—¶å¤„ç†ä¸­</span>
                    <strong id="queueCurrent">-</strong>
                  </div>
                  <div>
                    <span>å³°å€¼é˜Ÿåˆ—</span>
                    <strong id="queuePeak">-</strong>
                  </div>
                  <div>
                    <span>å¹³å‡ç­‰å¾…</span>
                    <strong id="queueAvgWait">-</strong>
                  </div>
                </div>
              </article>
              <article class="insight-card">
                <div class="insight-title">å»¶è¿Ÿåˆ†å¸ƒ</div>
                <div class="percentiles">
                  <div>
                    <span>P50</span>
                    <strong id="p50Duration">-</strong>
                  </div>
                  <div>
                    <span>P95</span>
                    <strong id="p95Duration">-</strong>
                  </div>
                  <div>
                    <span>P99</span>
                    <strong id="p99Duration">-</strong>
                  </div>
                </div>
              </article>
              <article class="insight-card">
                <div class="insight-title">å‘Šè­¦æ¦‚è§ˆ</div>
                <div class="insight-metrics">
                  <div>
                    <span>ç´¯è®¡</span>
                    <strong id="alertTotal">-</strong>
                  </div>
                  <div>
                    <span>è¿‘24å°æ—¶</span>
                    <strong id="alertRecent">-</strong>
                  </div>
                </div>
              </article>
              <article class="insight-card">
                <div class="insight-title">å‘Šè­¦ç±»å‹åˆ†å¸ƒ</div>
                <div id="alertTypeList" class="alert-type-list">
                  <div class="loading" style="padding: 12px 0; font-size: 13px;">æš‚æ— æ•°æ®</div>
                </div>
              </article>
            </section>

            <!-- æ¯æ—¥è¶‹åŠ¿ -->
            <section class="charts-row">
              <div class="chart-card">
                <div class="chart-header">
                  <div>
                    <h3>æ¯æ—¥ Token æ¶ˆè€—</h3>
                    <p>æœ€è¿‘ 7 å¤©ä½¿ç”¨é‡</p>
                  </div>
                  <div class="chart-kpi">
                    <span>ä»Šæ—¥æ¶ˆè€—</span>
                    <strong id="dailyTokenUsage">-</strong>
                  </div>
                </div>
                <canvas id="dailyTokenChart"></canvas>
              </div>
              <div class="chart-card">
                <div class="chart-header">
                  <div>
                    <h3>æ¯æ—¥å’¨è¯¢äººæ•°</h3>
                    <p>æœ€è¿‘ 7 å¤©å”¯ä¸€ç”¨æˆ·</p>
                  </div>
                  <div class="chart-kpi">
                    <span>ä»Šæ—¥äººæ•°</span>
                    <strong id="dailyUserCount">-</strong>
                  </div>
                </div>
                <canvas id="dailyUserChart"></canvas>
              </div>
            </section>

            <!-- å®æ—¶æ€§èƒ½ -->
            <section class="charts-row">
              <div class="chart-card">
                <div class="chart-header">
                  <div>
                    <h3>å“åº”è€—æ—¶</h3>
                    <p>æœ€è¿‘ <span id="chartRangeLabel">60</span> åˆ†é’Ÿ</p>
                  </div>
                  <div class="chart-kpi">
                    <span>å½“å‰å¹³å‡</span>
                    <strong id="responseChartAvg">-</strong>
                  </div>
                </div>
                <canvas id="responseTrendChart"></canvas>
              </div>
              <div class="chart-card">
                <div class="chart-header">
                  <div>
                    <h3>å‘Šè­¦è¶‹åŠ¿</h3>
                    <p>æœ€è¿‘ 60 åˆ†é’Ÿ</p>
                  </div>
                  <div class="chart-kpi">
                    <span>è¿‘5åˆ†é’Ÿ</span>
                    <strong id="alertTrendRecent">-</strong>
                  </div>
                </div>
                <canvas id="alertTrendChart"></canvas>
              </div>
            </section>

            <!-- æœ€æ…¢è®°å½• -->
            <section class="section">
              <div class="section-header">
                <h3>æœ€æ…¢è®°å½• (Top 10)</h3>
              </div>
              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>æ—¶é—´</th>
                      <th>ç”¨æˆ·</th>
                      <th>æ¶ˆæ¯é¢„è§ˆ</th>
                      <th>æ€»è€—æ—¶</th>
                      <th>AI è€—æ—¶</th>
                      <th>å›å¤æ¡æ•°</th>
                      <th>çŠ¶æ€</th>
                    </tr>
                  </thead>
                  <tbody id="slowestRecords">
                    <tr>
                      <td colspan="7" class="loading">åŠ è½½ä¸­</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </section>
          </div>

          <!-- Page: Users (ç”¨æˆ·ç®¡ç†) -->
          <div id="page-users" class="page-section">
            <!-- ç”¨æˆ·åˆ—è¡¨ -->
            <section class="section">
              <div class="section-header">
                <h3>ä»Šæ—¥å’¨è¯¢ç”¨æˆ· <span id="todayUserCount" style="font-size: 14px; color: var(--text-secondary); font-weight: normal;">(0 äºº)</span></h3>
              </div>
              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>ç”¨æˆ·</th>
                      <th>ä¼šè¯</th>
                      <th>æ¶ˆæ¯æ•°</th>
                      <th>Token æ¶ˆè€—</th>
                      <th>é¦–æ¬¡æ´»è·ƒ</th>
                      <th>æœ€åæ´»è·ƒ</th>
                      <th>æ‰˜ç®¡çŠ¶æ€</th>
                    </tr>
                  </thead>
                  <tbody id="todayUsersList">
                    <tr>
                      <td colspan="7" class="loading">åŠ è½½ä¸­</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </section>
          </div>

          <!-- Page: Logs (æ¶ˆæ¯æ—¥å¿—) -->
          <div id="page-logs" class="page-section">
            <!-- å®æ—¶æ¶ˆæ¯ -->
            <section class="section">
              <div class="section-header">
                <h3>å®æ—¶æ¶ˆæ¯ <span id="recentMessagesTotal" style="font-size: 14px; color: var(--text-secondary); font-weight: normal;">(0 æ¡)</span></h3>
              </div>
              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>æ—¶é—´</th>
                      <th>ç”¨æˆ·</th>
                      <th>ç”¨æˆ·æ¶ˆæ¯</th>
                      <th>å›å¤é¢„è§ˆ</th>
                      <th>æ€»è€—æ—¶</th>
                      <th>çŠ¶æ€</th>
                    </tr>
                  </thead>
                  <tbody id="recentMessages">
                    <tr>
                      <td colspan="6" class="loading">åŠ è½½ä¸­</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <!-- åˆ†é¡µæ§ä»¶ -->
              <div class="pagination" id="recentMessagesPagination">
                <div class="pagination-info">
                  æ˜¾ç¤º <span id="paginationStart">0</span>-<span id="paginationEnd">0</span> æ¡ï¼Œå…± <span id="paginationTotal">0</span> æ¡
                </div>
                <div class="pagination-controls">
                  <select class="page-size-select" id="pageSizeSelect" onchange="changePageSize()">
                    <option value="10" selected>10 æ¡/é¡µ</option>
                    <option value="20">20 æ¡/é¡µ</option>
                    <option value="50">50 æ¡/é¡µ</option>
                    <option value="100">100 æ¡/é¡µ</option>
                  </select>
                  <button class="pagination-btn" onclick="goToPage(1)" id="paginationFirst">é¦–é¡µ</button>
                  <button class="pagination-btn" onclick="goToPage(currentPage - 1)" id="paginationPrev">ä¸Šä¸€é¡µ</button>
                  <div class="pagination-pages" id="paginationPages"></div>
                  <button class="pagination-btn" onclick="goToPage(currentPage + 1)" id="paginationNext">ä¸‹ä¸€é¡µ</button>
                  <button class="pagination-btn" onclick="goToPage(totalPages)" id="paginationLast">æœ«é¡µ</button>
                </div>
              </div>
            </section>
          </div>

          <div class="page-footnote">
            <button class="btn btn-ghost danger-link" type="button" onclick="clearData()">æ¸…ç©ºç›‘æ§æ•°æ®</button>
            <span>ä»…åœ¨éœ€è¦é‡ç½®ç»Ÿè®¡æ—¶ä½¿ç”¨</span>
          </div>
        </div>
      </main>
    </div>

    <script>
      let autoRefreshInterval = null;
      let responseTrendChart = null;
      let alertTrendChart = null;
      let consultationsTrendChart = null;
      let bookingTrendChart = null;
      let dailyTokenChart = null;
      let dailyUserChart = null;
      let cachedDashboard = null;
      let cachedMetrics = null;
      let currentTimeRange = 'today';
      let pausedUsersCache = new Set();

      // åˆ†é¡µç›¸å…³å˜é‡
      let allRecentMessages = [];
      let currentPage = 1;
      let pageSize = 10;
      let totalPages = 1;

      function switchPage(pageId) {
        // Update Menu
        document.querySelectorAll('.nav-item').forEach(el => {
          el.classList.remove('active');
        });
        const navItem = document.getElementById(`nav-${pageId}`);
        if (navItem) navItem.classList.add('active');

        // Update Page
        document.querySelectorAll('.page-section').forEach(el => {
          el.classList.remove('active');
        });
        const pageSection = document.getElementById(`page-${pageId}`);
        if (pageSection) pageSection.classList.add('active');

        // Trigger chart resize
        setTimeout(() => {
          window.dispatchEvent(new Event('resize'));
        }, 50);
      }

      const unwrapResponse = (payload) => {
        let current = payload;
        while (current && typeof current === 'object' && 'data' in current) {
          current = current.data;
        }
        return current;
      };

      document.addEventListener('DOMContentLoaded', () => {
        initCharts();
        setupAutoRefreshToggle();
        setupAiReplyToggle();
        setupTimeRangeFilters();
        refreshAll();
        loadAiReplyStatus();

        // é»˜è®¤æ˜¾ç¤ºä»ªè¡¨ç›˜é¡µé¢
        switchPage('dashboard');
      });

      async function refreshAll() {
        await Promise.all([refreshHealthStatus(), refreshDashboard()]);
      }

      function setupAutoRefreshToggle() {
        const checkbox = document.getElementById('autoRefresh');
        checkbox.addEventListener('change', toggleAutoRefresh);
        toggleAutoRefresh();
      }

      function toggleAutoRefresh() {
        const checkbox = document.getElementById('autoRefresh');
        if (checkbox.checked) {
          if (autoRefreshInterval) clearInterval(autoRefreshInterval);
          autoRefreshInterval = setInterval(refreshDashboard, 5000);
        } else if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
        }
      }

      function setupAiReplyToggle() {
        const checkbox = document.getElementById('aiReplyToggle');
        checkbox.addEventListener('change', handleAiReplyToggle);
      }

      async function loadAiReplyStatus() {
        try {
          const response = await fetch('/monitoring/ai-reply-status');
          const result = await response.json();
          const payload = unwrapResponse(result);
          updateAiReplyUI(payload?.enabled ?? false);
        } catch (error) {
          console.error('è·å– AI å›å¤çŠ¶æ€å¤±è´¥', error);
        }
      }

      async function handleAiReplyToggle() {
        const checkbox = document.getElementById('aiReplyToggle');
        const enabled = checkbox.checked;

        try {
          checkbox.disabled = true;
          const response = await fetch('/monitoring/toggle-ai-reply', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ enabled }),
          });

          const result = await response.json();
          const responseData = unwrapResponse(result);
          updateAiReplyUI(responseData?.enabled ?? enabled);

          // æ˜¾ç¤ºé€šçŸ¥
          console.log(responseData?.message || 'çŠ¶æ€å·²æ›´æ–°');
        } catch (error) {
          console.error('åˆ‡æ¢ AI å›å¤çŠ¶æ€å¤±è´¥', error);
          // æ¢å¤åŸæ¥çš„çŠ¶æ€
          checkbox.checked = !enabled;
        } finally {
          checkbox.disabled = false;
        }
      }

      function updateAiReplyUI(enabled) {
        const checkbox = document.getElementById('aiReplyToggle');
        const statusText = document.getElementById('aiReplyStatus');

        checkbox.checked = enabled;
        statusText.textContent = enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨';
        statusText.className = enabled ? 'status-text enabled' : 'status-text disabled';
      }

      function setupTimeRangeFilters() {
        const filterButtons = document.querySelectorAll('.filters button[data-range]');
        filterButtons.forEach(button => {
          button.addEventListener('click', () => {
            filterButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            currentTimeRange = button.dataset.range;
            refreshDashboard();
          });
        });
      }

      async function refreshDashboard() {
        try {
          const [dashboardRes, metricsRes] = await Promise.all([
            fetch(`/monitoring/dashboard?range=${currentTimeRange}`),
            fetch('/monitoring/metrics'),
          ]);
          const dashboardPayload = await dashboardRes.json();
          const metricsPayload = await metricsRes.json();
          const dashboard = unwrapResponse(dashboardPayload);
          const metrics = unwrapResponse(metricsPayload);
          cachedDashboard = dashboard;
          cachedMetrics = metrics;
          renderDashboard(dashboard, metrics);
          document.getElementById('lastUpdate').textContent = formatTime(Date.now());
        } catch (error) {
          console.error('åŠ è½½ç›‘æ§æ•°æ®å¤±è´¥', error);
        }
      }

      function renderDashboard(dashboard, metrics) {
        updateTimeRangeBadge(dashboard.timeRange);
        updateOverview(dashboard);
        updateFallbackStats(dashboard.fallback, dashboard.fallbackDelta);
        updateBusinessMetrics(dashboard.business, dashboard.businessDelta);
        updateQueueInfo(dashboard);
        updatePercentiles(metrics.percentiles);
        updateSlowestTable(metrics.slowestRecords);
        updateRecentMessages(dashboard.recentMessages);
        updateCharts(dashboard);
        updateDailyCharts(dashboard.dailyTrend);
        updateTodayUsersList(dashboard.todayUsers);
      }

      function updateOverview(data) {
        const { overview, overviewDelta } = data;
        setMetric('totalMessages', overview.totalMessages);
        setMetric('successRate', `${overview.successRate.toFixed(1)}%`);
        setMetric('avgDuration', formatDuration(overview.avgDuration));
        setMetric('activeUsers', overview.activeUsers);
        document.getElementById('successCount').textContent = `æˆåŠŸ ${overview.successCount} æ¡`;
        document.getElementById('activeChats').textContent = `${overview.activeChats} ä¸ªä¼šè¯`;
        setDelta('totalMessagesDelta', overviewDelta.totalMessages);
        setDelta('successRateDelta', overviewDelta.successRate);
        setDelta('avgDurationDelta', overviewDelta.avgDuration);
        setDelta('activeUsersDelta', overviewDelta.activeUsers);
      }

      function setMetric(id, value) {
        const el = document.getElementById(id);
        if (el) {
          el.textContent = value ?? '-';
        }
      }

      function setDelta(id, delta) {
        const el = document.getElementById(id);
        if (!el || delta === undefined || delta === null) {
          return;
        }
        const val = parseFloat(delta.toFixed(1));
        el.textContent = `${val >= 0 ? '+' : ''}${val}%`;
        el.classList.toggle('positive', val >= 0);
        el.classList.toggle('negative', val < 0);
      }

      function updateQueueInfo(data) {
        const queue = data.queue || {};
        document.getElementById('queueCurrent').textContent = queue.currentProcessing ?? '-';
        document.getElementById('queuePeak').textContent = queue.peakProcessing ?? '-';
        document.getElementById('queueAvgWait').textContent = queue.avgQueueDuration
          ? formatDuration(queue.avgQueueDuration)
          : '-';
        const alerts = data.alertsSummary || { total: 0, last24Hours: 0, byType: [] };
        document.getElementById('alertTotal').textContent = alerts.total;
        document.getElementById('alertRecent').textContent = alerts.last24Hours;
        updateAlertTypeList(alerts.byType || []);
      }

      function updateAlertTypeList(alertTypes) {
        const container = document.getElementById('alertTypeList');
        if (!alertTypes || alertTypes.length === 0) {
          container.innerHTML = '<div class="loading" style="padding: 12px 0; font-size: 13px;">æš‚æ— æ•°æ®</div>';
          return;
        }

        const typeLabels = {
          agent: 'AI ä»£ç†',
          message: 'æ¶ˆæ¯å¤„ç†',
          delivery: 'æ¶ˆæ¯å‘é€',
          merge: 'æ¶ˆæ¯åˆå¹¶',
          unknown: 'æœªçŸ¥ç±»å‹',
        };

        const typeIcons = {
          agent: 'ğŸ¤–',
          message: 'ğŸ’¬',
          delivery: 'ğŸ“¤',
          merge: 'ğŸ”€',
          unknown: 'â“',
        };

        container.innerHTML = alertTypes
          .map(
            (item) => `
          <div class="alert-type-item">
            <div class="alert-type-label">
              <span class="alert-type-badge ${item.type}">${typeIcons[item.type] || 'â“'}</span>
              <span>${typeLabels[item.type] || item.type}</span>
            </div>
            <div class="alert-type-bar">
              <div class="alert-type-bar-fill ${item.type}" style="width: ${item.percentage}%"></div>
            </div>
            <div class="alert-type-stats">
              <span class="alert-type-count">${item.count}</span>
              <span class="alert-type-percentage">${item.percentage}%</span>
            </div>
          </div>
        `,
          )
          .join('');
      }

      function updateTimeRangeBadge(timeRange) {
        const badge = document.getElementById('timeRangeBadge');
        const businessBadge = document.getElementById('businessTimeRangeBadge');
        const labels = {
          'today': 'ï¼ˆæœ¬æ—¥ï¼‰',
          'week': 'ï¼ˆæœ¬å‘¨ï¼‰',
          'month': 'ï¼ˆæœ¬æœˆï¼‰'
        };
        const label = labels[timeRange] || '';
        badge.textContent = label;
        if (businessBadge) {
          businessBadge.textContent = label;
        }
      }

      function updateFallbackStats(fallback, fallbackDelta) {
        if (!fallback) return;
        document.getElementById('fallbackCount').textContent = fallback.totalCount;
        document.getElementById('fallbackRate').textContent =
          `æˆåŠŸç‡ ${fallback.successRate.toFixed(1)}% (${fallback.successCount}/${fallback.totalCount})`;
        setDelta('fallbackDelta', fallbackDelta.totalCount);
      }

      function updateBusinessMetrics(business, businessDelta) {
        if (!business) return;

        // æ€»å’¨è¯¢äººæ•°
        document.getElementById('businessConsultationsTotal').textContent = business.consultations.total;
        document.getElementById('businessConsultationsNew').textContent = business.consultations.new;
        setDelta('businessConsultationsDelta', businessDelta.consultations);

        // é¢„çº¦é¢è¯•æ¬¡æ•°
        document.getElementById('businessBookingAttempts').textContent = business.bookings.attempts;
        document.getElementById('businessBookingSuccessful').textContent = business.bookings.successful;
        document.getElementById('businessBookingFailed').textContent = business.bookings.failed;
        setDelta('businessBookingAttemptsDelta', businessDelta.bookingAttempts);

        // é¢„çº¦æˆåŠŸç‡
        document.getElementById('businessBookingSuccessRate').textContent =
          business.bookings.successRate > 0 ? `${business.bookings.successRate.toFixed(1)}%` : '0%';
        document.getElementById('businessConversionRate').textContent =
          business.conversion.consultationToBooking > 0
            ? `${business.conversion.consultationToBooking.toFixed(1)}%`
            : '0%';
        setDelta('businessBookingSuccessRateDelta', businessDelta.bookingSuccessRate);
      }

      function updatePercentiles(percentiles) {
        if (!percentiles) return;
        document.getElementById('p50Duration').textContent = formatDuration(percentiles.p50);
        document.getElementById('p95Duration').textContent = formatDuration(percentiles.p95);
        document.getElementById('p99Duration').textContent = formatDuration(percentiles.p99);
      }

      function updateSlowestTable(records) {
        const tbody = document.getElementById('slowestRecords');
        tbody.innerHTML = '';
        if (!records || records.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="loading">æš‚æ— æ•°æ®</td></tr>';
          return;
        }
        records.forEach((record) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${formatTime(record.receivedAt)}</td>
            <td>${record.userName || record.chatId}</td>
            <td>${record.messagePreview || '-'}</td>
            <td>${formatDuration(record.totalDuration)}</td>
            <td>${formatDuration(record.aiDuration)}</td>
            <td>${record.replySegments ?? '-'}</td>
            <td><span class="status-badge ${record.status === 'success' ? 'success' : 'danger'}">${record.status}</span></td>
          `;
          tbody.appendChild(row);
        });
      }

      function updateRecentMessages(records) {
        // å­˜å‚¨æ‰€æœ‰è®°å½•ç”¨äºåˆ†é¡µ
        allRecentMessages = records || [];

        // æ›´æ–°æ€»æ•°æ˜¾ç¤º
        document.getElementById('recentMessagesTotal').textContent = `(${allRecentMessages.length} æ¡)`;

        // è®¡ç®—æ–°çš„æ€»é¡µæ•°
        const newTotalPages = allRecentMessages.length > 0
          ? Math.ceil(allRecentMessages.length / pageSize)
          : 1;

        // å¦‚æœå½“å‰é¡µè¶…å‡ºèŒƒå›´ï¼Œè°ƒæ•´åˆ°æœ€åä¸€é¡µ
        if (currentPage > newTotalPages) {
          currentPage = newTotalPages;
        }

        // ä¿æŒå½“å‰é¡µç ï¼Œä¸é‡ç½®
        renderCurrentPage();
      }

      function renderCurrentPage() {
        const tbody = document.getElementById('recentMessages');
        tbody.innerHTML = '';

        if (!allRecentMessages || allRecentMessages.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="loading">æš‚æ— æ•°æ®</td></tr>';
          updatePaginationUI(0, 0, 0);
          return;
        }

        // è®¡ç®—åˆ†é¡µ
        totalPages = Math.ceil(allRecentMessages.length / pageSize);
        currentPage = Math.min(currentPage, totalPages);
        currentPage = Math.max(currentPage, 1);

        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = Math.min(startIndex + pageSize, allRecentMessages.length);
        const pageRecords = allRecentMessages.slice(startIndex, endIndex);

        // æ¸²æŸ“å½“å‰é¡µæ•°æ®
        pageRecords.forEach((record) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${formatTime(record.receivedAt)}</td>
            <td>${record.userName || record.chatId || '-'}</td>
            <td>${record.messagePreview || '-'}</td>
            <td>${record.replyPreview || '-'}</td>
            <td>${formatDuration(record.totalDuration)}</td>
            <td><span class="status-badge ${
              record.status === 'success'
                ? 'success'
                : record.status === 'failure'
                ? 'danger'
                : 'warning'
            }">${record.status}</span></td>
          `;
          tbody.appendChild(row);
        });

        // æ›´æ–°åˆ†é¡µ UI
        updatePaginationUI(startIndex + 1, endIndex, allRecentMessages.length);
      }

      function updatePaginationUI(start, end, total) {
        document.getElementById('paginationStart').textContent = total > 0 ? start : 0;
        document.getElementById('paginationEnd').textContent = end;
        document.getElementById('paginationTotal').textContent = total;

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.getElementById('paginationFirst').disabled = currentPage <= 1;
        document.getElementById('paginationPrev').disabled = currentPage <= 1;
        document.getElementById('paginationNext').disabled = currentPage >= totalPages;
        document.getElementById('paginationLast').disabled = currentPage >= totalPages;

        // æ¸²æŸ“é¡µç æŒ‰é’®
        renderPageNumbers();
      }

      function renderPageNumbers() {
        const container = document.getElementById('paginationPages');
        container.innerHTML = '';

        if (totalPages <= 1) return;

        // æ˜¾ç¤ºæœ€å¤š 5 ä¸ªé¡µç æŒ‰é’®
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);

        if (endPage - startPage < 4) {
          startPage = Math.max(1, endPage - 4);
        }

        for (let i = startPage; i <= endPage; i++) {
          const btn = document.createElement('button');
          btn.className = `pagination-page ${i === currentPage ? 'active' : ''}`;
          btn.textContent = i;
          btn.onclick = () => goToPage(i);
          container.appendChild(btn);
        }
      }

      function goToPage(page) {
        // ç¡®ä¿ totalPages å·²è®¡ç®—
        if (allRecentMessages.length > 0) {
          totalPages = Math.ceil(allRecentMessages.length / pageSize);
        }
        if (page < 1 || page > totalPages || page === currentPage) return;
        currentPage = page;
        renderCurrentPage();
      }

      function changePageSize() {
        const select = document.getElementById('pageSizeSelect');
        pageSize = parseInt(select.value, 10);
        currentPage = 1;
        renderCurrentPage();
      }

      function createGradient(ctx, colorStart, colorEnd) {
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, colorStart);
        gradient.addColorStop(1, colorEnd);
        return gradient;
      }

      function initCharts() {
        Chart.defaults.font.family = "'Inter', system-ui, -apple-system, sans-serif";
        Chart.defaults.color = '#64748b'; // Darker text for light mode
        Chart.defaults.scale.grid.color = 'rgba(0, 0, 0, 0.05)'; // Darker grid lines
        Chart.defaults.scale.grid.borderColor = 'transparent';

        const commonOptions = {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(255, 255, 255, 0.95)', // Light tooltip
              titleColor: '#1e293b', // Dark title
              bodyColor: '#475569', // Dark body
              borderColor: 'rgba(148, 163, 184, 0.2)',
              borderWidth: 1,
              padding: 12,
              cornerRadius: 8,
              displayColors: false,
              callbacks: {
                label: (context) => `${context.dataset.label}: ${context.parsed.y}`
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { color: '#94a3b8', font: { size: 11 } },
            },
            y: {
              beginAtZero: true,
              border: { display: false },
              grid: { color: 'rgba(0, 0, 0, 0.03)' },
              ticks: { color: '#94a3b8', font: { size: 11 }, padding: 10 },
            },
          },
          elements: {
            line: { tension: 0.4, borderWidth: 3 },
            point: { radius: 0, hoverRadius: 6, borderWidth: 2, hoverBorderWidth: 3 }
          }
        };

        // å“åº”è€—æ—¶è¶‹åŠ¿å›¾è¡¨
        const responseCtx = document.getElementById('responseTrendChart').getContext('2d');
        const responseGradient = createGradient(responseCtx, 'rgba(59, 130, 246, 0.2)', 'rgba(59, 130, 246, 0)');
        
        responseTrendChart = new Chart(responseCtx, {
          type: 'line',
          data: {
            labels: [],
            datasets: [{
              label: 'å¹³å‡è€—æ—¶ (ç§’)',
              data: [],
              borderColor: '#60a5fa',
              backgroundColor: responseGradient,
              fill: true,
              pointBackgroundColor: '#1e293b',
              pointBorderColor: '#60a5fa',
            }],
          },
          options: {
            ...commonOptions,
            scales: {
              ...commonOptions.scales,
              y: {
                ...commonOptions.scales.y,
                ticks: { callback: (value) => `${value.toFixed(1)}s` }
              }
            }
          }
        });

        // å‘Šè­¦è¶‹åŠ¿å›¾è¡¨
        const alertCtx = document.getElementById('alertTrendChart').getContext('2d');
        alertTrendChart = new Chart(alertCtx, {
          type: 'bar',
          data: {
            labels: [],
            datasets: [{
              label: 'å‘Šè­¦æ¬¡æ•°',
              data: [],
              backgroundColor: '#f87171',
              borderRadius: 4,
              hoverBackgroundColor: '#ef4444',
            }],
          },
          options: {
            ...commonOptions,
            scales: {
              ...commonOptions.scales,
              y: {
                ...commonOptions.scales.y,
                ticks: { stepSize: 1, precision: 0 }
              }
            }
          }
        });

        // å’¨è¯¢äººæ•°è¶‹åŠ¿å›¾è¡¨
        const consultationsCtx = document.getElementById('consultationsTrendChart').getContext('2d');
        const consultGradient = createGradient(consultationsCtx, 'rgba(139, 92, 246, 0.2)', 'rgba(139, 92, 246, 0)');

        consultationsTrendChart = new Chart(consultationsCtx, {
          type: 'line',
          data: {
            labels: [],
            datasets: [{
              label: 'å’¨è¯¢äººæ•°',
              data: [],
              borderColor: '#a78bfa',
              backgroundColor: consultGradient,
              fill: true,
              pointBackgroundColor: '#1e293b',
              pointBorderColor: '#a78bfa',
            }],
          },
          options: {
            ...commonOptions,
            scales: {
              ...commonOptions.scales,
              y: {
                ...commonOptions.scales.y,
                ticks: { stepSize: 1, precision: 0 }
              }
            }
          }
        });

        // é¢„çº¦è½¬åŒ–è¶‹åŠ¿å›¾è¡¨ï¼ˆåŒè½´ï¼‰
        const bookingCtx = document.getElementById('bookingTrendChart').getContext('2d');
        const bookingGradient = createGradient(bookingCtx, 'rgba(236, 72, 153, 0.2)', 'rgba(236, 72, 153, 0)');

        bookingTrendChart = new Chart(bookingCtx, {
          type: 'line',
          data: {
            labels: [],
            datasets: [
              {
                label: 'é¢„çº¦æ¬¡æ•°',
                data: [],
                borderColor: '#f472b6',
                backgroundColor: bookingGradient,
                fill: true,
                yAxisID: 'y',
                pointBackgroundColor: '#1e293b',
                pointBorderColor: '#f472b6',
              },
              {
                label: 'é¢„çº¦æˆåŠŸç‡',
                data: [],
                borderColor: '#34d399',
                backgroundColor: 'transparent',
                borderDash: [5, 5],
                fill: false,
                yAxisID: 'y1',
                pointBackgroundColor: '#1e293b',
                pointBorderColor: '#34d399',
              },
            ],
          },
          options: {
            ...commonOptions,
            plugins: {
              ...commonOptions.plugins,
              legend: {
                display: true,
                labels: { color: '#94a3b8', usePointStyle: true, boxWidth: 8 }
              }
            },
            scales: {
              x: commonOptions.scales.x,
              y: {
                ...commonOptions.scales.y,
                position: 'left',
                title: { display: true, text: 'é¢„çº¦æ¬¡æ•°', color: '#f472b6', font: {size: 10} }
              },
              y1: {
                ...commonOptions.scales.y,
                position: 'right',
                grid: { drawOnChartArea: false },
                title: { display: true, text: 'æˆåŠŸç‡ (%)', color: '#34d399', font: {size: 10} },
                ticks: { callback: (value) => `${value}%` }
              },
            },
          },
        });

        // æ¯æ—¥ Token æ¶ˆè€—è¶‹åŠ¿å›¾è¡¨
        const dailyTokenCtx = document.getElementById('dailyTokenChart').getContext('2d');
        dailyTokenChart = new Chart(dailyTokenCtx, {
          type: 'bar',
          data: {
            labels: [],
            datasets: [{
              label: 'Token æ¶ˆè€—',
              data: [],
              backgroundColor: '#fbbf24',
              borderRadius: 4,
              hoverBackgroundColor: '#f59e0b',
            }],
          },
          options: {
            ...commonOptions,
            scales: {
              ...commonOptions.scales,
              y: {
                ...commonOptions.scales.y,
                ticks: { callback: (value) => value >= 1000 ? `${(value / 1000).toFixed(1)}k` : value }
              }
            }
          }
        });

        // æ¯æ—¥ç”¨æˆ·æ•°è¶‹åŠ¿å›¾è¡¨
        const dailyUserCtx = document.getElementById('dailyUserChart').getContext('2d');
        const userGradient = createGradient(dailyUserCtx, 'rgba(59, 130, 246, 0.2)', 'rgba(59, 130, 246, 0)');

        dailyUserChart = new Chart(dailyUserCtx, {
          type: 'line',
          data: {
            labels: [],
            datasets: [{
              label: 'å’¨è¯¢äººæ•°',
              data: [],
              borderColor: '#60a5fa',
              backgroundColor: userGradient,
              fill: true,
              pointBackgroundColor: '#1e293b',
              pointBorderColor: '#60a5fa',
            }],
          },
          options: {
            ...commonOptions,
            scales: {
              ...commonOptions.scales,
              y: {
                ...commonOptions.scales.y,
                ticks: { stepSize: 1, precision: 0 }
              }
            }
          }
        });
      }

      function updateCharts(data) {
        const isToday = currentTimeRange === 'today';
        const formatLabel = isToday ? formatMinuteLabel : formatDayLabel;

        // æœ¬æ—¥ï¼šæ˜¾ç¤ºæœ€è¿‘90ä¸ªæ•°æ®ç‚¹ï¼›æœ¬å‘¨/æœ¬æœˆï¼šæ˜¾ç¤ºå…¨éƒ¨æ•°æ®ç‚¹
        const responsePoints = isToday
          ? (data.responseTrend || []).slice(-90)
          : (data.responseTrend || []);
        const responseLabels = responsePoints.map((point) => formatLabel(point.minute));
        responseTrendChart.data.labels = responseLabels;
        responseTrendChart.data.datasets[0].data = responsePoints.map((point) =>
          point.avgDuration ? point.avgDuration / 1000 : 0,
        );
        responseTrendChart.update();

        // æ›´æ–°å›¾è¡¨èŒƒå›´æ ‡ç­¾
        const rangeText = isToday
          ? `${responseLabels.length} åˆ†é’Ÿ`
          : `${responseLabels.length} å¤©`;
        document.getElementById('chartRangeLabel').textContent = responseLabels.length;
        document.getElementById('responseChartAvg').textContent =
          responsePoints.length > 0
            ? formatDuration(responsePoints[responsePoints.length - 1].avgDuration)
            : '-';

        const alertPoints = isToday
          ? (data.alertTrend || []).slice(-90)
          : (data.alertTrend || []);
        const alertLabels = alertPoints.map((point) => formatLabel(point.minute));
        alertTrendChart.data.labels = alertLabels;
        alertTrendChart.data.datasets[0].data = alertPoints.map((point) => point.count);
        alertTrendChart.update();
        const lastFiveAlerts = alertPoints.slice(-5).reduce((sum, point) => sum + point.count, 0);
        document.getElementById('alertTrendRecent').textContent = lastFiveAlerts || 0;

        // æ›´æ–°ä¸šåŠ¡æŒ‡æ ‡è¶‹åŠ¿å›¾è¡¨
        const businessPoints = isToday
          ? (data.businessTrend || []).slice(-90)
          : (data.businessTrend || []);
        const businessLabels = businessPoints.map((point) => formatLabel(point.minute));

        // å’¨è¯¢äººæ•°è¶‹åŠ¿
        consultationsTrendChart.data.labels = businessLabels;
        consultationsTrendChart.data.datasets[0].data = businessPoints.map(
          (point) => point.consultations,
        );
        consultationsTrendChart.update();

        // é¢„çº¦è½¬åŒ–è¶‹åŠ¿ï¼ˆåŒè½´ï¼šé¢„çº¦æ¬¡æ•° + æˆåŠŸç‡ï¼‰
        bookingTrendChart.data.labels = businessLabels;
        bookingTrendChart.data.datasets[0].data = businessPoints.map(
          (point) => point.bookingAttempts,
        );
        bookingTrendChart.data.datasets[1].data = businessPoints.map(
          (point) => point.bookingSuccessRate,
        );
        bookingTrendChart.update();
      }

      function updateDailyCharts(dailyTrend) {
        if (!dailyTrend || dailyTrend.length === 0) {
          document.getElementById('dailyTokenUsage').textContent = '-';
          document.getElementById('dailyUserCount').textContent = '-';
          return;
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ ‡ç­¾ä¸º MM-DD
        const labels = dailyTrend.map(day => {
          const date = day.date;
          return date.substring(5); // "2025-11-21" -> "11-21"
        });

        // æ›´æ–° Token æ¶ˆè€—å›¾è¡¨
        dailyTokenChart.data.labels = labels;
        dailyTokenChart.data.datasets[0].data = dailyTrend.map(day => day.tokenUsage);
        dailyTokenChart.update();

        // æ›´æ–°ç”¨æˆ·æ•°å›¾è¡¨
        dailyUserChart.data.labels = labels;
        dailyUserChart.data.datasets[0].data = dailyTrend.map(day => day.uniqueUsers);
        dailyUserChart.update();

        // æ›´æ–° KPI æ˜¾ç¤ºï¼ˆä»Šæ—¥æ•°æ®ï¼‰
        const today = dailyTrend[dailyTrend.length - 1];
        document.getElementById('dailyTokenUsage').textContent =
          today.tokenUsage >= 1000
            ? `${(today.tokenUsage / 1000).toFixed(1)}k`
            : today.tokenUsage.toLocaleString();
        document.getElementById('dailyUserCount').textContent = `${today.uniqueUsers} äºº`;
      }

      function updateTodayUsersList(users) {
        const tbody = document.getElementById('todayUsersList');
        const countSpan = document.getElementById('todayUserCount');

        if (!users || users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="loading">æš‚æ— ä»Šæ—¥å’¨è¯¢ç”¨æˆ·</td></tr>';
          countSpan.textContent = '(0 äºº)';
          return;
        }

        countSpan.textContent = `(${users.length} äºº)`;

        tbody.innerHTML = users.map(user => {
          const isPaused = user.isPaused;
          const statusBadge = isPaused
            ? '<span class="status-badge warning">å·²æš‚åœ</span>'
            : '<span class="status-badge success">æ‰˜ç®¡ä¸­</span>';
          const toggleBtn = isPaused
            ? `<button class="btn btn-ghost" style="padding: 4px 8px; font-size: 11px;" onclick="toggleUserHosting('${user.chatId}', false)">æ¢å¤</button>`
            : `<button class="btn btn-ghost" style="padding: 4px 8px; font-size: 11px; color: var(--warning);" onclick="toggleUserHosting('${user.chatId}', true)">æš‚åœ</button>`;

          // æ˜¾ç¤ºå°ç»„ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
          const groupInfo = user.groupName ? `<br><span style="font-size: 11px; color: var(--text-muted);">${user.groupName}</span>` : '';

          return `
            <tr>
              <td>
                <strong>${user.odName || user.odId}</strong>
                ${groupInfo}
              </td>
              <td style="font-size: 11px; color: var(--text-muted);">${user.chatId.substring(0, 8)}...</td>
              <td>${user.messageCount}</td>
              <td>${user.tokenUsage >= 1000 ? `${(user.tokenUsage / 1000).toFixed(1)}k` : user.tokenUsage}</td>
              <td>${formatTime(user.firstActiveAt)}</td>
              <td>${formatTime(user.lastActiveAt)}</td>
              <td>
                ${statusBadge}
                ${toggleBtn}
              </td>
            </tr>
          `;
        }).join('');
      }

      async function toggleUserHosting(userId, pause) {
        try {
          const action = pause ? 'pause' : 'resume';
          const response = await fetch(`/monitoring/users/${encodeURIComponent(userId)}/${action}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
          });

          const result = await response.json();
          const data = unwrapResponse(result);

          if (data) {
            // åˆ·æ–°ä»ªè¡¨ç›˜ä»¥æ›´æ–°ç”¨æˆ·çŠ¶æ€
            await refreshDashboard();
            console.log(data.message);
          }
        } catch (error) {
          console.error('åˆ‡æ¢ç”¨æˆ·æ‰˜ç®¡çŠ¶æ€å¤±è´¥', error);
        }
      }

      async function refreshHealthStatus() {
        try {
          const response = await fetch('/agent/health');
          const result = await response.json();
          const health = unwrapResponse(result);
          updateHealthCard(
            'overallHealthCard',
            'overallHealthStatus',
            'overallHealthMessage',
            health.status === 'healthy' ? 'success' : 'warning',
            health.status === 'healthy' ? 'è¿è¡Œæ­£å¸¸' : 'æœåŠ¡é™çº§',
            health.message || 'Agent æœåŠ¡çŠ¶æ€æœªçŸ¥',
          );

          updateHealthCard(
            'modelHealthCard',
            'modelHealthStatus',
            'modelHealthDetails',
            health.models?.status === 'available' ? 'success' : 'warning',
            health.models?.status === 'available' ? 'æœåŠ¡å¯ç”¨' : 'éœ€å…³æ³¨',
            health.models?.message || 'æ¨¡å‹çŠ¶æ€æ£€æŸ¥ä¸­',
          );

          updateHealthCard(
            'toolHealthCard',
            'toolHealthStatus',
            'toolHealthDetails',
            health.tools?.status === 'healthy' ? 'success' : 'warning',
            health.tools?.status === 'healthy' ? 'å“åº”æ­£å¸¸' : 'å“åº”ç¼“æ…¢',
            health.tools?.message || 'å·¥å…·é“¾æ£€æŸ¥ä¸­',
          );

          // æ›´æ–°é¡¶éƒ¨å¥åº·çŠ¶æ€å¾½ç« 
          const badge = document.getElementById('overallHealthBadge');
          if (badge) {
            const isHealthy = health.status === 'healthy';
            const isModelOk = health.models?.status === 'available';
            const isToolOk = health.tools?.status === 'healthy';

            if (isHealthy && isModelOk && isToolOk) {
              badge.textContent = 'å…¨éƒ¨æ­£å¸¸';
              badge.className = 'health-panel-badge';
            } else if (!isHealthy) {
              badge.textContent = 'æœåŠ¡å¼‚å¸¸';
              badge.className = 'health-panel-badge error';
            } else {
              badge.textContent = 'éƒ¨åˆ†å¼‚å¸¸';
              badge.className = 'health-panel-badge warning';
            }
          }

        } catch (error) {
          console.error('è·å–å¥åº·çŠ¶æ€å¤±è´¥', error);
          // æ›´æ–°å¾½ç« ä¸ºé”™è¯¯çŠ¶æ€
          const badge = document.getElementById('overallHealthBadge');
          if (badge) {
            badge.textContent = 'æ£€æŸ¥å¤±è´¥';
            badge.className = 'health-panel-badge error';
          }
        }
      }

      function updateHealthCard(cardId, statusId, descId, state, statusText, desc) {
        const card = document.getElementById(cardId);
        const status = document.getElementById(statusId);
        const descEl = document.getElementById(descId);
        if (!card || !status || !descEl) return;
        card.dataset.state = state;
        status.textContent = statusText;
        descEl.textContent = desc;
      }

      async function clearData() {
        try {
          await fetch('/monitoring/clear', { method: 'POST' });
          await refreshDashboard();
        } catch (error) {
          console.error('æ¸…ç©ºæ•°æ®å¤±è´¥', error);
        }
      }

      function formatTime(timestamp) {
        if (!timestamp) return '-';
        const date = new Date(timestamp);
        return date.toLocaleString('zh-CN', { hour12: false });
      }

      function formatMinuteLabel(value) {
        if (!value) return '-';
        const date = new Date(value);
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${hours}:${minutes}`;
      }

      function formatDayLabel(value) {
        if (!value) return '-';
        const date = new Date(value);
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${month}-${day}`;
      }

      function formatDuration(value, fractionDigits = 2) {
        if (value === undefined || value === null) return '-';
        const seconds = value / 1000;
        return `${seconds.toFixed(fractionDigits)} ç§’`;
      }
    </script>
  </body>
</html>
