<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bot ç›‘æ§ä»ªè¡¨ç›˜ - DuLiDay</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
      :root {
        --bg-dark: #050505;
        --bg-card: #111319;
        --bg-card-light: #161923;
        --border: rgba(255, 255, 255, 0.08);
        --text-primary: #f9fafb;
        --text-secondary: #9ca3af;
        --text-muted: #6b7280;
        --primary: #3b82f6;
        --primary-dark: #2563eb;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --info: #38bdf8;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: 'PingFang SC', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI',
          sans-serif;
        background: var(--bg-dark);
        color: var(--text-primary);
        padding: 40px 24px 80px;
      }

      .background-gradients {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 0;
      }

      .background-gradients span {
        position: absolute;
        width: 400px;
        height: 400px;
        filter: blur(150px);
        opacity: 0.3;
      }

      .bg-blue {
        background: #1e3a8a;
        top: -120px;
        left: -100px;
      }

      .bg-purple {
        background: #6d28d9;
        right: -120px;
        bottom: 40px;
      }

      .container {
        position: relative;
        z-index: 1;
        max-width: 1440px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .header {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 32px;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .header-top {
        display: flex;
        justify-content: space-between;
        gap: 24px;
        flex-wrap: wrap;
      }

      .header h1 {
        margin: 4px 0 8px;
        font-size: 28px;
      }

      .eyebrow {
        color: var(--text-muted);
        font-size: 13px;
        letter-spacing: 0.2em;
        text-transform: uppercase;
      }

      .header-actions {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .filters {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .filters button {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text-secondary);
        border-radius: 999px;
        padding: 6px 14px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .filters button.active {
        background: rgba(59, 130, 246, 0.15);
        border-color: var(--primary);
        color: var(--text-primary);
      }

      .header-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
      }

      .btn {
        border-radius: 10px;
        padding: 10px 16px;
        border: 1px solid transparent;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .btn-primary {
        background: var(--primary);
        color: #fff;
      }

      .btn-ghost {
        background: transparent;
        border-color: var(--border);
        color: var(--text-secondary);
      }

      .auto-refresh {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: var(--text-secondary);
      }

      .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--success);
        box-shadow: 0 0 12px rgba(16, 185, 129, 0.7);
      }

      .last-update {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--text-secondary);
        font-size: 13px;
      }

      .section {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 24px;
      }

      .health-grid {
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      }

      .health-card {
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 20px;
        display: flex;
        gap: 16px;
        align-items: center;
        background: var(--bg-card-light);
      }

      .health-card[data-state='error'] {
        border-color: rgba(239, 68, 68, 0.4);
        background: rgba(239, 68, 68, 0.08);
      }

      .health-card[data-state='warning'] {
        border-color: rgba(245, 158, 11, 0.4);
        background: rgba(245, 158, 11, 0.08);
      }

      .health-icon {
        font-size: 30px;
      }

      .health-title {
        font-size: 13px;
        color: var(--text-muted);
        letter-spacing: 0.08em;
      }

      .health-status {
        font-size: 18px;
        font-weight: 600;
      }

      .health-desc {
        color: var(--text-secondary);
        font-size: 13px;
      }

      .metric-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
      }

      .metric-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 6px;
        position: relative;
        overflow: hidden;
      }

      .metric-card::after {
        content: '';
        position: absolute;
        inset: 0;
        opacity: 0.2;
        pointer-events: none;
      }

      .metric-card.primary::after {
        background: radial-gradient(circle at top right, rgba(59, 130, 246, 0.4), transparent);
      }

      .metric-card.success::after {
        background: radial-gradient(circle at top right, rgba(16, 185, 129, 0.4), transparent);
      }

      .metric-label {
        font-size: 13px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .metric-value {
        font-size: 28px;
        font-weight: 600;
      }

      .metric-subtitle {
        font-size: 13px;
        color: var(--text-secondary);
      }

      .metric-delta {
        font-size: 13px;
        font-weight: 600;
      }

      .metric-delta.positive {
        color: var(--success);
      }

      .metric-delta.negative {
        color: var(--danger);
      }

      .charts-row {
        display: grid;
        gap: 20px;
        grid-template-columns: 2fr 1fr;
      }

      .chart-card {
        border-radius: 20px;
        border: 1px solid var(--border);
        padding: 24px;
        background: var(--bg-card);
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
      }

      .chart-header h3 {
        margin: 0;
        font-size: 18px;
      }

      .chart-header p {
        margin: 2px 0 0;
        color: var(--text-secondary);
        font-size: 13px;
      }

      .chart-kpi {
        text-align: right;
        font-size: 12px;
        color: var(--text-muted);
      }

      .chart-kpi strong {
        display: block;
        font-size: 18px;
        color: var(--text-primary);
      }

      canvas {
        width: 100% !important;
        height: 320px !important;
      }

      .scenario-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .scenario-item {
        display: flex;
        justify-content: space-between;
        font-size: 13px;
        color: var(--text-secondary);
      }

      .scenario-item strong {
        color: var(--text-primary);
      }

      .insight-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 16px;
      }

      .insight-card {
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 20px;
        background: var(--bg-card);
      }

      .insight-title {
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        margin-bottom: 12px;
      }

      .insight-metrics {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
      }

      .insight-metrics div span {
        font-size: 12px;
        color: var(--text-secondary);
      }

      .insight-metrics div strong {
        display: block;
        font-size: 20px;
      }

      .percentiles {
        display: grid;
        grid-template-columns: repeat(2, minmax(100px, 1fr));
        gap: 12px;
      }

      .percentiles span {
        font-size: 12px;
        color: var(--text-secondary);
      }

      .percentiles strong {
        display: block;
        font-size: 18px;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }

      .section-header h3 {
        margin: 0;
        font-size: 16px;
      }

      .table-wrapper {
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      thead th {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--text-muted);
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
        text-align: left;
      }

      tbody td {
        padding: 12px;
        border-bottom: 1px solid var(--border);
        font-size: 13px;
        color: var(--text-secondary);
      }

      tbody tr:hover {
        background: rgba(255, 255, 255, 0.02);
      }

      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border-radius: 999px;
        padding: 2px 10px;
        font-size: 12px;
        border: 1px solid transparent;
      }

      .status-badge.success {
        border-color: rgba(16, 185, 129, 0.4);
        color: var(--success);
      }

      .status-badge.warning {
        border-color: rgba(245, 158, 11, 0.4);
        color: var(--warning);
      }

      .status-badge.danger {
        border-color: rgba(239, 68, 68, 0.4);
        color: var(--danger);
      }

      .loading {
        padding: 24px;
        text-align: center;
        color: var(--text-secondary);
      }

      @media (max-width: 960px) {
        .charts-row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="background-gradients">
      <span class="bg-blue"></span>
      <span class="bg-purple"></span>
    </div>
    <div class="container">
      <div class="header">
        <div class="header-top">
          <div>
            <div class="eyebrow">ç‹¬ç«‹æ—¥ Bot</div>
            <h1>è¿è¥ç›‘æ§ä»ªè¡¨ç›˜</h1>
            <p>å®æ—¶æ´å¯Ÿä»£ç†å¥åº·ã€æ¶ˆæ¯ååã€å‘Šè­¦ä¸åŠŸèƒ½ä½¿ç”¨æƒ…å†µï¼ŒåŠæ—¶å®šä½å¼‚å¸¸ã€‚</p>
          </div>
          <div class="last-update">
            <span class="status-indicator"></span>
            <span>æœ€åæ›´æ–°: <span id="lastUpdate">-</span></span>
          </div>
        </div>
        <div class="header-actions">
          <div class="filters" id="rangeFilters">
            <button class="active" data-range="today">ä»Šæ—¥</button>
            <button data-range="week">æœ¬å‘¨</button>
            <button data-range="month">æœ¬æœˆ</button>
            <button data-range="custom">è‡ªå®šä¹‰</button>
          </div>
          <div class="header-controls">
            <button class="btn btn-primary" onclick="refreshAll()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            <button class="btn btn-ghost" onclick="clearData()">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®</button>
            <label class="auto-refresh">
              <input type="checkbox" id="autoRefresh" checked />
              è‡ªåŠ¨åˆ·æ–° (5ç§’)
            </label>
          </div>
        </div>
      </div>

      <section class="health-grid">
        <article class="health-card" id="overallHealthCard" data-state="loading">
          <div class="health-icon">ğŸ›°ï¸</div>
          <div>
            <div class="health-title">æ•´ä½“çŠ¶æ€</div>
            <div class="health-status" id="overallHealthStatus">-</div>
            <div class="health-desc" id="overallHealthMessage">æ£€æŸ¥ä¸­...</div>
          </div>
        </article>
        <article class="health-card" id="modelHealthCard" data-state="loading">
          <div class="health-icon">ğŸ¤–</div>
          <div>
            <div class="health-title">AI æ¨¡å‹</div>
            <div class="health-status" id="modelHealthStatus">-</div>
            <div class="health-desc" id="modelHealthDetails">æ£€æŸ¥ä¸­...</div>
          </div>
        </article>
        <article class="health-card" id="toolHealthCard" data-state="loading">
          <div class="health-icon">ğŸ§°</div>
          <div>
            <div class="health-title">å·¥å…·æœåŠ¡</div>
            <div class="health-status" id="toolHealthStatus">-</div>
            <div class="health-desc" id="toolHealthDetails">æ£€æŸ¥ä¸­...</div>
          </div>
        </article>
        <article class="health-card" id="brandConfigCard" data-state="loading">
          <div class="health-icon">ğŸ¨</div>
          <div>
            <div class="health-title">å“ç‰Œé…ç½®</div>
            <div class="health-status" id="brandConfigStatus">-</div>
            <div class="health-desc" id="brandConfigDetails">æ£€æŸ¥ä¸­...</div>
          </div>
        </article>
      </section>

      <section class="metric-grid">
        <article class="metric-card primary">
          <div class="metric-label">ä»Šæ—¥æ¶ˆæ¯</div>
          <div class="metric-value" id="totalMessages">-</div>
          <div class="metric-subtitle">ç´¯è®¡å¤„ç†</div>
          <div class="metric-delta" id="totalMessagesDelta">-</div>
        </article>
        <article class="metric-card success">
          <div class="metric-label">æˆåŠŸç‡</div>
          <div class="metric-value" id="successRate">-</div>
          <div class="metric-subtitle" id="successCount">-</div>
          <div class="metric-delta" id="successRateDelta">-</div>
        </article>
        <article class="metric-card">
          <div class="metric-label">å¹³å‡å“åº”</div>
          <div class="metric-value" id="avgDuration">-</div>
          <div class="metric-subtitle">æ¯«ç§’</div>
          <div class="metric-delta" id="avgDurationDelta">-</div>
        </article>
        <article class="metric-card">
          <div class="metric-label">æ´»è·ƒç”¨æˆ·</div>
          <div class="metric-value" id="activeUsers">-</div>
          <div class="metric-subtitle" id="activeChats">-</div>
          <div class="metric-delta" id="activeUsersDelta">-</div>
        </article>
      </section>

      <section class="charts-row">
        <div class="chart-card">
          <div class="chart-header">
            <div>
              <h3>æ¶ˆæ¯é‡è¶‹åŠ¿</h3>
              <p>æœ€è¿‘ <span id="chartRangeLabel">24</span> å°æ—¶</p>
            </div>
            <div class="chart-kpi">
              <span>è¿‘1å°æ—¶æˆåŠŸç‡</span>
              <strong id="chartSuccessRate">-</strong>
            </div>
          </div>
          <canvas id="messageChart"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-header">
            <div>
              <h3>åŠŸèƒ½ä½¿ç”¨é¢‘ç‡</h3>
              <p>Top5 å·¥å…·è°ƒç”¨</p>
            </div>
            <div class="chart-kpi">
              <span>å¹³å‡å¤±è´¥ç‡</span>
              <strong id="featureFailureRate">-</strong>
            </div>
          </div>
          <canvas id="featureUsageChart"></canvas>
          <ul class="scenario-list" id="scenarioUsageList"></ul>
        </div>
      </section>

      <section class="insight-grid">
        <article class="insight-card">
          <div class="insight-title">æ’é˜Ÿä¸å“åº”</div>
          <div class="insight-metrics">
            <div>
              <span>å®æ—¶å¤„ç†ä¸­</span>
              <strong id="queueCurrent">-</strong>
            </div>
            <div>
              <span>å³°å€¼é˜Ÿåˆ—</span>
              <strong id="queuePeak">-</strong>
            </div>
            <div>
              <span>å¹³å‡ç­‰å¾…</span>
              <strong id="queueAvgWait">-</strong>
            </div>
          </div>
        </article>
        <article class="insight-card">
          <div class="insight-title">å»¶è¿Ÿåˆ†å¸ƒ</div>
          <div class="percentiles">
            <div>
              <span>P50</span>
              <strong id="p50Duration">-</strong>
            </div>
            <div>
              <span>P95</span>
              <strong id="p95Duration">-</strong>
            </div>
            <div>
              <span>P99</span>
              <strong id="p99Duration">-</strong>
            </div>
            <div>
              <span>P999</span>
              <strong id="p999Duration">-</strong>
            </div>
          </div>
        </article>
        <article class="insight-card">
          <div class="insight-title">å‘Šè­¦æ¦‚è§ˆ</div>
          <div class="insight-metrics">
            <div>
              <span>ç´¯è®¡</span>
              <strong id="alertTotal">-</strong>
            </div>
            <div>
              <span>è¿‘24å°æ—¶</span>
              <strong id="alertRecent">-</strong>
            </div>
          </div>
        </article>
      </section>

      <section class="section">
        <div class="section-header">
          <h3>æœ€æ…¢è®°å½• (Top 10)</h3>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>æ—¶é—´</th>
                <th>ç”¨æˆ·</th>
                <th>æ¶ˆæ¯é¢„è§ˆ</th>
                <th>æ€»è€—æ—¶</th>
                <th>AI è€—æ—¶</th>
                <th>å·¥å…·</th>
                <th>çŠ¶æ€</th>
              </tr>
            </thead>
            <tbody id="slowestRecords">
              <tr>
                <td colspan="7" class="loading">åŠ è½½ä¸­</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="section">
        <div class="section-header">
          <h3>å®æ—¶æ¶ˆæ¯ï¼ˆæœ€æ–° 50 æ¡ï¼‰</h3>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>æ—¶é—´</th>
                <th>ä¼šè¯</th>
                <th>ç”¨æˆ·æ¶ˆæ¯</th>
                <th>å›å¤é¢„è§ˆ</th>
                <th>æ€»è€—æ—¶</th>
                <th>çŠ¶æ€</th>
              </tr>
            </thead>
            <tbody id="recentMessages">
              <tr>
                <td colspan="6" class="loading">åŠ è½½ä¸­</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="section">
        <div class="section-header">
          <h3>å®æ—¶å‘Šè­¦æ—¥å¿—</h3>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>æ—¶é—´</th>
                <th>æ¶ˆæ¯ ID</th>
                <th>é”™è¯¯ä¿¡æ¯</th>
              </tr>
            </thead>
            <tbody id="errorLogs">
              <tr>
                <td colspan="3" class="loading">åŠ è½½ä¸­</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </div>

    <script>
      let autoRefreshInterval = null;
      let messageChart = null;
      let featureUsageChart = null;
      let cachedDashboard = null;
      let cachedMetrics = null;
      const RANGE_PRESETS = {
        today: 24,
        week: 72,
        month: 168,
        custom: 48,
      };
      let selectedRange = 'today';

      document.addEventListener('DOMContentLoaded', () => {
        initCharts();
        setupRangeFilters();
        setupAutoRefreshToggle();
        refreshAll();
      });

      async function refreshAll() {
        await Promise.all([refreshHealthStatus(), refreshDashboard()]);
      }

      function setupRangeFilters() {
        const buttons = document.querySelectorAll('#rangeFilters button');
        buttons.forEach((btn) => {
          btn.addEventListener('click', () => {
            buttons.forEach((b) => b.classList.remove('active'));
            btn.classList.add('active');
            selectedRange = btn.dataset.range;
            if (cachedDashboard) {
              updateCharts(cachedDashboard);
            }
          });
        });
      }

      function setupAutoRefreshToggle() {
        const checkbox = document.getElementById('autoRefresh');
        checkbox.addEventListener('change', toggleAutoRefresh);
        toggleAutoRefresh();
      }

      function toggleAutoRefresh() {
        const checkbox = document.getElementById('autoRefresh');
        if (checkbox.checked) {
          if (autoRefreshInterval) clearInterval(autoRefreshInterval);
          autoRefreshInterval = setInterval(refreshDashboard, 5000);
        } else if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
        }
      }

      async function refreshDashboard() {
        try {
          const [dashboardRes, metricsRes] = await Promise.all([
            fetch('/monitoring/dashboard'),
            fetch('/monitoring/metrics'),
          ]);
          const dashboard = await dashboardRes.json();
          const metrics = await metricsRes.json();
          cachedDashboard = dashboard;
          cachedMetrics = metrics;
          renderDashboard(dashboard, metrics);
          document.getElementById('lastUpdate').textContent = formatTime(Date.now());
        } catch (error) {
          console.error('åŠ è½½ç›‘æ§æ•°æ®å¤±è´¥', error);
        }
      }

      function renderDashboard(dashboard, metrics) {
        updateOverview(dashboard);
        updateUsage(dashboard);
        updateQueueInfo(dashboard);
        updatePercentiles(metrics.percentiles);
        updateSlowestTable(metrics.slowestRecords);
        updateRecentMessages(dashboard.recentMessages);
        updateErrorLogs(dashboard.recentErrors);
        updateCharts(dashboard);
      }

      function updateOverview(data) {
        const { overview, overviewDelta } = data;
        setMetric('totalMessages', overview.totalMessages);
        setMetric('successRate', `${overview.successRate.toFixed(1)}%`);
        setMetric('avgDuration', `${Math.round(overview.avgDuration)} ms`);
        setMetric('activeUsers', overview.activeUsers);
        document.getElementById('successCount').textContent = `æˆåŠŸ ${overview.successCount} æ¡`;
        document.getElementById('activeChats').textContent = `${overview.activeChats} ä¸ªä¼šè¯`;
        setDelta('totalMessagesDelta', overviewDelta.totalMessages);
        setDelta('successRateDelta', overviewDelta.successRate);
        setDelta('avgDurationDelta', overviewDelta.avgDuration);
        setDelta('activeUsersDelta', overviewDelta.activeUsers);
      }

      function setMetric(id, value) {
        const el = document.getElementById(id);
        if (el) {
          el.textContent = value ?? '-';
        }
      }

      function setDelta(id, delta) {
        const el = document.getElementById(id);
        if (!el || delta === undefined || delta === null) {
          return;
        }
        const val = parseFloat(delta.toFixed(1));
        el.textContent = `${val >= 0 ? '+' : ''}${val}%`;
        el.classList.toggle('positive', val >= 0);
        el.classList.toggle('negative', val < 0);
      }

      function updateUsage(data) {
        const tools = data.usage?.tools || [];
        const scenarios = data.usage?.scenarios || [];
        const failureAvg =
          tools.length > 0
            ? tools.reduce((sum, item) => sum + item.failureRate, 0) / tools.length
            : 0;
        document.getElementById('featureFailureRate').textContent = `${failureAvg.toFixed(1)}%`;
        updateScenarioList(scenarios);
      }

      function updateScenarioList(list) {
        const container = document.getElementById('scenarioUsageList');
        container.innerHTML = '';
        if (!list || list.length === 0) {
          container.innerHTML = '<li class="scenario-item">æš‚æ— åœºæ™¯æ•°æ®</li>';
          return;
        }
        list.slice(0, 4).forEach((item) => {
          const li = document.createElement('li');
          li.className = 'scenario-item';
          li.innerHTML = `<span>${item.name}</span><strong>${item.total} (${item.percentage}%)</strong>`;
          container.appendChild(li);
        });
      }

      function updateQueueInfo(data) {
        const queue = data.queue || {};
        document.getElementById('queueCurrent').textContent = queue.currentProcessing ?? '-';
        document.getElementById('queuePeak').textContent = queue.peakProcessing ?? '-';
        document.getElementById('queueAvgWait').textContent = queue.avgQueueDuration
          ? `${Math.round(queue.avgQueueDuration)} ms`
          : '-';
        const alerts = data.alertsSummary || { total: 0, last24Hours: 0 };
        document.getElementById('alertTotal').textContent = alerts.total;
        document.getElementById('alertRecent').textContent = alerts.last24Hours;
      }

      function updatePercentiles(percentiles) {
        if (!percentiles) return;
        document.getElementById('p50Duration').textContent = `${Math.round(percentiles.p50)} ms`;
        document.getElementById('p95Duration').textContent = `${Math.round(percentiles.p95)} ms`;
        document.getElementById('p99Duration').textContent = `${Math.round(percentiles.p99)} ms`;
        document.getElementById('p999Duration').textContent = `${Math.round(percentiles.p999)} ms`;
      }

      function updateSlowestTable(records) {
        const tbody = document.getElementById('slowestRecords');
        tbody.innerHTML = '';
        if (!records || records.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="loading">æš‚æ— æ•°æ®</td></tr>';
          return;
        }
        records.forEach((record) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${formatTime(record.receivedAt)}</td>
            <td>${record.userName || record.chatId}</td>
            <td>${record.messagePreview || '-'}</td>
            <td>${formatDuration(record.totalDuration)}</td>
            <td>${formatDuration(record.aiDuration)}</td>
            <td>${(record.tools || []).join(', ') || '-'}</td>
            <td><span class="status-badge ${record.status === 'success' ? 'success' : 'danger'}">${record.status}</span></td>
          `;
          tbody.appendChild(row);
        });
      }

      function updateRecentMessages(records) {
        const tbody = document.getElementById('recentMessages');
        tbody.innerHTML = '';
        if (!records || records.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="loading">æš‚æ— æ•°æ®</td></tr>';
          return;
        }
        records.forEach((record) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${formatTime(record.receivedAt)}</td>
            <td>${record.chatId}</td>
            <td>${record.messagePreview || '-'}</td>
            <td>${record.replyPreview || '-'}</td>
            <td>${formatDuration(record.totalDuration)}</td>
            <td><span class="status-badge ${
              record.status === 'success'
                ? 'success'
                : record.status === 'failure'
                ? 'danger'
                : 'warning'
            }">${record.status}</span></td>
          `;
          tbody.appendChild(row);
        });
      }

      function updateErrorLogs(logs) {
        const tbody = document.getElementById('errorLogs');
        tbody.innerHTML = '';
        if (!logs || logs.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" class="loading">æš‚æ— é”™è¯¯</td></tr>';
          return;
        }
        logs.forEach((log) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${formatTime(log.timestamp)}</td>
            <td>${log.messageId}</td>
            <td>${log.error}</td>
          `;
          tbody.appendChild(row);
        });
      }

      function initCharts() {
        const ctx = document.getElementById('messageChart').getContext('2d');
        messageChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: [],
            datasets: [
              {
                label: 'æ¶ˆæ¯é‡',
                data: [],
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.15)',
                fill: true,
                tension: 0.35,
                pointRadius: 0,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
            },
            scales: {
              x: {
                grid: { color: 'rgba(255, 255, 255, 0.05)' },
                ticks: { color: '#94a3b8' },
              },
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(255, 255, 255, 0.05)' },
                ticks: { color: '#94a3b8' },
              },
            },
          },
        });

        const featureCtx = document.getElementById('featureUsageChart').getContext('2d');
        featureUsageChart = new Chart(featureCtx, {
          type: 'bar',
          data: {
            labels: [],
            datasets: [
              {
                label: 'è°ƒç”¨æ¬¡æ•°',
                data: [],
                backgroundColor: '#22d3ee',
                borderRadius: 8,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
            },
            scales: {
              x: {
                grid: { display: false },
                ticks: { color: '#94a3b8' },
              },
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(255, 255, 255, 0.05)' },
                ticks: { color: '#94a3b8' },
              },
            },
          },
        });
      }

      function updateCharts(data) {
        const hourly = data.trends?.hourly || [];
        const rangeHours = RANGE_PRESETS[selectedRange] || data.lastWindowHours || 24;
        const slice = hourly.slice(-rangeHours);

        const labels = slice.map((item) => formatHour(item.hour));
        const counts = slice.map((item) => item.messageCount);
        messageChart.data.labels = labels;
        messageChart.data.datasets[0].data = counts;
        messageChart.update();
        document.getElementById('chartRangeLabel').textContent = labels.length;
        document.getElementById('chartSuccessRate').textContent =
          slice.length > 0 ? `${slice[slice.length - 1].successRate.toFixed(1)}%` : '-';

        const tools = data.usage?.tools || [];
        featureUsageChart.data.labels = tools.map((item) => item.name);
        featureUsageChart.data.datasets[0].data = tools.map((item) => item.total);
        featureUsageChart.update();
      }

      async function refreshHealthStatus() {
        try {
          const response = await fetch('/agent/health');
          const result = await response.json();
          const health = result.data || result;
          updateHealthCard(
            'overallHealthCard',
            'overallHealthStatus',
            'overallHealthMessage',
            health.status === 'healthy' ? 'success' : 'warning',
            health.status === 'healthy' ? 'è¿è¡Œæ­£å¸¸' : 'æœåŠ¡é™çº§',
            health.message || 'Agent æœåŠ¡çŠ¶æ€æœªçŸ¥',
          );

          updateHealthCard(
            'modelHealthCard',
            'modelHealthStatus',
            'modelHealthDetails',
            health.models?.status === 'available' ? 'success' : 'warning',
            health.models?.status === 'available' ? 'æœåŠ¡å¯ç”¨' : 'éœ€å…³æ³¨',
            health.models?.message || 'æ¨¡å‹çŠ¶æ€æ£€æŸ¥ä¸­',
          );

          updateHealthCard(
            'toolHealthCard',
            'toolHealthStatus',
            'toolHealthDetails',
            health.tools?.status === 'healthy' ? 'success' : 'warning',
            health.tools?.status === 'healthy' ? 'å“åº”æ­£å¸¸' : 'å“åº”ç¼“æ…¢',
            health.tools?.message || 'å·¥å…·é“¾æ£€æŸ¥ä¸­',
          );

          updateHealthCard(
            'brandConfigCard',
            'brandConfigStatus',
            'brandConfigDetails',
            health.brandConfig?.status === 'loaded' ? 'success' : 'warning',
            health.brandConfig?.status === 'loaded' ? 'å·²åŠ è½½' : 'æœªåŠ è½½',
            health.brandConfig?.message || 'å“ç‰Œé…ç½®æ£€æŸ¥ä¸­',
          );
        } catch (error) {
          console.error('è·å–å¥åº·çŠ¶æ€å¤±è´¥', error);
        }
      }

      function updateHealthCard(cardId, statusId, descId, state, statusText, desc) {
        const card = document.getElementById(cardId);
        const status = document.getElementById(statusId);
        const descEl = document.getElementById(descId);
        if (!card || !status || !descEl) return;
        card.dataset.state = state;
        status.textContent = statusText;
        descEl.textContent = desc;
      }

      async function clearData() {
        try {
          await fetch('/monitoring/clear', { method: 'POST' });
          await refreshDashboard();
        } catch (error) {
          console.error('æ¸…ç©ºæ•°æ®å¤±è´¥', error);
        }
      }

      function formatTime(timestamp) {
        if (!timestamp) return '-';
        const date = new Date(timestamp);
        return date.toLocaleString('zh-CN', { hour12: false });
      }

      function formatHour(value) {
        return new Date(value).getHours() + ':00';
      }

      function formatDuration(value) {
        if (value === undefined || value === null) return '-';
        if (value < 1000) return `${Math.round(value)} ms`;
        return `${(value / 1000).toFixed(2)} s`;
      }
    </script>
  </body>
</html>
