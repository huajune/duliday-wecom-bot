# Agent æœåŠ¡æ¶æ„æ–‡æ¡£

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

æœ¬æ–‡æ¡£è¯´æ˜**æˆ‘ä»¬çš„æœåŠ¡å¦‚ä½•å°è£…å’Œä½¿ç”¨èŠ±å· Agent API**ã€‚

é…åˆé˜…è¯»ï¼š
- [èŠ±å· Agent API ä½¿ç”¨æŒ‡å—](huajune-agent-api-guide.md) - äº†è§£èŠ±å· API çš„ä½¿ç”¨æ–¹æ³•
- [æ¶ˆæ¯æœåŠ¡æ¶æ„](message-service-architecture.md) - äº†è§£æ¶ˆæ¯å¤„ç†æµç¨‹

**é˜…è¯»é¡ºåºå»ºè®®**:
1. å…ˆè¯»èŠ±å· Agent API ä½¿ç”¨æŒ‡å— - ç†è§£èŠ±å· API
2. å†è¯»æœ¬æ–‡æ¡£ - äº†è§£æˆ‘ä»¬çš„å°è£…å®ç°
3. æœ€åè¯»æ¶ˆæ¯å¤„ç†æ¶æ„ - ç†è§£å®Œæ•´çš„ä¸šåŠ¡æµç¨‹

---

## ç›®å½•
- [1. æ¶æ„æ¦‚è¿°](#1-æ¶æ„æ¦‚è¿°)
- [2. æ ¸å¿ƒç»„ä»¶](#2-æ ¸å¿ƒç»„ä»¶)
- [3. æœåŠ¡èŒè´£](#3-æœåŠ¡èŒè´£)
- [4. æ•°æ®æµ](#4-æ•°æ®æµ)
- [5. é…ç½®ç®¡ç†](#5-é…ç½®ç®¡ç†)
- [6. ç¼“å­˜ç­–ç•¥](#6-ç¼“å­˜ç­–ç•¥)

---

## 1. æ¶æ„æ¦‚è¿°

### 1.1 å››æœåŠ¡æ¶æ„

```
AgentModule
    â†“
AgentController (17ä¸ªHTTPç«¯ç‚¹)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Agent     â”‚   Agent     â”‚   Agent     â”‚   Agent     â”‚
â”‚   Service   â”‚   Config    â”‚  Registry   â”‚   Cache     â”‚
â”‚ (APIè°ƒç”¨)   â”‚  (é…ç½®ç®¡ç†)  â”‚  (æ³¨å†Œè¡¨)   â”‚  (ç¼“å­˜)     â”‚
â”‚  461è¡Œ      â”‚   500è¡Œ     â”‚   402è¡Œ     â”‚   336è¡Œ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                  å¤–éƒ¨ Agent API æœåŠ¡
```

### 1.2 æ–‡ä»¶ç»“æ„

```
src/agent/
â”œâ”€â”€ agent.module.ts              # æ¨¡å—å®šä¹‰
â”œâ”€â”€ agent.controller.ts          # HTTP æ§åˆ¶å™¨
â”œâ”€â”€ agent.service.ts             # æ ¸å¿ƒAPIè°ƒç”¨æœåŠ¡ï¼ˆ461è¡Œï¼‰
â”œâ”€â”€ agent-config.service.ts      # é…ç½®æ¡£æ¡ˆç®¡ç†ï¼ˆ500è¡Œï¼‰
â”œâ”€â”€ agent-registry.service.ts    # æ¨¡å‹/å·¥å…·æ³¨å†Œè¡¨ï¼ˆ402è¡Œï¼‰
â”œâ”€â”€ agent-cache.service.ts       # ç¼“å­˜ç®¡ç†æœåŠ¡ï¼ˆ336è¡Œï¼‰
â”œâ”€â”€ context/                     # é…ç½®æ–‡ä»¶ç›®å½•
â”‚   â””â”€â”€ candidate-consultation/  # å€™é€‰äººå’¨è¯¢åœºæ™¯
â”‚       â”œâ”€â”€ profile.json         # åœºæ™¯å…ƒä¿¡æ¯
â”‚       â”œâ”€â”€ system-prompt.md     # ç³»ç»Ÿæç¤ºè¯
â”‚       â”œâ”€â”€ context.json         # ä¸Šä¸‹æ–‡é…ç½®
â”‚       â””â”€â”€ tool-context.json    # å·¥å…·ä¸Šä¸‹æ–‡
â”œâ”€â”€ dto/                         # æ•°æ®ä¼ è¾“å¯¹è±¡
â”œâ”€â”€ exceptions/                  # è‡ªå®šä¹‰å¼‚å¸¸
â””â”€â”€ interfaces/                  # TypeScript æ¥å£
```

---

## 2. æ ¸å¿ƒç»„ä»¶

### 2.1 AgentService (API è°ƒç”¨å±‚)

**ä½ç½®**: [src/agent/agent.service.ts](../src/agent/agent.service.ts)
**ä»£ç é‡**: 461 è¡Œ

#### æ ¸å¿ƒèŒè´£
1. **HTTP å®¢æˆ·ç«¯ç®¡ç†** - ä½¿ç”¨å·¥å‚æ¨¡å¼åˆ›å»º Axios å®ä¾‹
2. **API è°ƒç”¨å°è£…** - æä¾› `chat()`, `getModels()`, `getTools()` ç­‰æ–¹æ³•
3. **è¯·æ±‚é‡è¯•æœºåˆ¶** - æŒ‡æ•°é€€é¿ç­–ç•¥ï¼Œæœ€å¤šé‡è¯• 3 æ¬¡
4. **Token ä½¿ç”¨ç»Ÿè®¡** - è®°å½•è¾“å…¥/è¾“å‡º/ç¼“å­˜ Token æ•°é‡

#### å…³é”®æ–¹æ³•
```typescript
async chat(params: {
  conversationId: string;
  userMessage: string;
  historyMessages?: SimpleMessage[];
  model?: string;
  systemPrompt?: string;
  allowedTools?: string[];
  context?: any;
}): Promise<ChatResponse>

async chatWithProfile(
  conversationId: string,
  userMessage: string,
  profile: AgentProfile,
  overrides?: Partial<AgentProfile>
): Promise<ChatResponse>
```

#### é‡è¯•ç­–ç•¥

| é”™è¯¯ç±»å‹ | é‡è¯•è¡Œä¸º | å»¶è¿Ÿç­–ç•¥ |
|---------|---------|---------|
| **429 é¢‘ç‡é™åˆ¶** | é‡è¯•ï¼Œæœ€å¤š 3 æ¬¡ | æ ¹æ® `Retry-After` å¤´ |
| **500/502/503** | é‡è¯•ï¼Œæœ€å¤š 3 æ¬¡ | æŒ‡æ•°é€€é¿ (1s, 2s, 4s) |
| **400/401/403** | ä¸é‡è¯• | ç«‹å³å¤±è´¥ |
| **ç½‘ç»œé”™è¯¯** | é‡è¯•ï¼Œæœ€å¤š 3 æ¬¡ | æŒ‡æ•°é€€é¿ |

---

### 2.2 AgentConfigService (é…ç½®ç®¡ç†)

**ä½ç½®**: [src/agent/agent-config.service.ts](../src/agent/agent-config.service.ts)
**ä»£ç é‡**: 500 è¡Œ

#### æ ¸å¿ƒèŒè´£
1. **æ–‡ä»¶ç³»ç»ŸåŠ è½½** - ä» `context/` ç›®å½•åŠ è½½é…ç½®æ–‡ä»¶
2. **åœºæ™¯é…ç½®ç®¡ç†** - æ”¯æŒå¤šåœºæ™¯ï¼ˆå€™é€‰äººå’¨è¯¢ã€å®¢æœç­‰ï¼‰
3. **ç¯å¢ƒå˜é‡è§£æ** - æ”¯æŒ `${VAR_NAME}` è¯­æ³•
4. **é…ç½®éªŒè¯** - æ£€æŸ¥æ¨¡å‹å’Œå·¥å…·çš„å¯ç”¨æ€§
5. **è¿è¡Œæ—¶æ›´æ–°** - æ”¯æŒçƒ­é‡è½½é…ç½®

#### é…ç½®æ–‡ä»¶ç»“æ„

```json
// context/candidate-consultation/profile.json
{
  "name": "candidate-consultation",
  "description": "å€™é€‰äººç§èŠå’¨è¯¢æœåŠ¡",
  "model": "${AGENT_DEFAULT_MODEL}",
  "allowedTools": ["duliday_job_list", "duliday_job_details"],
  "contextStrategy": "skip",
  "prune": true,
  "pruneOptions": {
    "targetTokens": 8000,
    "preserveRecentMessages": 5
  },
  "files": {
    "systemPrompt": "system-prompt.md",
    "context": "context.json",
    "toolContext": "tool-context.json"
  }
}
```

#### é™çº§å¤„ç†

å½“é…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥æ—¶ï¼Œè‡ªåŠ¨ä½¿ç”¨ç¯å¢ƒå˜é‡åˆ›å»º**æœ€å°åŒ–é™çº§é…ç½®**ï¼š
- âœ… æç®€ systemPromptï¼ˆåªæœ‰æ ¸å¿ƒèŒè´£ï¼‰
- âœ… æœ€å°åŒ– contextï¼ˆåªæœ‰å¿…éœ€çš„ tokenï¼‰
- âš ï¸ åŠŸèƒ½å—é™ï¼Œå»ºè®®å°½å¿«ä¿®å¤é…ç½®æ–‡ä»¶

---

### 2.3 AgentRegistryService (æ³¨å†Œè¡¨æœåŠ¡)

**ä½ç½®**: [src/agent/agent-registry.service.ts](../src/agent/agent-registry.service.ts)
**ä»£ç é‡**: 402 è¡Œ

#### æ ¸å¿ƒèŒè´£
1. **æ¨¡å‹æ³¨å†Œè¡¨** - ç®¡ç†å¯ç”¨çš„ AI æ¨¡å‹åˆ—è¡¨
2. **å·¥å…·æ³¨å†Œè¡¨** - ç®¡ç† Agent å¯ç”¨çš„å·¥å…·ï¼ˆå‡½æ•°è°ƒç”¨ï¼‰
3. **å¥åº·æ£€æŸ¥** - å®šæœŸæ£€æŸ¥ Agent API å¯ç”¨æ€§ï¼ˆå¯é€‰ï¼‰
4. **èµ„æºéªŒè¯** - éªŒè¯è¯·æ±‚çš„æ¨¡å‹/å·¥å…·æ˜¯å¦å¯ç”¨

#### æ¨¡å‹éªŒè¯æµç¨‹

```typescript
validateModel(requestedModel?: string): string {
  // 1. æœªæŒ‡å®šæ¨¡å‹ â†’ ä½¿ç”¨é»˜è®¤æ¨¡å‹
  // 2. æ¨¡å‹åœ¨å¯ç”¨åˆ—è¡¨ä¸­ â†’ ç›´æ¥ä½¿ç”¨
  // 3. æ¨¡å‹ä¸å¯ç”¨ â†’ å›é€€åˆ°é»˜è®¤æ¨¡å‹ï¼ˆè®°å½•è­¦å‘Šï¼‰
}
```

---

### 2.4 AgentCacheService (ç¼“å­˜ç®¡ç†)

**ä½ç½®**: [src/agent/agent-cache.service.ts](../src/agent/agent-cache.service.ts)
**ä»£ç é‡**: 336 è¡Œ
**åç«¯**: Upstash Redis

#### æ ¸å¿ƒèŒè´£
1. **æ™ºèƒ½ç¼“å­˜åˆ¤æ–­** - åˆ¤æ–­å“åº”æ˜¯å¦åº”è¯¥ç¼“å­˜
2. **ç¼“å­˜é”®ç”Ÿæˆ** - åŸºäºè¯·æ±‚å‚æ•°ç”Ÿæˆå”¯ä¸€é”®
3. **TTL ç®¡ç†** - ä¸åŒåœºæ™¯ä½¿ç”¨ä¸åŒè¿‡æœŸæ—¶é—´
4. **ç¼“å­˜æ¸…ç†** - æ”¯æŒæ‰‹åŠ¨æ¸…ç†å’Œè‡ªåŠ¨è¿‡æœŸ

#### ç¼“å­˜ç­–ç•¥

| æ¡ä»¶ | æ˜¯å¦ç¼“å­˜ | TTL | åŸå›  |
|------|---------|-----|------|
| **ä½¿ç”¨äº†å·¥å…·** | âŒ å¦ | - | å·¥å…·è¿”å›åŠ¨æ€æ•°æ® |
| **åŒ…å«ä¸Šä¸‹æ–‡** | âŒ å¦ | - | ä¸Šä¸‹æ–‡å¯èƒ½å˜åŒ– |
| **çº¯æ–‡æœ¬å¯¹è¯** | âœ… æ˜¯ | 3600ç§’ | å“åº”ç¨³å®š |

#### ç¼“å­˜é”®ç”Ÿæˆ

```typescript
generateCacheKey(params: {
  model: string;
  messages: SimpleMessage[];
  tools?: string[];
  context?: any;
}): string {
  // 1. æå–å…³é”®å­—æ®µ
  // 2. åºåˆ—åŒ–ä¸º JSON
  // 3. è®¡ç®— MD5 å“ˆå¸Œ
  // 4. æ·»åŠ å‰ç¼€ "agent:chat:"
  return `agent:chat:${md5Hash}`;
}
```

---

## 3. æœåŠ¡èŒè´£

### 3.1 èŒè´£åˆ†ç¦»åŸåˆ™

| æœåŠ¡ | æ ¸å¿ƒèŒè´£ | ä¸è´Ÿè´£çš„äº‹æƒ… |
|------|---------|-------------|
| **AgentService** | API è°ƒç”¨ã€é‡è¯•ã€æ—¥å¿— | âŒ é…ç½®ç®¡ç†ã€âŒ ç¼“å­˜é€»è¾‘ã€âŒ å¥åº·æ£€æŸ¥ |
| **AgentConfigService** | é…ç½®åŠ è½½ã€åœºæ™¯ç®¡ç† | âŒ API è°ƒç”¨ã€âŒ æ¨¡å‹éªŒè¯ |
| **AgentRegistryService** | èµ„æºæ³¨å†Œã€éªŒè¯ | âŒ API è°ƒç”¨ã€âŒ é…ç½®åŠ è½½ |
| **AgentCacheService** | ç¼“å­˜ç®¡ç†ã€é”®ç”Ÿæˆ | âŒ API è°ƒç”¨ã€âŒ ä¸šåŠ¡é€»è¾‘ |

### 3.2 ä¾èµ–å…³ç³»å›¾

```
AgentController
       â†“
AgentService â†â”€â”¬â”€â†’ AgentCacheService
               â”‚
               â”œâ”€â†’ AgentRegistryService
               â”‚
               â””â”€â†’ AgentConfigService â”€â”€â†’ AgentRegistryService
```

> **æ³¨æ„**: `AgentService` å’Œ `AgentRegistryService` ä¹‹é—´æœ‰å¾ªç¯ä¾èµ–ï¼Œå·²é€šè¿‡ `forwardRef` è§£å†³ã€‚

---

## 4. æ•°æ®æµ

### 4.1 å®Œæ•´çš„èŠå¤©è¯·æ±‚æµç¨‹

```
1. æ¥æ”¶è¯·æ±‚
   POST /agent/chat
        â†“
2. å‚æ•°éªŒè¯ (AgentService)
   - æ£€æŸ¥æ¶ˆæ¯ä¸ä¸ºç©º
   - éªŒè¯æ¨¡å‹å¯ç”¨æ€§ (å§”æ‰˜ç»™ RegistryService)
   - éªŒè¯å·¥å…·å¯ç”¨æ€§ (å§”æ‰˜ç»™ RegistryService)
        â†“
3. ç¼“å­˜æŸ¥æ‰¾ (AgentCacheService)
   - ç”Ÿæˆç¼“å­˜é”® (åŸºäº model + messages + tools)
   - æŸ¥è¯¢ Redis ç¼“å­˜
   - å‘½ä¸­ â†’ ç›´æ¥è¿”å›ï¼ˆè·³åˆ°æ­¥éª¤ 7ï¼‰
        â†“
4. è°ƒç”¨ Agent API
   POST {AGENT_API_BASE_URL}/chat
   Headers: { Authorization: Bearer {API_KEY} }
        â†“
5. é”™è¯¯å¤„ç†ä¸é‡è¯•
   - 429 â†’ æ ¹æ® Retry-After å»¶è¿Ÿé‡è¯•
   - 5xx â†’ æŒ‡æ•°é€€é¿é‡è¯• (1s, 2s, 4s)
   - 4xx â†’ ç«‹å³å¤±è´¥
   - æœ€å¤šé‡è¯• 3 æ¬¡
        â†“
6. å“åº”å¤„ç†
   - æå– correlationId
   - è®°å½• Token ä½¿ç”¨ç»Ÿè®¡
   - åˆ¤æ–­æ˜¯å¦ç¼“å­˜ï¼ˆå§”æ‰˜ç»™ CacheServiceï¼‰
   - å†™å…¥ç¼“å­˜ï¼ˆå¦‚æœé€‚ç”¨ï¼‰
        â†“
7. è¿”å›ç»“æœ
   ChatResponse: { message, usage, tools, correlationId }
```

### 4.2 é…ç½®åŠ è½½æµç¨‹

```
åº”ç”¨å¯åŠ¨
    â†“
AgentConfigService.onModuleInit()
    â†“
åŠ è½½æ‰€æœ‰é…ç½®æ¡£æ¡ˆ
context/candidate-consultation/
â”œâ”€â”€ profile.json â”€â”€â”€â”€â†’ è§£æå…ƒä¿¡æ¯
â”œâ”€â”€ system-prompt.md â”€â†’ è¯»å–ç³»ç»Ÿæç¤ºè¯
â”œâ”€â”€ context.json â”€â”€â”€â”€â”€â†’ è§£æä¸Šä¸‹æ–‡ + ç¯å¢ƒå˜é‡æ›¿æ¢
â””â”€â”€ tool-context.json â†’ è§£æå·¥å…·ä¸Šä¸‹æ–‡
    â†“
éªŒè¯é…ç½®
- æ£€æŸ¥æ¨¡å‹æ˜¯å¦å¯ç”¨
- æ£€æŸ¥å·¥å…·æ˜¯å¦å¯ç”¨
- æ£€æŸ¥å·¥å…·æ‰€éœ€çš„ä¸Šä¸‹æ–‡æ˜¯å¦æä¾›
    â†“
æ³¨å†Œåˆ°å†…å­˜
Map<string, AgentProfile>
```

---

## 5. é…ç½®ç®¡ç†

### 5.1 ç¯å¢ƒå˜é‡

| å˜é‡å | å¿…éœ€ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `AGENT_API_KEY` | âœ… | - | Agent API å¯†é’¥ |
| `AGENT_API_BASE_URL` | âœ… | - | Agent API åŸºç¡€ URL |
| `AGENT_DEFAULT_MODEL` | âœ… | - | é»˜è®¤ AI æ¨¡å‹ |
| `AGENT_API_TIMEOUT` | âŒ | `120000` | API è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ |
| `AGENT_ALLOWED_TOOLS` | âŒ | `""` | å…è®¸çš„å·¥å…·åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰ |
| `ENABLE_AGENT_HEALTH_CHECK` | âŒ | `false` | æ˜¯å¦å¯ç”¨å¥åº·æ£€æŸ¥ |

### 5.2 é…ç½®æ¡£æ¡ˆå­—æ®µ

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `name` | `string` | åœºæ™¯å”¯ä¸€æ ‡è¯†ç¬¦ |
| `description` | `string` | åœºæ™¯æè¿° |
| `model` | `string` | ä½¿ç”¨çš„ AI æ¨¡å‹ï¼ˆæ”¯æŒç¯å¢ƒå˜é‡ï¼‰ |
| `allowedTools` | `string[]` | å…è®¸çš„å·¥å…·åˆ—è¡¨ |
| `contextStrategy` | `'skip' \| 'error' \| 'report'` | ä¸Šä¸‹æ–‡ç¼ºå¤±æ—¶çš„å¤„ç†ç­–ç•¥ |
| `prune` | `boolean` | æ˜¯å¦å¯ç”¨æ¶ˆæ¯è£å‰ªï¼ˆèŠ‚çœ Tokenï¼‰ |
| `pruneOptions` | `object` | è£å‰ªé…ç½® |

---

## 6. ç¼“å­˜ç­–ç•¥

### 6.1 ç¼“å­˜æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Upstash Redis                  â”‚
â”‚  agent:chat:{hash}                        â”‚
â”‚  TTL: 3600s                               â”‚
â”‚  Value: ChatResponse (JSON)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†‘
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        AgentCacheService                  â”‚
â”‚  - shouldCache(params) â†’ boolean          â”‚
â”‚  - generateCacheKey(params) â†’ string      â”‚
â”‚  - get(key) â†’ ChatResponse | null         â”‚
â”‚  - set(key, value, ttl?) â†’ void           â”‚
â”‚  - clear(pattern?) â†’ void                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 ç¼“å­˜åˆ¤æ–­é€»è¾‘

```typescript
shouldCache(params: {
  usedTools?: string[];
  context?: any;
  toolContext?: any;
}): boolean {
  // 1. ä½¿ç”¨äº†å·¥å…· â†’ ä¸ç¼“å­˜ï¼ˆå·¥å…·è¿”å›åŠ¨æ€æ•°æ®ï¼‰
  if (usedTools && usedTools.length > 0) {
    return false;
  }

  // 2. åŒ…å«ä¸Šä¸‹æ–‡ â†’ ä¸ç¼“å­˜ï¼ˆä¸Šä¸‹æ–‡å¯èƒ½å˜åŒ–ï¼‰
  if (context || toolContext) {
    return false;
  }

  // 3. çº¯æ–‡æœ¬å¯¹è¯ â†’ ç¼“å­˜
  return true;
}
```

### 6.3 æ€§èƒ½ä¼˜åŒ–

| ä¼˜åŒ–ç‚¹ | è¯´æ˜ | æ”¶ç›Š |
|--------|------|------|
| **ç¼“å­˜å‘½ä¸­** | é¿å…è°ƒç”¨ Agent API | èŠ‚çœ API æˆæœ¬ + é™ä½å»¶è¿Ÿ |
| **æ™ºèƒ½åˆ¤æ–­** | åªç¼“å­˜ç¨³å®šçš„å“åº” | æé«˜ç¼“å­˜å‘½ä¸­ç‡ |
| **è‡ªåŠ¨è¿‡æœŸ** | Redis TTL è‡ªåŠ¨æ¸…ç† | é¿å…è¿‡æœŸæ•°æ® |

---

## 7. é”™è¯¯å¤„ç†

### 7.1 è‡ªå®šä¹‰å¼‚å¸¸ç±»å‹

| å¼‚å¸¸ç±» | HTTP çŠ¶æ€ç  | è¯´æ˜ |
|--------|------------|------|
| `AgentApiException` | 502 | Agent API è°ƒç”¨å¤±è´¥ |
| `AgentConfigException` | 500 | é…ç½®é”™è¯¯ |
| `AgentContextMissingException` | 400 | ç¼ºå°‘å¿…éœ€çš„ä¸Šä¸‹æ–‡ |
| `AgentRateLimitException` | 429 | è¯·æ±‚é¢‘ç‡è¿‡é«˜ |

### 7.2 é”™è¯¯å“åº”æ ¼å¼

```typescript
{
  "statusCode": 400,
  "message": "å·¥å…· duliday_job_list ç¼ºå°‘å¿…éœ€çš„ä¸Šä¸‹æ–‡",
  "error": "Bad Request",
  "details": {
    "missingContext": ["dulidayToken"],
    "tools": ["duliday_job_list"]
  }
}
```

---

## 8. æ€»ç»“

Agent æœåŠ¡é€šè¿‡**èŒè´£åˆ†ç¦»**å’Œ**ä¾èµ–æ³¨å…¥**å®ç°äº†é«˜å†…èšã€ä½è€¦åˆçš„æ¶æ„è®¾è®¡ï¼š

| æœåŠ¡ | ä»£ç é‡ | æ ¸å¿ƒèŒè´£ |
|------|--------|---------|
| `AgentService` | 461 è¡Œ | API è°ƒç”¨ã€é‡è¯•ã€æ—¥å¿— |
| `AgentConfigService` | 500 è¡Œ | é…ç½®ç®¡ç†ã€åœºæ™¯ç®¡ç† |
| `AgentRegistryService` | 402 è¡Œ | èµ„æºæ³¨å†Œã€éªŒè¯ |
| `AgentCacheService` | 336 è¡Œ | ç¼“å­˜ç®¡ç†ã€é”®ç”Ÿæˆ |

æ€»è®¡çº¦ **1,700 è¡Œ**æ ¸å¿ƒä¸šåŠ¡ä»£ç ï¼Œæ”¯æŒï¼š
- âœ… 17 ä¸ª HTTP API ç«¯ç‚¹
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- âœ… æ™ºèƒ½ç¼“å­˜ç­–ç•¥ï¼ˆèŠ‚çœ API æˆæœ¬ï¼‰
- âœ… å¤šåœºæ™¯é…ç½®ç®¡ç†
- âœ… å¥åº·æ£€æŸ¥å’Œç›‘æ§

---

**æœ€åæ›´æ–°**: 2025-11-04
