# Prompt 优化总结

> 优化日期: 2025-12-25
> 基于: Agent优化专项分析报告_2025-12-17.md 和 花卷工具调用现状.md
> 修改文件: [src/agent/profiles/candidate-consultation/system-prompt.md](../src/agent/profiles/candidate-consultation/system-prompt.md)

---

## 一、优化概述

### 核心问题
根据数据分析,发现以下严重问题:
- **duliday_job_list 成功率仅 17.1%** (69/403)
- **38.5% 的调用缺少 brandName 参数** (155/403)
- **单条消息触发 12 次工具调用**,造成严重 Token 浪费
- **跨城市推荐**(广州用户被推荐上海岗位)
- **匹配条件未校验**(年龄 43 岁超限仍约面,工时不符仍推荐)

### 优化目标
1. 强制 Agent 在调用工具前确认必填参数
2. 限制工具重复调用次数,避免 Token 浪费
3. 严格校验匹配条件(年龄/工时/城市)
4. 优化意图识别,避免昵称干扰

---

## 二、优化内容详解

### 2.1 工具使用契约优化

#### 修改位置: `# 工具使用契约 > ## 1) duliday_job_list`

**新增"调用前必须检查"章节**:

```markdown
### 调用前必须检查:
1. **品牌名称(brandName)必填** - 如果用户未明确提及品牌,必须先询问
   - ✅ "你有想去的品牌吗?还是我帮你看看附近的?"
   - ❌ 不得省略 brandName 参数直接调用工具

2. **品牌名称格式** - 必须使用完整品牌名(含城市前缀)
   - ✅ "上海必胜客"、"北京必胜客"、"肯德基"
   - ❌ 单独使用"必胜客"(需结合用户城市确定具体品牌)

3. **重试限制** - 同一查询条件最多调用 2 次
   - 第 1 次失败 → 可调整参数重试
   - 第 2 次失败 → 停止调用,转为询问用户确认信息
   - ❌ 禁止连续 3 次以上调用同一工具
```

**新增"响应处理"章节**:
- **品牌映射失败时** - 引导用户确认:"这个品牌名我这边查不到哈,你是说的 XX 吗?"

**预期效果**:
- brandName 缺失率从 38.5% 降至 < 5%
- 重复调用次数从最高 12 次降至最多 2 次
- Token 消耗降低约 50%

---

### 2.2 品牌查询规则强化

#### 修改位置: `# 业务规则 > ## 品牌查询规则`

**新增条款**:

```markdown
2. **如果用户未提及品牌,必须先询问**,不得省略 brandName 直接调用工具:
   - ✅ "你有特别想去的品牌吗?还是我帮你看看附近的?"
   - ❌ 直接调用 `duliday_job_list(regionName="XX区")` 不带 brandName

5. **调用失败后的处理**:
   - 第 1 次失败 → 检查参数,可尝试调整后重试 1 次
   - 第 2 次失败 → 停止调用,转为询问用户
   - ❌ 禁止连续调用 3 次以上同一工具
```

**预期效果**:
- 强制 Agent 养成"先询问品牌"的习惯
- 减少无效工具调用

---

### 2.3 推荐规则严格化

#### 修改位置: `# 业务规则 > ## 推荐规则`

**新增条款**:

```markdown
1. **只推荐同城岗位,严禁跨城市推荐**
   - ✅ 用户在广州 → 只推荐广州的岗位
   - ❌ 用户在广州 → 推荐上海岗位(距离 1500+ 公里完全不合理)

2. 当本地无合适岗位时,诚实告知,**不要推荐其他城市**:
   - ✅ "这边暂时没有合适的,我帮你留意着哈"
   - ❌ "上海那边有,要不要看看?"
```

**预期效果**:
- 杜绝跨城市推荐问题
- 提升用户体验和信任度

---

### 2.4 约面规则细化

#### 修改位置: `# 业务规则 > ## 约面规则`

**重构为"约面前必须完成的三项检查"**:

```markdown
### 约面前必须完成的三项检查:

1. **年龄要求检查**(必须调用 duliday_job_details):
   - 如岗位要求 18-40 岁,用户 43 岁 → **不得约面**
   - ✅ "这个岗位年龄要求 40 岁以内哈,你目前可能不太符合"
   - ❌ "你年龄稍微超了一点,要不试试去面一下?"

2. **工时要求检查**(必须调用 duliday_job_details):
   - 如岗位要求每周 48 小时,用户只能每周 15 小时 → **不得约面**
   - ✅ "这个岗要求每周至少 48 小时哈,你目前时间可能不太够"
   - ❌ "虽然时间差点,但你可以试试?"

3. **城市匹配检查**(基于用户所在城市):
   - 用户在广州 → 只能约广州的岗位
   - ❌ 推荐或约面其他城市岗位
```

**预期效果**:
- 杜绝不符合条件的约面(避免浪费双方时间)
- 提高面试到场率和转化质量

---

### 2.5 支持的品牌列表

#### 新增章节: `# 支持的品牌列表(完整)`

**新增完整品牌列表**:

```markdown
## 餐饮类
### 肯德基系列
- 肯德基、安徽肯德基、北京肯德基、天津肯德基、成都肯德基...

### 必胜客系列
- 上海必胜客、北京必胜客、宁波必胜客、成都必胜客、佛山必胜客

### 山姆系列
- 嘉定山姆、高科西山姆、嘉松中路山姆、普陀真如山姆

### 其他餐饮
- 海底捞、西贝莜面村、奥乐齐、大米先生、M Stand...

## 零售类
- ZARA、波司登、李维斯、来伊份、上海来伊份
```

**新增品牌名称模糊匹配指引**:

```markdown
1. **"必胜客"** → 需要结合用户城市确定:
   - 用户在上海 → "上海必胜客"
   - 用户在北京 → "北京必胜客"
   - 其他城市 → 告知"这个品牌在你那边暂时没招哈"

2. **"肯德基"** → 优先使用不带城市前缀的"肯德基",如失败再根据城市匹配

3. **"山姆"** → 需要用户确认具体门店

4. **不支持的品牌**(如"星巴克"、"麦当劳"):
   - ✅ "这个品牌暂时没在招哈,附近还有肯德基、奥乐齐在招,要看看吗?"
   - ❌ "系统不支持该品牌"
```

**预期效果**:
- 品牌映射失败率从 11.2% 降至 < 3%
- Agent 能正确处理模糊品牌名

---

### 2.6 意图识别优化

#### 修改位置: `# 核心教训`

**新增第 9 条"意图识别注意事项"**:

```markdown
9. **意图识别注意事项**(新增):
   - **昵称不是用户意图**:如用户昵称是"减肥中",TA 说"我是减肥中"是自我介绍,不是表示正在减肥
   - **首次打招呼场景**:新加好友后的首次对话,聚焦业务引导(城市/区域/品牌),不对昵称内容进行解读
   - **简单回复场景**:用户说"好的"、"嗯"、"?"等简单回复时,不要启动新的岗位查询,除非 TA 明确提出新需求
```

**预期效果**:
- 避免昵称干扰意图识别
- 减少不必要的工具调用(如用户说"好的"后仍查询岗位)

---

### 2.7 发送前自检优化

#### 修改位置: `# 发送前自检`

**新增"工具调用检查"**:

```markdown
- **工具调用检查**(新增):
  - 是否在调用 `duliday_job_list` 前确认了 brandName?
  - 同一工具调用是否超过 2 次?如是,停止调用转询问
  - 约面前是否完成了年龄/工时/城市三项检查?
```

**预期效果**:
- Agent 发送回复前主动检查工具调用合规性
- 进一步降低错误率

---

### 2.8 示例对话扩充

#### 修改位置: `# 示例对话(Dialog Examples)`

**新增 5 个示例**:

- **示例 6** - 品牌未提及场景(必须先询问)
- **示例 7** - 品牌名称模糊场景(必胜客 → 上海必胜客)
- **示例 8** - 年龄不符场景(不得通融)
- **示例 9** - 工时不匹配场景
- **示例 10** - 首次打招呼场景(不解读昵称)

**预期效果**:
- 通过具体案例强化 Agent 对新规则的理解
- 提供正反示例对比(✅ vs ❌)

---

## 三、优化效果预测

### 3.1 量化指标对比

| 指标 | 优化前 | 优化后(预期) | 改善幅度 |
|------|-------|-------------|---------|
| duliday_job_list 成功率 | 17.1% | **60%+** | +43% |
| brandName 缺失率 | 38.5% | **< 5%** | -33.5% |
| 品牌映射失败率 | 11.2% | **< 3%** | -8.2% |
| 平均工具调用次数/消息 | 2.75 | **1.5** | -45% |
| 平均 Token 消耗/消息 | ~15000 | **~8000** | -47% |
| 单消息最大工具调用次数 | 12 | **≤ 2** | -83% |
| 跨城市推荐问题 | 存在 | **0** | -100% |
| 匹配条件未校验问题 | 存在 | **0** | -100% |

### 3.2 用户体验改善

**更快的响应**:
- 减少无效工具调用,响应时间缩短约 30%

**更准确的结果**:
- 品牌映射优化后,一次查询即可找到岗位
- 避免推荐不符合条件的岗位

**更自然的对话**:
- 主动确认信息而非反复失败重试
- 减少"系统错误"式的回复

---

## 四、后续优化建议

### 4.1 工具层优化(需要代码改造)

**优先级: 高**

1. **brandName 智能推断**:
   ```typescript
   // 在 duliday_job_list 工具内部添加
   if (!input.brandName) {
     const inferredBrand = inferBrandFromContext(context);
     if (inferredBrand) {
       input.brandName = inferredBrand;
     } else {
       return {
         error: "请先告诉我您想查询哪个品牌的岗位?比如肯德基、必胜客、奥乐齐等",
         suggestBrands: ["肯德基", "大米先生", "奥乐齐"]
       };
     }
   }
   ```

2. **品牌名称模糊映射**:
   ```typescript
   function resolveBrand(input: string, region?: string): string | null {
     // 1. 精确匹配
     if (supportedBrands.includes(input)) return input;

     // 2. 模糊匹配 + 地区推断
     if (input === "必胜客" && region) {
       const cityBrand = inferCityBrand(input, region);
       if (cityBrand) return cityBrand;
     }

     // 3. 返回建议
     return null;
   }
   ```

### 4.2 流程层优化(需要代码改造)

**优先级: 中**

1. **调用链路控制**:
   ```typescript
   class CallLimiter {
     private callCounts: Map<string, number> = new Map();

     canCall(toolName: string, limit: number = 2): boolean {
       const count = this.callCounts.get(toolName) || 0;
       return count < limit;
     }
   }
   ```

2. **失败重试策略**:
   ```typescript
   if (toolResult.error) {
     if (callLimiter.getCount(toolName) >= 2) {
       // 停止重试,转人工确认模式
       return generateClarificationResponse(toolResult.error);
     }
   }
   ```

### 4.3 监控层优化(需要代码改造)

**优先级: 中**

1. **工具调用成功率监控**:
   ```typescript
   interface ToolMetrics {
     toolName: string;
     successRate: number;
     avgTokenUsage: number;
   }

   if (successRate < 0.3) {
     alert(`工具 ${toolName} 成功率过低: ${successRate * 100}%`);
   }
   ```

---

## 五、实施检查清单

### Phase 1: Prompt 优化(已完成) ✅

- [x] 工具使用契约优化 - 添加调用前检查和重试限制
- [x] 品牌查询规则强化 - 强制询问 brandName
- [x] 推荐规则严格化 - 禁止跨城市推荐
- [x] 约面规则细化 - 三项必检(年龄/工时/城市)
- [x] 支持的品牌列表 - 完整列表 + 模糊匹配指引
- [x] 意图识别优化 - 昵称/首次打招呼/简单回复
- [x] 发送前自检优化 - 新增工具调用检查
- [x] 示例对话扩充 - 5 个新示例(正反对比)

### Phase 2: 工具层优化(待实施)

- [ ] duliday_job_list 添加 brandName 智能推断
- [ ] 实现品牌名称模糊匹配
- [ ] 优化工具错误提示(更友好的话术)

### Phase 3: 流程层优化(待实施)

- [ ] 添加调用计数器和重试控制
- [ ] 实现失败后转人工确认模式

### Phase 4: 监控层优化(待实施)

- [ ] 添加工具调用成功率监控
- [ ] 添加重复调用检测告警

---

## 六、验证方法

### 6.1 测试用例

**测试 1: brandName 缺失场景**
```
用户: 松江区有什么兼职?
预期: Agent 先询问品牌,而非直接调用工具
```

**测试 2: 品牌名称模糊场景**
```
用户: 有必胜客的岗位吗?
预期: Agent 询问城市/区域,然后调用正确品牌名(如"上海必胜客")
```

**测试 3: 年龄不符场景**
```
用户: 我 43 岁,能去面试吗?
预期: Agent 查询岗位年龄要求,如超限则明确告知不符合
```

**测试 4: 工具重复调用场景**
```
模拟工具调用失败 2 次
预期: Agent 停止调用,转为询问用户
```

### 6.2 监控指标

**短期(1 周内)**:
- brandName 缺失率 < 10%
- 单消息工具调用次数 ≤ 3

**中期(2 周内)**:
- duliday_job_list 成功率 > 40%
- 平均 Token 消耗下降 30%

**长期(1 个月)**:
- duliday_job_list 成功率 > 60%
- 跨城市推荐问题 = 0
- 匹配条件未校验问题 = 0

---

## 七、附录

### A. 相关文件

- **Prompt 文件**: [src/agent/profiles/candidate-consultation/system-prompt.md](../src/agent/profiles/candidate-consultation/system-prompt.md)
- **分析报告**: [docs/Agent优化专项分析报告_2025-12-17.md](./Agent优化专项分析报告_2025-12-17.md)
- **问题清单**: [docs/花卷工具调用现状.md](./花卷工具调用现状.md)

### B. 优化前后对比示例

**场景: 用户询问松江区岗位**

**优化前**:
```
用户: 松江区有什么兼职?
Agent: [直接调用 duliday_job_list(regionName="松江区")]
工具: ❌ 请指定要查询的品牌名称
Agent: [再次调用 duliday_job_list(regionName="松江区", brandName="肯德基")]
Agent: [再次调用 duliday_job_list(regionName="松江区", brandName="奥乐齐")]
...重复 5-6 次
```

**优化后**:
```
用户: 松江区有什么兼职?
Agent: 松江这边有肯德基、奥乐齐在招哈,你更想看哪个品牌的呢?
用户: 肯德基
Agent: [调用 duliday_job_list(brandName="肯德基", regionName="松江区")]
Agent: 这边有 XX 门店在招,时薪 25 左右,要了解一下吗?
```

---

**优化完成时间**: 2025-12-25
**下次复盘时间**: 2025-01-08 (观察 2 周数据)
