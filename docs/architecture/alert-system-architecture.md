# å‘Šè­¦ç³»ç»Ÿæ¶æ„è®¾è®¡

> DuLiDay ä¼ä¸šå¾®ä¿¡æœåŠ¡ - å‘Šè­¦ä¸é€šçŸ¥ç³»ç»Ÿ

**æœ€åæ›´æ–°**ï¼š2025-11-25

---

## ç›®å½•

1. [æ¶æ„æ¦‚è§ˆ](#æ¶æ„æ¦‚è§ˆ)
2. [å‘Šè­¦ç±»å‹](#å‘Šè­¦ç±»å‹)
3. [æœåŠ¡ç»„ä»¶](#æœåŠ¡ç»„ä»¶)
4. [æ•°æ®æµè¯¦è§£](#æ•°æ®æµè¯¦è§£)
5. [é…ç½®æŒ‡å—](#é…ç½®æŒ‡å—)
6. [å‘Šè­¦å±•ç¤º](#å‘Šè­¦å±•ç¤º)
7. [API æ¥å£](#api-æ¥å£)
8. [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

---

## æ¶æ„æ¦‚è§ˆ

å‘Šè­¦ç³»ç»Ÿé‡‡ç”¨ **ç¼–æ’å™¨æ¨¡å¼ï¼ˆOrchestrator Patternï¼‰**ï¼Œç”± `AlertOrchestratorService` ç»Ÿä¸€åè°ƒå„ä¸ªå­æœåŠ¡å®Œæˆå‘Šè­¦æµç¨‹ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ä¸šåŠ¡å±‚ï¼ˆè§¦å‘æºï¼‰                                        â”‚
â”‚     MessageService  â”‚  AgentService  â”‚  MonitoringAlertServiceï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AlertOrchestratorServiceï¼ˆç¼–æ’ä¸­æ¢ï¼‰                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  1. æ£€æŸ¥å…¨å±€å¼€å…³      (AlertConfigService)                                 â”‚ â”‚
â”‚  â”‚  2. åˆ¤æ–­ä¸¥é‡ç¨‹åº¦      (AlertSeverityService)                               â”‚ â”‚
â”‚  â”‚  3. æ£€æŸ¥æ˜¯å¦é™é»˜      (AlertSilenceService)                                â”‚ â”‚
â”‚  â”‚  4. è®°å½•æ•…éšœçŠ¶æ€      (AlertRecoveryService)                               â”‚ â”‚
â”‚  â”‚  5. æ£€æŸ¥é™æµèšåˆ      (AlertThrottleService)                               â”‚ â”‚
â”‚  â”‚  6. å‘é€åˆ°é€šçŸ¥æ¸ é“    (FeiShuAlertService)                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       é…ç½®å±‚                       â”‚    â”‚       é€šçŸ¥æ¸ é“                         â”‚
â”‚  AlertConfigService               â”‚    â”‚  FeiShuAlertService                   â”‚
â”‚  â”œâ”€â”€ config/alert-rules.json     â”‚    â”‚  â””â”€â”€ é£ä¹¦ Webhook                      â”‚
â”‚  â””â”€â”€ ç¯å¢ƒå˜é‡ (.env)              â”‚    â”‚                                       â”‚
â”‚  æ”¯æŒçƒ­åŠ è½½ï¼Œæ— éœ€é‡å¯              â”‚    â”‚  (å¯æ‰©å±•: é‚®ä»¶ã€çŸ­ä¿¡ã€é’‰é’‰...)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç‰¹æ€§

| ç‰¹æ€§ | è¯´æ˜ |
|-----|------|
| **å¤šå±‚æ¬¡å‘Šè­¦** | é”™è¯¯å‘Šè­¦ + ä¸šåŠ¡æŒ‡æ ‡ä¸»åŠ¨å‘Šè­¦ |
| **æ™ºèƒ½é™æµ** | è‡ªåŠ¨èšåˆé‡å¤å‘Šè­¦ï¼Œé˜²æ­¢å‘Šè­¦é£æš´ |
| **ä¸¥é‡ç¨‹åº¦åˆ†çº§** | CRITICAL / ERROR / WARNING / INFO |
| **æ¢å¤æ£€æµ‹** | è‡ªåŠ¨å‘é€æ•…éšœæ¢å¤é€šçŸ¥ |
| **é™é»˜ç®¡ç†** | æ”¯æŒä¸´æ—¶å±è”½å‘Šè­¦ï¼ˆè®¡åˆ’ç»´æŠ¤ï¼‰ |
| **é…ç½®çƒ­åŠ è½½** | ä¿®æ”¹é…ç½®æ–‡ä»¶å³æ—¶ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯ |

---

## å‘Šè­¦ç±»å‹

### 1. é”™è¯¯å‘Šè­¦ï¼ˆå®æ—¶è§¦å‘ï¼‰

å½“ä¸šåŠ¡ä»£ç å‘ç”Ÿé”™è¯¯æ—¶ç«‹å³è§¦å‘ï¼š

| ç±»å‹ | è§¦å‘åœºæ™¯ | é»˜è®¤ä¸¥é‡ç¨‹åº¦ |
|-----|---------|-------------|
| `agent` | Agent API è°ƒç”¨å¤±è´¥ï¼ˆ401/403/429/5xxï¼‰ | CRITICAL / ERROR / WARNING |
| `message` | æ¶ˆæ¯å¤„ç†å¤±è´¥ï¼ˆé Agent é”™è¯¯ï¼‰ | WARNING |
| `delivery` | æ¶ˆæ¯å‘é€å¤±è´¥ | WARNING |
| `merge` | æ¶ˆæ¯èšåˆå¤„ç†å¤±è´¥ | WARNING |

**è§¦å‘ä»£ç ç¤ºä¾‹**ï¼š
```typescript
// MessageService ä¸­çš„é”™è¯¯å‘Šè­¦
await this.alertOrchestrator.sendAlert({
  errorType: 'agent',
  error: new Error('Agent API timeout'),
  conversationId: 'conv-123',
  userMessage: 'ç”¨æˆ·é—®é¢˜å†…å®¹',
  contactName: 'å¼ ä¸‰',
  scenario: 'candidate_consulting',
  apiEndpoint: '/api/v1/chat',
  statusCode: 500,
});
```

### 2. ä¸šåŠ¡æŒ‡æ ‡å‘Šè­¦ï¼ˆå®šæ—¶æ£€æŸ¥ï¼‰

ç”± `MonitoringAlertService` æ¯åˆ†é’Ÿè‡ªåŠ¨æ£€æŸ¥ï¼Œå¼‚å¸¸æ—¶ä¸»åŠ¨å‘Šè­¦ï¼š

| æŒ‡æ ‡ | WARNING é˜ˆå€¼ | CRITICAL é˜ˆå€¼ | è¯´æ˜ |
|-----|-------------|--------------|------|
| **æˆåŠŸç‡** | < 90% | < 80% | æ¶ˆæ¯å¤„ç†æˆåŠŸç‡ |
| **å¹³å‡å“åº”æ—¶é—´** | > 5000ms | > 10000ms | ä»æ¥æ”¶åˆ°å›å¤çš„æ€»è€—æ—¶ |
| **é˜Ÿåˆ—ç§¯å‹** | > 50 æ¡ | > 100 æ¡ | å½“å‰å¤„ç†ä¸­çš„æ¶ˆæ¯æ•° |
| **é”™è¯¯ç‡** | > 10/åˆ†é’Ÿ | > 20/åˆ†é’Ÿ | 24å°æ—¶å¹³å‡æ¯åˆ†é’Ÿé”™è¯¯æ•° |

**å®šæ—¶ä»»åŠ¡å®ç°**ï¼š
```typescript
@Cron(CronExpression.EVERY_MINUTE)
async checkBusinessMetrics(): Promise<void> {
  const dashboard = this.monitoringService.getDashboardData();

  await this.checkSuccessRate(dashboard.overview.successRate, config.successRate);
  await this.checkAvgDuration(dashboard.overview.avgDuration, config.avgDuration);
  await this.checkQueueDepth(dashboard.queue.currentProcessing, config.queueDepth);
  await this.checkErrorRate(dashboard.alertsSummary.last24Hours, config.errorRate);
}
```

---

## æœåŠ¡ç»„ä»¶

### æœåŠ¡åˆ—è¡¨

| æœåŠ¡ | æ–‡ä»¶ä½ç½® | èŒè´£ |
|-----|---------|------|
| **AlertOrchestratorService** | `services/alert-orchestrator.service.ts` | å‘Šè­¦ç¼–æ’ä¸­æ¢ï¼Œåè°ƒæ‰€æœ‰å­æœåŠ¡ |
| **AlertConfigService** | `services/alert-config.service.ts` | é…ç½®ç®¡ç†ï¼Œæ”¯æŒæ–‡ä»¶çƒ­åŠ è½½ |
| **AlertSeverityService** | `services/alert-severity.service.ts` | ä¸¥é‡ç¨‹åº¦åˆ¤æ–­ï¼ˆé”™è¯¯ç  â†’ çº§åˆ«ï¼‰ |
| **AlertThrottleService** | `services/alert-throttle.service.ts` | é™æµèšåˆï¼Œé˜²æ­¢å‘Šè­¦é£æš´ |
| **AlertRecoveryService** | `services/alert-recovery.service.ts` | æ¢å¤æ£€æµ‹ï¼Œè¿½è¸ªæ•…éšœçŠ¶æ€ |
| **AlertSilenceService** | `services/alert-silence.service.ts` | é™é»˜ç®¡ç†ï¼Œä¸´æ—¶å±è”½å‘Šè­¦ |
| **FeiShuAlertService** | `feishu-alert.service.ts` | é£ä¹¦æ¸ é“å‘é€ |
| **MonitoringAlertService** | `monitoring/monitoring-alert.service.ts` | ä¸šåŠ¡æŒ‡æ ‡ä¸»åŠ¨å‘Šè­¦ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰ |

### AlertOrchestratorServiceï¼ˆç¼–æ’å™¨ï¼‰

**æ ¸å¿ƒæ–¹æ³•**ï¼š

```typescript
// å‘é€é”™è¯¯å‘Šè­¦
async sendAlert(context: AlertContext): Promise<AlertResult>

// å‘é€æ¢å¤é€šçŸ¥
async sendRecoveryNotification(recoveryKey: string): Promise<void>

// å‘é€ä¸šåŠ¡æŒ‡æ ‡å‘Šè­¦
async sendMetricAlert(context: MetricAlertContext): Promise<void>
```

**å¤„ç†æµç¨‹**ï¼š

```
sendAlert(context)
    â”‚
    â”œâ”€â”€ 1. æ£€æŸ¥å…¨å±€å¼€å…³ (configService.isEnabled())
    â”‚       â””â”€â”€ ç¦ç”¨ â†’ è¿”å› { sent: false, reason: 'globally-disabled' }
    â”‚
    â”œâ”€â”€ 2. åˆ¤æ–­ä¸¥é‡ç¨‹åº¦ (severityService.determineSeverity())
    â”‚       â””â”€â”€ æ ¹æ® errorType + statusCode ç¡®å®šçº§åˆ«
    â”‚
    â”œâ”€â”€ 3. æ£€æŸ¥æ˜¯å¦é™é»˜ (silenceService.isSilenced())
    â”‚       â””â”€â”€ é™é»˜ä¸­ â†’ è¿”å› { sent: false, reason: 'silenced-Xs-remaining' }
    â”‚
    â”œâ”€â”€ 4. è®°å½•æ•…éšœçŠ¶æ€ (recoveryService.recordFailure())
    â”‚       â””â”€â”€ ç”¨äºåç»­æ¢å¤æ£€æµ‹
    â”‚
    â”œâ”€â”€ 5. æ£€æŸ¥é™æµ (throttleService.shouldSendAlert())
    â”‚       â””â”€â”€ é™æµä¸­ â†’ è¿”å› { sent: false, reason: 'throttled' }
    â”‚
    â””â”€â”€ 6. å‘é€åˆ°é€šçŸ¥æ¸ é“ (sendToChannels())
            â””â”€â”€ é£ä¹¦ â†’ feiShuAlertService.sendAgentApiFailureAlert()
```

### AlertThrottleServiceï¼ˆé™æµæœåŠ¡ï¼‰

**è§£å†³é—®é¢˜**ï¼šAgent API æŒç»­æ•…éšœå¯¼è‡´æ¯ç§’äº§ç”Ÿ 10+ æ¡å‘Šè­¦ï¼Œé£ä¹¦ç¾¤è¢«åˆ·å±ã€‚

**é™æµç­–ç•¥**ï¼š
- åŒç±»å‹å‘Šè­¦åœ¨çª—å£æœŸå†…ï¼ˆé»˜è®¤ 5 åˆ†é’Ÿï¼‰åªå‘é€ **1 æ¬¡**
- åç»­å‘Šè­¦è‡ªåŠ¨è®¡æ•°èšåˆ
- çª—å£æœŸç»“æŸåå‘é€ **èšåˆå‘Šè­¦**ï¼ˆåŒ…å«æ€»æ¬¡æ•°ã€é”™è¯¯åˆ†å¸ƒï¼‰

**æ•ˆæœå¯¹æ¯”**ï¼š
```
Before: 300 æ¡ç‹¬ç«‹å‘Šè­¦ï¼ˆ5 åˆ†é’Ÿå†…ï¼‰âŒ
After:  1 æ¡èšåˆå‘Šè­¦ âœ…
å†…å®¹: "5åˆ†é’Ÿå†…å‘ç”Ÿ 300 æ¬¡ï¼Œé”™è¯¯åˆ†å¸ƒï¼šè¶…æ—¶(189æ¬¡)ã€é™æµ(111æ¬¡)"
```

### AlertRecoveryServiceï¼ˆæ¢å¤æ£€æµ‹ï¼‰

**åŸç†**ï¼š
1. è®°å½•æ¯ä¸ªå‘Šè­¦é”®çš„é¦–æ¬¡æ•…éšœæ—¶é—´
2. è¿½è¸ªè¿ç»­æˆåŠŸæ¬¡æ•°
3. è¾¾åˆ°é˜ˆå€¼ï¼ˆé»˜è®¤ 5 æ¬¡ï¼‰åè®¤ä¸ºæ¢å¤
4. è‡ªåŠ¨å‘é€æ¢å¤é€šçŸ¥

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```typescript
// ä¸šåŠ¡ä»£ç ä¸­è®°å½•æˆåŠŸ
const recovered = this.alertRecovery.recordSuccess({
  errorType: 'agent',
  scenario: 'candidate_consulting',
});

if (recovered) {
  // å‘é€æ¢å¤é€šçŸ¥
  await this.alertOrchestrator.sendRecoveryNotification('agent:candidate_consulting');
}
```

### AlertSilenceServiceï¼ˆé™é»˜ç®¡ç†ï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼š
- Agent API è®¡åˆ’å†…ç»´æŠ¤ï¼ˆå·²çŸ¥åœæœºï¼‰
- éç´§æ€¥é—®é¢˜ä¿®å¤ä¸­ï¼ˆé¿å…é‡å¤æ‰“æ‰°ï¼‰
- æµ‹è¯•ç¯å¢ƒä¸´æ—¶å…³é—­å‘Šè­¦

---

## æ•°æ®æµè¯¦è§£

### é”™è¯¯å‘Šè­¦æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é”™è¯¯å‘ç”Ÿ                                                                         â”‚
â”‚                                                                                 â”‚
â”‚   MessageService.handleMessage()                                                â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â””â”€â”€ try-catch æ•è·å¼‚å¸¸                                                     â”‚
â”‚           â”‚                                                                     â”‚
â”‚           â–¼                                                                     â”‚
â”‚   alertOrchestrator.sendAlert({                                                 â”‚
â”‚     errorType: 'agent',                                                         â”‚
â”‚     error: error,                                                               â”‚
â”‚     conversationId: 'xxx',                                                      â”‚
â”‚     ...                                                                         â”‚
â”‚   })                                                                            â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â–¼                                                                         â”‚
â”‚   [ç¼–æ’å™¨å¤„ç†æµç¨‹]                                                               â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â”œâ”€â”€ å…¨å±€å¼€å…³ï¼Ÿ â”€â”€â”€ ç¦ç”¨ â”€â”€â”€â–º è·³è¿‡                                          â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â”œâ”€â”€ è¢«é™é»˜ï¼Ÿ â”€â”€â”€â”€ æ˜¯ â”€â”€â”€â”€â”€â–º è·³è¿‡                                          â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â”œâ”€â”€ è¢«é™æµï¼Ÿ â”€â”€â”€â”€ æ˜¯ â”€â”€â”€â”€â”€â–º è®¡æ•°èšåˆï¼Œè·³è¿‡å‘é€                              â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â””â”€â”€ å‘é€å‘Šè­¦                                                               â”‚
â”‚           â”‚                                                                     â”‚
â”‚           â–¼                                                                     â”‚
â”‚   FeiShuAlertService.sendAgentApiFailureAlert()                                 â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â–¼                                                                         â”‚
â”‚   é£ä¹¦ç¾¤æ”¶åˆ°å‘Šè­¦å¡ç‰‡                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸šåŠ¡æŒ‡æ ‡å‘Šè­¦æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®šæ—¶è§¦å‘ï¼ˆæ¯åˆ†é’Ÿï¼‰                                                                â”‚
â”‚                                                                                 â”‚
â”‚   @Cron(EVERY_MINUTE)                                                           â”‚
â”‚   MonitoringAlertService.checkBusinessMetrics()                                 â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â”œâ”€â”€ è·å–ä»ªè¡¨ç›˜æ•°æ®                                                         â”‚
â”‚       â”‚   monitoringService.getDashboardData()                                  â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â”œâ”€â”€ æ£€æŸ¥æˆåŠŸç‡                                                             â”‚
â”‚       â”‚   currentValue: 67% < critical: 80%                                     â”‚
â”‚       â”‚       â”‚                                                                 â”‚
â”‚       â”‚       â”œâ”€â”€ æ£€æŸ¥æœ€å°å‘Šè­¦é—´éš”ï¼ˆ5åˆ†é’Ÿï¼‰                                       â”‚
â”‚       â”‚       â”‚                                                                 â”‚
â”‚       â”‚       â””â”€â”€ alertOrchestrator.sendMetricAlert({                           â”‚
â”‚       â”‚             metricName: 'æˆåŠŸç‡ä¸¥é‡ä¸‹é™',                                 â”‚
â”‚       â”‚             currentValue: 67,                                           â”‚
â”‚       â”‚             threshold: 80,                                              â”‚
â”‚       â”‚             severity: CRITICAL                                          â”‚
â”‚       â”‚           })                                                            â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â”œâ”€â”€ æ£€æŸ¥å“åº”æ—¶é—´                                                           â”‚
â”‚       â”œâ”€â”€ æ£€æŸ¥é˜Ÿåˆ—ç§¯å‹                                                           â”‚
â”‚       â””â”€â”€ æ£€æŸ¥é”™è¯¯ç‡                                                             â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¢å¤æ£€æµ‹æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¢å¤æ£€æµ‹                                                                         â”‚
â”‚                                                                                 â”‚
â”‚   [æ•…éšœæœŸé—´]                                                                     â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â”œâ”€â”€ recordFailure() Ã— N æ¬¡                                                â”‚
â”‚       â”‚   â””â”€â”€ è®°å½•: startTime, failureCount++                                   â”‚
â”‚       â”‚                                                                         â”‚
â”‚   [å¼€å§‹æ¢å¤]                                                                     â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â”œâ”€â”€ recordSuccess() Ã— 1                                                   â”‚
â”‚       â”‚   â””â”€â”€ consecutiveSuccess = 1                                            â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â”œâ”€â”€ recordSuccess() Ã— 2                                                   â”‚
â”‚       â”‚   â””â”€â”€ consecutiveSuccess = 2                                            â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â”œâ”€â”€ ... (ç»§ç»­æˆåŠŸ)                                                         â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â””â”€â”€ recordSuccess() Ã— 5 (è¾¾åˆ°é˜ˆå€¼)                                         â”‚
â”‚           â”‚                                                                     â”‚
â”‚           â”œâ”€â”€ isRecovered = true                                                â”‚
â”‚           â”‚                                                                     â”‚
â”‚           â””â”€â”€ è¿”å› true â†’ è§¦å‘æ¢å¤é€šçŸ¥                                           â”‚
â”‚               â”‚                                                                 â”‚
â”‚               â–¼                                                                 â”‚
â”‚   alertOrchestrator.sendRecoveryNotification('agent:scenario')                  â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â–¼                                                                         â”‚
â”‚   é£ä¹¦ç¾¤æ”¶åˆ°æ¢å¤é€šçŸ¥:                                                            â”‚
â”‚   "âœ… å‘Šè­¦å·²æ¢å¤ [agent:scenario]                                               â”‚
â”‚    æ•…éšœæ—¶é•¿: 33 åˆ†é’Ÿ                                                             â”‚
â”‚    æ•…éšœæœŸé—´å¤±è´¥æ¬¡æ•°: 127"                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## é…ç½®æŒ‡å—

### ç¯å¢ƒå˜é‡é…ç½®

```bash
# .env

# ========== å¿…é¡»é…ç½® ==========
# é£ä¹¦å‘Šè­¦ Webhookï¼ˆå¿…é¡»ï¼‰
ENABLE_FEISHU_ALERT=true
FEISHU_ALERT_WEBHOOK_URL=https://open.feishu.cn/open-apis/bot/v2/hook/xxxxx
FEISHU_ALERT_SECRET=your-secret-key

# ========== å¯é€‰é…ç½® ==========
# å‘Šè­¦ç³»ç»Ÿæ€»å¼€å…³ï¼ˆé»˜è®¤ trueï¼‰
ALERT_ENABLED=true

# ä¸šåŠ¡æŒ‡æ ‡å‘Šè­¦å¼€å…³ï¼ˆé»˜è®¤ trueï¼‰
ALERT_METRICS_ENABLED=true

# é™æµçª—å£ï¼ˆé»˜è®¤ 5 åˆ†é’Ÿï¼‰
ALERT_THROTTLE_WINDOW_MS=300000

# ä¸šåŠ¡æŒ‡æ ‡é˜ˆå€¼ï¼ˆå¯é€‰ï¼Œè¦†ç›– JSON é…ç½®ï¼‰
ALERT_SUCCESS_RATE_WARNING=90
ALERT_SUCCESS_RATE_CRITICAL=80
ALERT_AVG_DURATION_WARNING=5000
ALERT_AVG_DURATION_CRITICAL=10000
```

### è§„åˆ™é…ç½®æ–‡ä»¶

**æ–‡ä»¶ä½ç½®**ï¼š`config/alert-rules.json`

```json
{
  "enabled": true,
  "rules": [
    {
      "name": "agent-auth-failure",
      "enabled": true,
      "match": {
        "errorType": "agent",
        "errorCode": "401|403"
      },
      "severity": "critical",
      "throttle": {
        "enabled": true,
        "windowMs": 300000,
        "maxOccurrences": 3
      }
    },
    {
      "name": "agent-rate-limit",
      "enabled": true,
      "match": {
        "errorType": "agent",
        "errorCode": "429"
      },
      "severity": "warning",
      "throttle": {
        "enabled": true,
        "windowMs": 600000,
        "maxOccurrences": 5
      }
    }
  ],
  "metrics": {
    "successRate": {
      "warning": 90,
      "critical": 80
    },
    "avgDuration": {
      "warning": 5000,
      "critical": 10000
    },
    "queueDepth": {
      "warning": 50,
      "critical": 100
    },
    "errorRate": {
      "warning": 10,
      "critical": 20
    }
  },
  "defaultThrottle": {
    "windowMs": 300000,
    "maxOccurrences": 1
  }
}
```

**é…ç½®çƒ­åŠ è½½**ï¼šä¿®æ”¹æ–‡ä»¶åè‡ªåŠ¨ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯æœåŠ¡ï¼

---

## å‘Šè­¦å±•ç¤º

### ä¸¥é‡ç¨‹åº¦è¯´æ˜

| çº§åˆ« | å›¾æ ‡ | é¢œè‰² | ä½¿ç”¨åœºæ™¯ |
|-----|------|------|---------|
| **CRITICAL** | `ğŸ”´` | ç´«è‰² | è®¤è¯å¤±è´¥ã€æœåŠ¡ä¸å¯ç”¨ã€æˆåŠŸç‡<80% |
| **ERROR** | `ğŸš¨` | çº¢è‰² | 5xx é”™è¯¯ã€Agent è°ƒç”¨å¤±è´¥ã€å“åº”è¶…æ—¶ |
| **WARNING** | `âš ï¸` | æ©™è‰² | é™æµã€æˆåŠŸç‡<90%ã€é˜Ÿåˆ—ç§¯å‹ |
| **INFO** | `â„¹ï¸` | è“è‰² | æ¢å¤é€šçŸ¥ã€ä¿¡æ¯æç¤º |

### å‘Šè­¦å¡ç‰‡ç¤ºä¾‹

#### æ™®é€šå‘Šè­¦

```
ğŸš¨ Agent è°ƒç”¨å¤±è´¥å‘Šè­¦

å‘Šè­¦æ—¶é—´: 2025-11-25 14:32:15
ç¯å¢ƒ: production
ä¼šè¯ID: conv-123-456
é”™è¯¯ç±»å‹: Agent Invocation Error
ä¸¥é‡ç¨‹åº¦: ERROR
ç”¨æˆ·æ˜µç§°: å¼ ä¸‰
åœºæ™¯: candidate_consulting

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
é”™è¯¯ä¿¡æ¯: Request timeout after 60000ms
HTTP çŠ¶æ€ç : N/A
API ç«¯ç‚¹: /api/v1/chat

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç”¨æˆ·æ¶ˆæ¯: è¯·é—®æœ‰å“ªäº›UIè®¾è®¡å¸ˆçš„èŒä½ï¼Ÿ

[æŸ¥çœ‹ç›‘æ§å¤§ç›˜] [æŸ¥çœ‹æ—¥å¿—]
```

#### èšåˆå‘Šè­¦ï¼ˆé™æµåï¼‰

```
ğŸš¨ Agent è°ƒç”¨å¤±è´¥å‘Šè­¦ï¼ˆèšåˆï¼‰

âš ï¸ 5åˆ†é’Ÿå†…å‘ç”Ÿ 127 æ¬¡

æ—¶é—´çª—å£: 10:00:01 - 10:04:58
å½±å“ä¼šè¯: 45 ä¸ª
ä¸¥é‡ç¨‹åº¦: ERROR

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
èšåˆçš„é”™è¯¯ä¿¡æ¯:
1. Request timeout after 60000ms (89æ¬¡)
2. Agent APIè¿”å› 429 Rate Limit (38æ¬¡)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å»ºè®®æ“ä½œ:
1. æ£€æŸ¥ Agent API æœåŠ¡çŠ¶æ€
2. æŸ¥çœ‹é”™è¯¯æ—¥å¿—åˆ†å¸ƒ
3. è€ƒè™‘å¢åŠ è¯·æ±‚é…é¢

[æŸ¥çœ‹ç›‘æ§å¤§ç›˜] [æŸ¥çœ‹æ—¥å¿—]
```

#### æ¢å¤é€šçŸ¥

```
âœ… å‘Šè­¦å·²æ¢å¤ [agent:candidate_consulting]

æ¢å¤æ—¶é—´: 2025-11-25 15:05:30
æ•…éšœæ—¶é•¿: 33 åˆ†é’Ÿ (1980 ç§’)
æ•…éšœæœŸé—´å¤±è´¥æ¬¡æ•°: 127
æ¢å¤åˆ¤å®š: è¿ç»­æˆåŠŸ 5 æ¬¡

ç³»ç»Ÿå·²æ¢å¤æ­£å¸¸è¿è¡Œ âœ¨
```

#### ä¸šåŠ¡æŒ‡æ ‡å‘Šè­¦

```
ğŸ”´ ä¸šåŠ¡æŒ‡æ ‡å‘Šè­¦: æˆåŠŸç‡ä¸¥é‡ä¸‹é™

æŒ‡æ ‡åç§°: æˆåŠŸç‡ä¸¥é‡ä¸‹é™
å½“å‰å€¼: 67%
é˜ˆå€¼: 80%
ä¸¥é‡ç¨‹åº¦: CRITICAL
æ—¶é—´çª—å£: å½“å‰

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
é™„åŠ ä¿¡æ¯:
message: æˆåŠŸç‡å·²é™è‡³ä¸´ç•Œå€¼ä»¥ä¸‹ï¼Œå¤§é‡ç”¨æˆ·å—å½±å“
suggestion: ç«‹å³æ£€æŸ¥ Agent API çŠ¶æ€ã€æ•°æ®åº“è¿æ¥ã€ç½‘ç»œçŠ¶å†µ

[æŸ¥çœ‹ç›‘æ§å¤§ç›˜] [æ£€æŸ¥ Agent å¥åº·]
```

---

## API æ¥å£

### AlertController ç«¯ç‚¹

| æ–¹æ³• | è·¯å¾„ | ç”¨é€” |
|-----|------|------|
| POST | `/alert/silence` | æ·»åŠ é™é»˜è§„åˆ™ |
| GET | `/alert/silence` | æŸ¥è¯¢æ‰€æœ‰é™é»˜è§„åˆ™ |
| DELETE | `/alert/silence/:key` | åˆ é™¤é™é»˜è§„åˆ™ |
| POST | `/alert/test/metrics` | æµ‹è¯•ä¸šåŠ¡æŒ‡æ ‡å‘Šè­¦ |
| POST | `/alert/test/error` | æµ‹è¯•é”™è¯¯å‘Šè­¦ |

### é™é»˜ç®¡ç† API

```bash
# æ·»åŠ é™é»˜è§„åˆ™ - é™é»˜ agent ç±»å‹å‘Šè­¦ 1 å°æ—¶
curl -X POST http://localhost:8080/alert/silence \
  -H "Content-Type: application/json" \
  -d '{
    "errorType": "agent",
    "durationMs": 3600000,
    "reason": "Agent API è®¡åˆ’å†…ç»´æŠ¤"
  }'

# æ·»åŠ é™é»˜è§„åˆ™ - é™é»˜ç‰¹å®šåœºæ™¯çš„å‘Šè­¦
curl -X POST http://localhost:8080/alert/silence \
  -H "Content-Type: application/json" \
  -d '{
    "errorType": "agent",
    "scenario": "candidate_consulting",
    "durationMs": 3600000,
    "reason": "å€™é€‰äººå’¨è¯¢åœºæ™¯ç»´æŠ¤ä¸­"
  }'

# æŸ¥è¯¢æ‰€æœ‰é™é»˜è§„åˆ™ï¼ˆåŒ…æ‹¬å‰©ä½™æ—¶é—´ï¼‰
curl http://localhost:8080/alert/silence

# åˆ é™¤é™é»˜è§„åˆ™
curl -X DELETE http://localhost:8080/alert/silence/agent
curl -X DELETE http://localhost:8080/alert/silence/agent:candidate_consulting
```

### æµ‹è¯•å‘Šè­¦ API

```bash
# æµ‹è¯•ä¸šåŠ¡æŒ‡æ ‡å‘Šè­¦
curl -X POST http://localhost:8080/alert/test/metrics

# æµ‹è¯•é”™è¯¯å‘Šè­¦
curl -X POST http://localhost:8080/alert/test/error \
  -H "Content-Type: application/json" \
  -d '{
    "errorType": "agent",
    "message": "æµ‹è¯•å‘Šè­¦æ¶ˆæ¯"
  }'
```

---

## æ•…éšœæ’æŸ¥

### å‘Šè­¦æ²¡æœ‰å‘é€ï¼Ÿ

**æ’æŸ¥æ­¥éª¤**ï¼š

1. **æ£€æŸ¥å…¨å±€å¼€å…³**
   ```bash
   echo $ALERT_ENABLED        # åº”ä¸º true
   echo $ENABLE_FEISHU_ALERT  # åº”ä¸º true
   ```

2. **æ£€æŸ¥é…ç½®æ–‡ä»¶**
   ```bash
   cat config/alert-rules.json | jq '.enabled'  # åº”ä¸º true
   ```

3. **æ£€æŸ¥æ˜¯å¦è¢«é™é»˜**
   ```bash
   curl http://localhost:8080/alert/silence
   ```

4. **æŸ¥çœ‹æ—¥å¿—**
   ```bash
   tail -f logs/combined-$(date +%Y-%m-%d).log | grep -E "(Alert|å‘Šè­¦)"
   ```

5. **æ£€æŸ¥é£ä¹¦ Webhook**
   ```bash
   # æµ‹è¯• Webhook æ˜¯å¦å¯ç”¨
   curl -X POST "$FEISHU_ALERT_WEBHOOK_URL" \
     -H "Content-Type: application/json" \
     -d '{"msg_type":"text","content":{"text":"æµ‹è¯•æ¶ˆæ¯"}}'
   ```

### å‘Šè­¦å¤ªé¢‘ç¹ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **è°ƒæ•´é™æµçª—å£**
   ```bash
   # .env
   ALERT_THROTTLE_WINDOW_MS=600000  # æ”¹ä¸º 10 åˆ†é’Ÿ
   ```

2. **ä¿®æ”¹è§„åˆ™é…ç½®**
   ```json
   // config/alert-rules.json
   {
     "rules": [{
       "name": "agent-timeout",
       "throttle": {
         "windowMs": 600000,
         "maxOccurrences": 5
       }
     }]
   }
   ```

3. **ä¸´æ—¶é™é»˜**
   ```bash
   curl -X POST http://localhost:8080/alert/silence \
     -d '{"errorType":"agent","durationMs":3600000,"reason":"ä¸´æ—¶é™é»˜"}'
   ```

### ä¸šåŠ¡æŒ‡æ ‡å‘Šè­¦ä¸è§¦å‘ï¼Ÿ

**æ’æŸ¥æ­¥éª¤**ï¼š

1. **æ£€æŸ¥æŒ‡æ ‡å‘Šè­¦å¼€å…³**
   ```bash
   echo $ALERT_METRICS_ENABLED  # åº”ä¸º true
   ```

2. **æ£€æŸ¥é˜ˆå€¼é…ç½®**
   ```bash
   cat config/alert-rules.json | jq '.metrics'
   ```

3. **æ£€æŸ¥å½“å‰æŒ‡æ ‡å€¼**
   ```bash
   curl http://localhost:8080/monitoring/dashboard | jq '.overview'
   ```

4. **æ£€æŸ¥æœ€å°å‘Šè­¦é—´éš”**
   - åŒä¸€æŒ‡æ ‡å‘Šè­¦æœ€å°é—´éš”ä¸º 5 åˆ†é’Ÿ
   - æŸ¥çœ‹æ—¥å¿—ç¡®è®¤æ˜¯å¦å› é—´éš”è¢«è·³è¿‡

---

## ç›¸å…³æ–‡æ¡£

- [ç›‘æ§ç³»ç»Ÿæ¶æ„](./monitoring-system-architecture.md)
- [Redis ä¸ Supabase èµ„æºä½¿ç”¨æŒ‡å—](../infrastructure/redis-supabase-usage.md)
- [æ¶ˆæ¯æœåŠ¡æ¶æ„](./message-service-architecture.md)

---

**ç»´æŠ¤è€…**ï¼šDuLiDay Team
