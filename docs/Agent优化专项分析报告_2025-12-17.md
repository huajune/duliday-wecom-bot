# Agent 优化专项分析报告

> 生成时间: 2025-12-17
> 数据来源: Supabase message_processing_records 表
> 分析样本: 341 条包含 agent_invocation 的记录

---

## 一、执行摘要

### 核心发现
| 指标 | 数值 | 问题等级 |
|------|------|----------|
| duliday_job_list 成功率 | **17.1%** (69/403) | 🔴 严重 |
| 缺少 brandName 参数 | **38.5%** (155/403) | 🔴 严重 |
| 品牌映射失败 | **11.2%** (45/403) | 🟡 中等 |
| 单消息重复调用 ≥4次 | **34 条** | 🟡 中等 |
| Fallback 触发率 | **13.2%** (45/341) | 🟡 中等 |

### 关键优化建议
1. **工具层**: 添加 brandName 智能推断逻辑，建立品牌名称模糊映射
2. **Prompt层**: 明确要求 Agent 在调用前必须确认品牌名称
3. **流程层**: 限制同一工具重复调用次数，失败后转对话确认
4. **监控层**: 增加工具调用成功率告警

---

## 二、工具调用数据总览

### 2.1 总体统计

```
┌─────────────────────────────────────────────────────────────┐
│                     341 条 agent_invocation 记录             │
├─────────────────────────────────────────────────────────────┤
│  有工具调用: 217 条 (63.6%)                                   │
│  无工具调用: 124 条 (36.4%) - 纯对话/简单回复                   │
│  使用Fallback: 45 条 (13.2%) - Agent调用失败后的兜底            │
│  总工具调用次数: 597 次                                        │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 工具调用分布

| 工具名称 | 调用次数 | 占比 | 说明 |
|---------|---------|------|------|
| `duliday_job_list` | 403 | 67.5% | 岗位列表查询 |
| `zhipin_reply_generator` | 162 | 27.1% | 智能回复生成 |
| `duliday_job_details` | 31 | 5.2% | 岗位详情查询 |
| `duliday_interview_booking` | 1 | 0.2% | 面试预约 |

### 2.3 单消息工具调用次数分布

| 调用次数 | 记录数 | 占比 | 备注 |
|---------|-------|------|------|
| 0 | 124 | 36.4% | 纯对话 |
| 1 | 62 | 18.2% | 正常 |
| 2 | 59 | 17.3% | 正常 |
| 3 | 46 | 13.5% | 边界 |
| 4 | 14 | 4.1% | 偏多 |
| 5 | 15 | 4.4% | 偏多 |
| 6 | 11 | 3.2% | 异常 |
| 7 | 3 | 0.9% | 异常 |
| 8 | 5 | 1.5% | 严重异常 |
| 9 | 1 | 0.3% | 严重异常 |
| 12 | 1 | 0.3% | 极端异常 |

---

## 三、duliday_job_list 深度分析

### 3.1 调用结果分类

```
总调用次数: 403 次

┌──────────────────────────────────────────────────────────────┐
│  ✅ 成功找到岗位        │   69 次  │  17.1%  │ 正常          │
│  ❌ 缺少品牌名称        │  155 次  │  38.5%  │ 参数问题      │
│  ❌ 未找到符合条件岗位   │   82 次  │  20.3%  │ 数据问题      │
│  ❌ 品牌映射失败        │   45 次  │  11.2%  │ 品牌名不规范   │
│  ❌ API响应格式错误     │   39 次  │   9.7%  │ 系统问题      │
│  其他                  │   13 次  │   3.2%  │ 其他情况      │
└──────────────────────────────────────────────────────────────┘
```

### 3.2 问题一: 缺少 brandName 参数 (155 次, 38.5%)

**问题描述**: Agent 在调用 duliday_job_list 时经常不传递 brandName 参数，导致工具返回错误。

**典型调用示例**:
```json
{
  "pageNum": 0,
  "pageSize": 80,
  "regionName": "松江区"
  // 缺少 brandName
}
```

**错误返回**:
```
❌ 请指定要查询的品牌名称
```

**涉及地区分布**:
- 松江区: 多次
- 沙河口区: 多次
- 朝阳区: 多次
- 杨浦区: 多次
- 栖霞区、萧山等

**根本原因**:
1. Prompt 中未强制要求 Agent 在调用前确认品牌
2. 工具 Schema 中 brandName 虽标记为必填，但 Agent 仍然会忽略
3. 用户消息中常不提及具体品牌，Agent 未主动询问

### 3.3 问题二: 品牌名称映射失败 (45 次, 11.2%)

**问题描述**: 用户或 Agent 使用的品牌名称与系统支持的不完全匹配。

**失败品牌统计**:
| 用户输入 | 失败次数 | 正确名称 |
|---------|---------|---------|
| `必胜客` | 37 | `上海必胜客`/`北京必胜客`/`成都必胜客` |
| `星巴克` | 4 | ❌ 不支持 |
| `麦当劳` | 2 | ❌ 不支持 |
| `山姆` | 2 | `嘉定山姆`/`高科西山姆`/`普陀真如山姆` |

**系统支持的品牌列表**:
```
肯德基、ZARA、西贝莜面村、哈根达斯、波司登、来伊份、上海必胜客、
奥乐齐、海底捞、李维斯、摩提工房-西树泡芙、成都你六姐、大米先生、
安徽肯德基、宁波必胜客、上海来伊份、北京肯德基、北京必胜客、
天津肯德基、Drunk Baker、嘉定山姆、成都必胜客、小肥羊、黄记煌、
成都肯德基、杭州肯德基、成都拉瓦萨、深圳肯德基、广州肯德基、
高科西山姆、嘉松中路山姆、普陀真如山姆、佛山必胜客、M Stand、
塔可贝尔、左庭右院、大连肯德基、可可牛
```

**根本原因**:
1. 品牌命名规则不统一（必胜客 vs 上海必胜客）
2. 工具层缺少模糊匹配能力
3. Prompt 未告知 Agent 正确的品牌名称格式

### 3.4 问题三: 重复调用同一工具

**问题描述**: 单条用户消息触发多次 duliday_job_list 调用，造成 Token 浪费。

**极端案例**:

**案例 1: 用户 "沈姐"**
- 用户消息: "时间对，都行"
- 触发调用: **12 次** duliday_job_list
- 消耗 Token: 17003

**案例 2: 用户 "xin👑"**
- 用户消息: "你靠谱不？"
- 触发调用: 4 次 duliday_job_list
- 调用参数变化:
  ```json
  // 第1次: 缺少 brandName → 失败
  {"pageNum": 0, "pageSize": 80, "regionName": "沙河口区"}

  // 第2次: 尝试 必胜客 → 映射失败
  {"brandName": "必胜客", "regionName": "沙河口区", ...}

  // 第3次: 尝试 奥乐齐 → 未找到岗位
  {"brandName": "奥乐齐", "regionName": "沙河口区", ...}

  // 第4次: 尝试 大米先生 → API错误
  {"brandName": "大米先生", "regionName": "沙河口区", ...}
  ```
- 消耗 Token: 18340

**问题模式**: Agent 在工具调用失败后不断重试，每次更换参数，但不主动向用户确认。

---

## 四、Token 消耗分析

### 4.1 高消耗记录 (Token > 20000)

| 用户 | 消息 | Token | 工具调用 | duliday_job_list 次数 |
|------|------|-------|---------|---------------------|
| 苏金波 | "做过餐饮" | 35,242 | 6 | 5 |
| lan | "五道口附近" | 33,216 | 7 | 6 |
| 讃歌 | "只考虑武汉" | 26,256 | 4 | 3 |
| 讃歌 | "是的" | 23,884 | 6 | 5 |
| Coffee默默 | "是的经理" | 23,864 | 3 | 2 |
| Coffee默默 | "必胜客" | 23,698 | 3 | 2 |

### 4.2 Token 消耗规律

1. **工具调用次数与 Token 正相关**: 调用次数越多，Token 消耗越高
2. **失败重试是主要消耗源**: 多次失败重试导致 Token 浪费
3. **简短消息可能触发高消耗**: 如 "是的"、"？" 等简单回复也可能消耗 20000+ Token

---

## 五、Fallback 机制分析

### 5.1 Fallback 触发情况

- 触发次数: 45 次
- 触发率: 13.2%
- Token 消耗: 0 (使用预设回复)

### 5.2 典型 Fallback 场景

| 用户消息类型 | 示例 | Fallback 回复 |
|-------------|------|--------------|
| 简单确认 | "好的"、"OK"、"[OK]" | "这个我得确认一下，稍等。" |
| 复杂请求 | "面试要求：先将以下资料..." | "我问下相关同事，确保信息准确，很快。" |
| 新话题切换 | "你那边还没有我的信息是吗" | "等我快速核实下最新情况，马上回来。" |

### 5.3 Fallback 问题

1. **回复单一**: 只有几种固定话术，用户体验不佳
2. **触发原因不明**: 部分简单消息也触发 Fallback
3. **未形成闭环**: Fallback 后没有后续处理逻辑

---

## 六、优化建议

### 6.1 工具层优化 (优先级: 高)

#### 建议 1: brandName 智能推断
```typescript
// 在 duliday_job_list 工具内部添加
if (!input.brandName) {
  // 从上下文/历史记录推断品牌
  const inferredBrand = inferBrandFromContext(context);
  if (inferredBrand) {
    input.brandName = inferredBrand;
  } else {
    return {
      error: "请先告诉我您想查询哪个品牌的岗位？比如肯德基、必胜客、奥乐齐等",
      suggestBrands: ["肯德基", "大米先生", "奥乐齐"]
    };
  }
}
```

#### 建议 2: 品牌名称模糊映射
```typescript
const brandMapping = {
  "必胜客": null, // 需要进一步确认城市
  "上海必胜客": "上海必胜客",
  "北京必胜客": "北京必胜客",
  "星巴克": null, // 不支持，引导用户
  "山姆": null, // 需要确认具体门店
  // ...
};

function resolveBrand(input: string, region?: string): string | null {
  // 1. 精确匹配
  if (supportedBrands.includes(input)) return input;

  // 2. 模糊匹配 + 地区推断
  if (input === "必胜客" && region) {
    const cityBrand = inferCityBrand(input, region);
    if (cityBrand) return cityBrand;
  }

  // 3. 返回建议
  return null;
}
```

### 6.2 Prompt 层优化 (优先级: 高)

#### 建议 1: 强化品牌确认规则
```markdown
## 岗位查询规则

在调用 duliday_job_list 之前，你必须：

1. **确认品牌名称**: 如果用户未提及品牌，先询问想查哪个品牌
2. **使用正确格式**: 品牌名必须带城市前缀，如"上海必胜客"而非"必胜客"
3. **限制重试次数**: 同一查询条件最多尝试 2 次，失败后询问用户

错误示例:
- ❌ 直接调用不传 brandName
- ❌ 使用"必胜客"而非"上海必胜客"
- ❌ 连续调用 3 次以上

正确流程:
1. 用户: "松江区有什么兼职？"
2. Agent: "你好！松江区这边有好几个品牌在招哈，肯德基、奥乐齐都有，你更想看哪个品牌的呢？"
3. 用户: "肯德基"
4. Agent: [调用 duliday_job_list(brandName="肯德基", regionName="松江区")]
```

#### 建议 2: 添加工具调用防护
```markdown
## 工具调用限制

- 单轮对话中，同一工具最多调用 3 次
- 连续 2 次调用失败后，必须向用户确认信息
- 禁止在用户简单回复（如"好的"、"嗯"）后发起新的岗位查询
```

### 6.3 流程层优化 (优先级: 中)

#### 建议 1: 调用链路控制
```typescript
// 在 AgentService 中添加调用计数器
class CallLimiter {
  private callCounts: Map<string, number> = new Map();

  canCall(toolName: string, limit: number = 3): boolean {
    const count = this.callCounts.get(toolName) || 0;
    return count < limit;
  }

  recordCall(toolName: string): void {
    const count = this.callCounts.get(toolName) || 0;
    this.callCounts.set(toolName, count + 1);
  }
}
```

#### 建议 2: 失败重试策略
```typescript
// 工具调用失败后的处理
if (toolResult.error) {
  if (callLimiter.getCount(toolName) >= 2) {
    // 停止重试，转人工确认模式
    return generateClarificationResponse(toolResult.error);
  }
  // 记录失败，允许带新参数重试
  callLimiter.recordCall(toolName);
}
```

### 6.4 监控层优化 (优先级: 中)

#### 建议 1: 工具调用成功率监控
```typescript
// 新增监控指标
interface ToolMetrics {
  toolName: string;
  totalCalls: number;
  successCalls: number;
  failureCalls: number;
  avgTokenUsage: number;
  avgDuration: number;
}

// 告警规则
if (successRate < 0.3) {
  alert(`工具 ${toolName} 成功率过低: ${successRate * 100}%`);
}
```

#### 建议 2: 重复调用检测
```typescript
// 检测单消息过度调用
if (sameToolCallCount > 4) {
  logger.warn(`异常重复调用: ${toolName} 被调用 ${sameToolCallCount} 次`);
  // 记录到监控系统
}
```

---

## 七、预期收益

### 优化前 vs 优化后对比

| 指标 | 优化前 | 优化后(预期) | 改善 |
|------|-------|-------------|------|
| duliday_job_list 成功率 | 17.1% | 60%+ | +43% |
| 平均工具调用次数/消息 | 2.75 | 1.5 | -45% |
| 平均 Token 消耗/消息 | ~15000 | ~8000 | -47% |
| Fallback 触发率 | 13.2% | <5% | -8% |

### 用户体验改善

1. **更快响应**: 减少无效工具调用，响应时间缩短
2. **更准确的结果**: 品牌映射优化后，一次查询即可找到岗位
3. **更自然的对话**: 主动确认信息而非反复失败重试

---

## 八、实施优先级

### Phase 1 (本周完成)
- [ ] Prompt 优化: 添加品牌确认规则和调用限制
- [ ] 工具优化: duliday_job_list 添加 brandName 缺失时的友好提示

### Phase 2 (下周完成)
- [ ] 工具优化: 实现品牌名称模糊匹配
- [ ] 流程优化: 添加调用计数器和重试控制

### Phase 3 (后续迭代)
- [ ] 监控优化: 添加工具调用成功率监控
- [ ] Fallback优化: 丰富 Fallback 话术，添加后续处理逻辑

---

## 附录

### A. 数据文件位置
- 原始数据: `/tmp/agent_all_data.json` (341条记录, 565MB)
- 分析数据: `/tmp/tool_analysis_341.json` (3.6MB)
- duliday_job_list 调用: `/tmp/job_list_calls.json`
- 重复调用案例: `/tmp/repeated_calls.json`

### B. 支持的品牌列表(完整)
```
肯德基, ZARA, 西贝莜面村, 哈根达斯, 波司登, 来伊份, 上海必胜客,
奥乐齐, 海底捞, 李维斯, 摩提工房-西树泡芙, 成都你六姐, 大米先生,
安徽肯德基, 宁波必胜客, 上海来伊份, 北京肯德基, 北京必胜客,
天津肯德基, Drunk Baker, 嘉定山姆, 成都必胜客, 小肥羊, 黄记煌,
成都肯德基, 杭州肯德基, 成都拉瓦萨, 深圳肯德基, 广州肯德基,
高科西山姆, 嘉松中路山姆, 普陀真如山姆, 佛山必胜客, M Stand,
塔可贝尔, 左庭右院, 大连肯德基, 可可牛
```
