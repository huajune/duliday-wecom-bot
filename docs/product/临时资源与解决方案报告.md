# 企业微信智能服务 - 临时资源与解决方案报告

> **项目**: DuLiDay 企业微信智能服务中间层
> **版本**: v1.1.0
> **报告日期**: 2025-12-05
> **报告人**: 技术团队

---

## 一、项目概述

本项目是连接企业微信托管平台与 AI Agent 服务的中间层，负责：
- 接收企业微信消息回调
- 调用 AI Agent API 生成智能回复
- 通过托管平台 API 发送回复

### 当前业务数据
| 指标 | 数值 | 说明 |
|------|------|------|
| 日均消息量 | ~1,400 条 | 最近 5 天平均 |
| 总消息记录 | 7,161 条 | 自 2025-11-27 起 |
| 数据库大小 | ~6.3 MB | 主要是 chat_messages 表 |

---

## 二、临时资源清单

### 🔴 P0 - 紧急（影响服务稳定性）

#### 1. Upstash Redis - 免费套餐已用尽

| 项目 | 当前状态 | 问题 |
|------|----------|------|
| **服务商** | Upstash (Serverless Redis) | 第三方云服务 |
| **套餐** | Free 免费版 | 已触发限制 |
| **请求限制** | 500,000 次/月 | ❌ 已用尽，服务无法启动 |
| **存储限制** | 256 MB | ✅ 未触发 |
| **实际用量** | ~52,000 次/天 ≈ 156 万次/月 | 超出免费额度 3 倍 |

**影响**：
- 服务启动报错：`ERR max requests limit exceeded`
- Bull Queue 无法连接 Redis
- 消息聚合功能失效

**临时措施**：
- 当前通过 `ENABLE_BULL_QUEUE=false` 禁用队列功能（已回滚）
- 需要立即升级套餐

---

### 🟡 P1 - 重要（影响长期运营）

#### 2. Supabase 数据库 - 免费套餐

| 项目 | 当前状态 | 限制 |
|------|----------|------|
| **服务商** | Supabase (PostgreSQL) | 第三方云服务 |
| **套餐** | Free 免费版 | 有限制 |
| **数据库大小** | 500 MB | 当前使用 ~6.3 MB |
| **存储空间** | 1 GB | 用于品牌配置文件 |
| **API 请求** | 无限制 | ✅ |
| **Edge Functions** | 500K 次/月 | 未使用 |

**风险**：
- 数据增长后可能触发 500MB 限制
- 按当前增速，约 6 个月后可能达到限制
- 无 SLA 保障，可能影响生产稳定性

#### 3. 花卷 Agent API - 外部依赖

| 项目 | 当前状态 | 说明 |
|------|----------|------|
| **服务商** | 花卷 (huajune.duliday.com) | AI Agent 服务 |
| **计费模式** | 按 Token 计费 | 具体费率需确认 |
| **可用模型** | Claude Sonnet 4.5, GPT-5.1 等 | 多模型支持 |
| **SLA** | 未知 | 需要确认服务等级协议 |

**风险**：
- 外部服务依赖，无法控制可用性
- 费用随使用量增长

#### 4. Stride 托管平台 - 外部依赖

| 项目 | 当前状态 | 说明 |
|------|----------|------|
| **服务商** | Stride (stride-bg.dpclouds.com) | 企业微信托管 |
| **接口类型** | 小组级 + 企业级 API | 双接口 |
| **计费模式** | 已付费 | - |

---

### 🟢 P2 - 一般（技术债务）

#### 5. 代码中的 TODO 待办项

| 位置 | 内容 | 优先级 |
|------|------|--------|
| monitoring.service.ts:721 | 预约结果提取逻辑待实现 | 中 |
| monitoring.service.ts:922 | 群聊支持待实现 | 低 |
| monitoring.service.ts:1419 | 埋点计数逻辑待实现 | 中 |
| monitoring.service.ts:1473-1474 | 新老用户区分待实现 | 中 |
| monitoring.service.ts:1496 | 数据对比逻辑待实现 | 低 |

#### 6. 部署环境 - 本地开发

| 项目 | 当前状态 | 问题 |
|------|----------|------|
| **部署方式** | 本地运行 (localhost:8080) | 无生产环境 |
| **CI/CD** | GitHub Actions (版本管理) | 未部署到云端 |
| **监控** | 内置 Dashboard | 仅本地可访问 |

---

## 三、资源可承载时间分析

基于实际数据计算各资源的剩余可用时间：

### Upstash Redis（免费版）

| 指标 | 数值 |
|------|------|
| 月限制 | 500,000 次请求 |
| 实际日用量 | ~52,000 次（业务 + Bull Queue） |
| **可用天数** | **~9.6 天/月** |
| 当前状态 | ❌ **已用尽，服务无法启动** |

### Supabase 数据库（免费版）

| 指标 | 数值 |
|------|------|
| 存储限制 | 500 MB |
| 当前使用 | 6.3 MB |
| 剩余空间 | ~494 MB |
| 日均消息 | ~1,400 条 |
| 每条消息 | ~877 字节 |
| **日增量** | **~1.2 MB/天** |
| **可用时间** | **~14 个月** |

### 资源紧迫程度汇总

| 资源 | 可承载时间 | 紧迫程度 |
|------|-----------|----------|
| **Upstash Redis** | 0 天（已超限） | 🔴 **立即** |
| **Supabase** | ~14 个月 | 🟢 不急 |
| 花卷 Agent | 按量付费，无限制 | 🟢 不急 |
| Stride 托管 | 已付费 | 🟢 不急 |

---

## 四、阶梯解决方案

### 第一阶段：紧急修复（立即）

> **触发条件**：Redis 已超限，服务无法启动

#### 💰 预算：$10/月

| 任务 | 方案 | 费用 | 说明 |
|------|------|------|------|
| **升级 Upstash Redis** | Fixed 250MB 套餐 | **$10/月** | 无请求限制，解决当前问题 |

**操作步骤**：
1. 登录 Upstash Console (https://console.upstash.com)
2. 进入 Redis 数据库 "Bot"
3. 点击 "Upgrade" 选择 Fixed 250MB 套餐
4. 绑定公司信用卡完成支付

**效果**：
- ✅ 服务立即恢复正常
- ✅ 无请求次数限制
- ✅ 支持当前及未来 10 倍业务增长
---

### 第二阶段：数据库升级（约 10 个月后）

> **触发条件**：Supabase 存储使用超过 300MB（约 60%）

#### 💰 预算：$35/月

| 任务 | 方案 | 费用 | 说明 |
|------|------|------|------|
| Upstash Redis | Fixed 250MB | $10/月 | 已完成 |
| **Supabase 升级** | Pro 套餐 | **$25/月** | 8GB 数据库 + SLA 保障 |
| 合计 | - | **$35/月** | - |

**Supabase Pro 套餐包含**：
- 8 GB 数据库存储（当前 6.3MB，可用 1000+ 倍）
- 100 GB 文件存储
- 每日自动备份（7 天保留）
- Email 支持
- 无 API 限制

**操作步骤**：
1. 登录 Supabase Dashboard
2. 进入项目设置 → Billing
3. 升级到 Pro 套餐
4. 绑定公司信用卡

---

### 第三阶段：正式上线（按业务需求）

> **触发条件**：业务需要稳定的生产环境部署

#### 💰 预算：$50-100/月

| 任务 | 方案 | 费用 | 说明 |
|------|------|------|------|
| Upstash Redis | Fixed 250MB | $10/月 | - |
| Supabase | Pro | $25/月 | - |
| **云服务器部署** | 阿里云/腾讯云 ECS | **$15-65/月** | 2C4G 轻量级实例 |
| 合计 | - | **$50-100/月** | - |

**云服务器选项**：

| 方案 | 配置 | 价格 | 适用场景 |
|------|------|------|----------|
| 阿里云轻量应用服务器 | 2C2G | ¥99/年 (~$15/月均摊) | 测试/轻负载 |
| 腾讯云轻量应用服务器 | 2C4G | ¥150/年 (~$20/月均摊) | 推荐 |
| 阿里云 ECS | 2C4G | ¥200-400/月 | 生产环境 |

**部署架构**：
```
                    ┌─────────────────┐
                    │   企业微信用户   │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │  Stride 托管平台  │
                    └────────┬────────┘
                             │ Webhook
                    ┌────────▼────────┐
                    │   云服务器 ECS    │
                    │  (NestJS 服务)   │
                    └──┬─────┬─────┬──┘
                       │     │     │
          ┌────────────┘     │     └────────────┐
          │                  │                  │
  ┌───────▼───────┐  ┌───────▼───────┐  ┌───────▼───────┐
  │ Upstash Redis │  │   Supabase    │  │  花卷 Agent   │
  │   (缓存/队列)  │  │  (数据库)     │  │   (AI API)   │
  └───────────────┘  └───────────────┘  └───────────────┘
```

---

### 第四阶段：规模化（3-6 个月）

#### 💰 预算：$200-500/月

| 任务 | 方案 | 费用 | 说明 |
|------|------|------|------|
| Redis | Upstash Fixed 1GB 或自建 | $20-50/月 | 根据业务增长 |
| 数据库 | Supabase Pro 或 RDS | $25-100/月 | 根据数据量 |
| 服务器 | 云服务器集群 | $100-200/月 | 高可用部署 |
| CDN/负载均衡 | 按需 | $20-50/月 | 流量增长后 |
| 监控告警 | 专业 APM | $30-100/月 | 可选 |

---

## 四、费用汇总

| 阶段 | 时间 | 月费用 | 年费用 | 主要内容 |
|------|------|--------|--------|----------|
| **第一阶段** | 本周 | **$10** | $120 | Redis 升级 |
| **第二阶段** | 1-2 周 | **$35** | $420 | + Supabase 升级 |
| **第三阶段** | 1 个月 | **$50-100** | $600-1,200 | + 云服务器 |
| **第四阶段** | 3-6 个月 | **$200-500** | $2,400-6,000 | 规模化部署 |

---

## 五、建议与行动项

### 🚨 立即行动（本周）
1. [ ] **申请 $10/月预算**，升级 Upstash Redis 到 Fixed 250MB 套餐
2. [ ] 恢复服务正常运行

### 📋 短期计划（2 周内）
3. [ ] 评估 Supabase 升级需求
4. [ ] 确认花卷 Agent API 费用和 SLA
5. [ ] 确认 Stride 托管平台费用

### 📅 中期计划（1 个月内）
6. [ ] 选择云服务器方案
7. [ ] 配置生产环境部署
8. [ ] 设置监控和告警

### 🎯 长期规划（3 个月+）
9. [ ] 清理代码中的 TODO 待办项
10. [ ] 实现数据统计和分析功能
11. [ ] 考虑高可用架构

---

## 六、附录

### A. 当前第三方服务清单

| 服务 | 用途 | 当前套餐 | 账号 |
|------|------|----------|------|
| Upstash | Redis 缓存/队列 | Free (已超限) | 1599442134@qq.com |
| Supabase | PostgreSQL 数据库 | Free | - |
| 花卷 Agent | AI API | 按量付费 | - |
| Stride | 企业微信托管 | - | - |
| 飞书机器人 | 告警通知 | 免费 | - |

### B. 环境变量清单

```bash
# 需要公司资源的配置项
UPSTASH_REDIS_REST_URL=        # Redis 服务
UPSTASH_REDIS_REST_TOKEN=      # Redis 密钥
UPSTASH_REDIS_TCP_URL=         # Redis TCP (Bull Queue)
NEXT_PUBLIC_SUPABASE_URL=      # 数据库服务
SUPABASE_SERVICE_ROLE_KEY=     # 数据库密钥
AGENT_API_KEY=                 # AI 服务密钥
AGENT_API_BASE_URL=            # AI 服务地址
```

### C. 参考链接

- [Upstash 定价](https://upstash.com/pricing/redis)
- [Supabase 定价](https://supabase.com/pricing)
- [阿里云轻量应用服务器](https://www.aliyun.com/product/swas)
- [腾讯云轻量应用服务器](https://cloud.tencent.com/product/lighthouse)

---

**报告结束**

如有疑问，请联系技术团队。
