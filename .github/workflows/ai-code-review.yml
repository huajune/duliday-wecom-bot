name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - develop
      - main
      - master

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  ai-code-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Get changed files
        id: changed-files
        run: |
          # è·å– PR ä¸­ä¿®æ”¹çš„æ–‡ä»¶åˆ—è¡¨ï¼ˆæ”¯æŒæ‰€æœ‰ TS/JS æ‰©å±•åï¼‰
          git fetch origin ${{ github.event.pull_request.base.ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | grep -E '\.(ts|js|tsx|jsx|mts|cts|mjs|cjs|d\.ts)$' || echo "")

          if [ -z "$CHANGED_FILES" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No TypeScript/JavaScript files changed"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "changed_files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            # ç»Ÿè®¡æ–‡ä»¶æ•°é‡
            FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l)
            echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT

            echo "Found $FILE_COUNT changed TypeScript/JavaScript files"
          fi

      - name: Get file diffs
        id: get-diffs
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}

          # ä½¿ç”¨ git diff --numstat ç²¾ç¡®ç»Ÿè®¡è¡Œæ•°ï¼ˆåŸºäºå®Œæ•´ diffï¼‰
          STATS=$(git diff --numstat origin/${{ github.event.pull_request.base.ref }}...HEAD -- '*.ts' '*.js' '*.tsx' '*.jsx' '*.mts' '*.cts' '*.mjs' '*.cjs' '*.d.ts')

          # è®¡ç®—æ–°å¢å’Œåˆ é™¤çš„æ€»è¡Œæ•°
          ADDED_LINES=$(echo "$STATS" | awk '{sum += $1} END {print sum}' || echo "0")
          REMOVED_LINES=$(echo "$STATS" | awk '{sum += $2} END {print sum}' || echo "0")

          # è·å–æ‰€æœ‰å˜æ›´çš„è¯¦ç»† diffï¼ˆé™åˆ¶å¤§å°ä»¥é¿å…è¶…å‡º API é™åˆ¶ï¼Œä»…ç”¨äº AI å®¡æŸ¥ï¼‰
          DIFF_OUTPUT=$(git diff origin/${{ github.event.pull_request.base.ref }}...HEAD -- '*.ts' '*.js' '*.tsx' '*.jsx' '*.mts' '*.cts' '*.mjs' '*.cjs' '*.d.ts' | head -c 50000)

          # ä¿å­˜åˆ°æ–‡ä»¶
          echo "$DIFF_OUTPUT" > /tmp/pr-diff.txt

          echo "added_lines=$ADDED_LINES" >> $GITHUB_OUTPUT
          echo "removed_lines=$REMOVED_LINES" >> $GITHUB_OUTPUT

          echo "Changes: +$ADDED_LINES -$REMOVED_LINES lines"

      - name: AI Code Review with Anthropic Claude
        id: ai-review
        if: steps.changed-files.outputs.has_changes == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # è°ƒç”¨ç‹¬ç«‹è„šæœ¬æ‰§è¡Œ AI review
          bash .github/scripts/ai-code-review.sh /tmp/pr-diff.txt /tmp/review-result.md

      - name: Post review comment
        if: steps.changed-files.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        env:
          FILE_COUNT: ${{ steps.changed-files.outputs.file_count }}
          ADDED_LINES: ${{ steps.get-diffs.outputs.added_lines }}
          REMOVED_LINES: ${{ steps.get-diffs.outputs.removed_lines }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // è¯»å– AI å®¡æŸ¥ç»“æœ
            let reviewContent;
            try {
              reviewContent = fs.readFileSync('/tmp/review-result.md', 'utf8');
            } catch (error) {
              reviewContent = 'âš ï¸ AI review was skipped (ANTHROPIC_API_KEY not configured)\n\nTo enable AI code review, please add your Anthropic API key as a repository secret named `ANTHROPIC_API_KEY`.';
            }

            // æ„å»ºè¯„è®ºå†…å®¹
            const comment = '## ğŸ¤– AI Code Review\n\n' +
              '**Changes Summary:**\n' +
              `- ğŸ“ Files changed: ${process.env.FILE_COUNT ?? 'N/A'}\n` +
              `- â• Lines added: ${process.env.ADDED_LINES ? Number(process.env.ADDED_LINES) : 'N/A'}\n` +
              `- â– Lines removed: ${process.env.REMOVED_LINES ? Number(process.env.REMOVED_LINES) : 'N/A'}\n\n` +
              '---\n\n' +
              `${reviewContent}\n\n` +
              '---\n\n' +
              `<sub>Powered by Claude Sonnet 4.5 ğŸš€ | [View Workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})</sub>`

            // æ£€æŸ¥æ˜¯å¦å·²æœ‰ AI review è¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ğŸ¤– AI Code Review')
            );

            // æ›´æ–°æˆ–åˆ›å»ºè¯„è®º
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
              console.log('Updated existing AI review comment');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
              console.log('Created new AI review comment');
            }

      - name: Summary
        if: steps.changed-files.outputs.has_changes == 'false'
        run: |
          echo "âœ… No TypeScript/JavaScript files changed, skipping AI review"
