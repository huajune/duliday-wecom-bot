name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - develop
      - main
      - master

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  ai-code-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Get changed files
        id: changed-files
        run: |
          # è·å– PR ä¸­ä¿®æ”¹çš„æ–‡ä»¶åˆ—è¡¨
          git fetch origin ${{ github.event.pull_request.base.ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | grep -E '\.(ts|js|tsx|jsx)$' || echo "")

          if [ -z "$CHANGED_FILES" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No TypeScript/JavaScript files changed"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "changed_files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            # ç»Ÿè®¡æ–‡ä»¶æ•°é‡
            FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l)
            echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT

            echo "Found $FILE_COUNT changed TypeScript/JavaScript files"
          fi

      - name: Get file diffs
        id: get-diffs
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}

          # è·å–æ‰€æœ‰å˜æ›´çš„è¯¦ç»† diffï¼ˆé™åˆ¶å¤§å°ä»¥é¿å…è¶…å‡º API é™åˆ¶ï¼‰
          DIFF_OUTPUT=$(git diff origin/${{ github.event.pull_request.base.ref }}...HEAD -- '*.ts' '*.js' '*.tsx' '*.jsx' | head -c 50000)

          # ä¿å­˜åˆ°æ–‡ä»¶
          echo "$DIFF_OUTPUT" > /tmp/pr-diff.txt

          # ç»Ÿè®¡å˜æ›´è¡Œæ•°
          ADDED_LINES=$(echo "$DIFF_OUTPUT" | grep -c "^+" || echo "0")
          REMOVED_LINES=$(echo "$DIFF_OUTPUT" | grep -c "^-" || echo "0")

          echo "added_lines=$ADDED_LINES" >> $GITHUB_OUTPUT
          echo "removed_lines=$REMOVED_LINES" >> $GITHUB_OUTPUT

          echo "Changes: +$ADDED_LINES -$REMOVED_LINES lines"

      - name: AI Code Review with Anthropic Claude
        id: ai-review
        if: steps.changed-files.outputs.has_changes == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # å¦‚æœæ²¡æœ‰é…ç½® API Keyï¼Œè·³è¿‡ AI å®¡æŸ¥
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "âš ï¸  ANTHROPIC_API_KEY not configured, skipping AI review"
            echo "review_result=API key not configured" >> $GITHUB_OUTPUT
            exit 0
          fi

          # è¯»å– diff å†…å®¹
          DIFF_CONTENT=$(cat /tmp/pr-diff.txt)

          # è¯»å–é¡¹ç›®è§„èŒƒï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          PROJECT_RULES=""
          if [ -f ".cursorrules" ]; then
            PROJECT_RULES=$(cat .cursorrules | head -c 10000)
          fi

          # æ„å»ºå®¡æŸ¥æç¤ºè¯
          REVIEW_PROMPT="You are an expert code reviewer for a NestJS TypeScript project.

Project Context:
- Tech Stack: NestJS 10.3, TypeScript 5.3, Node.js 20+
- Architecture: DDD layered architecture with 4 business domains
- This is an enterprise WeChat intelligent service middleware

Project Coding Standards:
$PROJECT_RULES

Please review the following code changes and provide:
1. **Critical Issues** (bugs, security, performance problems)
2. **Code Quality** (TypeScript best practices, NestJS patterns)
3. **Architecture Concerns** (violations of DDD principles, wrong layer usage)
4. **Suggestions** (improvements, optimizations)

Focus on:
- TypeScript strict typing (no 'any' abuse)
- NestJS dependency injection patterns
- Proper error handling
- Security issues (hardcoded secrets, SQL injection, XSS)
- Performance issues
- Code maintainability

Code Changes:
\`\`\`diff
$DIFF_CONTENT
\`\`\`

Provide your review in markdown format with clear sections."

          # è°ƒç”¨ Anthropic APIï¼ˆä½¿ç”¨æœ€æ–°çš„ Claude Sonnet 4.5 æ¨¡å‹ï¼‰
          RESPONSE=$(curl -s -X POST https://api.anthropic.com/v1/messages \
            -H "content-type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "{
              \"model\": \"claude-sonnet-4-20250514\",
              \"max_tokens\": 8192,
              \"messages\": [
                {
                  \"role\": \"user\",
                  \"content\": $(echo "$REVIEW_PROMPT" | jq -Rs .)
                }
              ]
            }")

          # æå–å®¡æŸ¥ç»“æœ
          REVIEW_TEXT=$(echo "$RESPONSE" | jq -r '.content[0].text // "AI review failed"')

          # ä¿å­˜å®¡æŸ¥ç»“æœåˆ°æ–‡ä»¶ï¼ˆç”¨äºåç»­æ­¥éª¤ï¼‰
          echo "$REVIEW_TEXT" > /tmp/review-result.md

          echo "AI review completed"

      - name: Post review comment
        if: steps.changed-files.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        env:
          FILE_COUNT: ${{ steps.changed-files.outputs.file_count }}
          ADDED_LINES: ${{ steps.get-diffs.outputs.added_lines }}
          REMOVED_LINES: ${{ steps.get-diffs.outputs.removed_lines }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // è¯»å– AI å®¡æŸ¥ç»“æœ
            let reviewContent;
            try {
              reviewContent = fs.readFileSync('/tmp/review-result.md', 'utf8');
            } catch (error) {
              reviewContent = 'âš ï¸ AI review was skipped (ANTHROPIC_API_KEY not configured)\n\nTo enable AI code review, please add your Anthropic API key as a repository secret named `ANTHROPIC_API_KEY`.';
            }

            // æ„å»ºè¯„è®ºå†…å®¹
            const comment = `## ğŸ¤– AI Code Review

**Changes Summary:**
- ğŸ“ Files changed: ${process.env.FILE_COUNT}
- â• Lines added: ${process.env.ADDED_LINES}
- â– Lines removed: ${process.env.REMOVED_LINES}

---

${reviewContent}

---

<sub>Powered by Claude Sonnet 4.5 ğŸš€ | [View Workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})</sub>`;

            // æ£€æŸ¥æ˜¯å¦å·²æœ‰ AI review è¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ğŸ¤– AI Code Review')
            );

            // æ›´æ–°æˆ–åˆ›å»ºè¯„è®º
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
              console.log('Updated existing AI review comment');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
              console.log('Created new AI review comment');
            }

      - name: Summary
        if: steps.changed-files.outputs.has_changes == 'false'
        run: |
          echo "âœ… No TypeScript/JavaScript files changed, skipping AI review"
