# DuLiDay 企业微信服务 - 架构设计说明书

## 目录

- [1. 系统概述](#1-系统概述)
- [2. 架构设计](#2-架构设计)
- [3. 技术栈](#3-技术栈)
- [4. 核心模块详解](#4-核心模块详解)
- [5. 数据流设计](#5-数据流设计)
- [6. 接口设计](#6-接口设计)
- [7. 部署架构](#7-部署架构)
- [8. 扩展性设计](#8-扩展性设计)

---

## 1. 系统概述

### 1.1 系统定位

DuLiDay 企业微信服务是一个基于 NestJS 的**中间层服务**，在企业微信托管平台和 AI 智能服务之间提供桥接和编排能力。

```
┌─────────────────┐
│  企业微信用户    │
└────────┬────────┘
         │
         ▼
┌─────────────────────────┐
│  企业微信托管平台        │
│  (第三方托管服务)        │
└────────┬────────────────┘
         │ 消息回调/API 调用
         ▼
┌─────────────────────────┐
│  DuLiDay 企业微信服务   │  ◄─── 本系统
│  (中间层/编排层)        │
└────────┬────────────────┘
         │ AI API 调用
         ▼
┌─────────────────────────┐
│  花卷agent             │
│  (AI 智能服务)          │
└─────────────────────────┘
```

### 1.2 核心价值

- **解耦**：将托管平台 API 和 AI 服务解耦，提供统一的业务逻辑层
- **编排**：协调消息接收、AI 处理、消息发送的完整流程
- **扩展**：提供可扩展的模块化架构，支持业务功能快速迭代
- **管理**：管理会话上下文、消息历史、配置信息等状态

### 1.3 核心功能

1. **托管平台 API 封装**
   - 消息发送（单发/群发）
   - 会话管理（列表/历史）
   - 联系人管理（添加/删除）
   - 群聊管理（创建/成员管理）
   - 客户管理、机器人管理

2. **AI 智能回复**
   - 接收消息回调
   - 调用 AI 生成回复
   - 多轮对话管理
   - 流式/非流式响应

3. **业务编排**
   - 消息路由和过滤
   - 会话上下文管理
   - 场景识别（私聊/群聊）
   - 自动化流程控制

---

## 2. 架构设计

### 2.1 整体架构

本项目采用**分层架构**设计，分为四个层次：

```
┌─────────────────────────────────────────────────────────┐
│                     Presentation Layer                   │
│                      (表示层/接口层)                       │
│  Controllers: 提供 RESTful API 接口                      │
└─────────────────────────────────────────────────────────┘
                          │
┌─────────────────────────────────────────────────────────┐
│                      Business Layer                      │
│                       (业务逻辑层)                        │
│  Services: 实现核心业务逻辑                               │
│  - 消息处理 (MessageService)                             │
│  - AI 对话 (AgentService)                                │
│  - 消息发送 (MessageSenderService)                       │
└─────────────────────────────────────────────────────────┘
                          │
┌─────────────────────────────────────────────────────────┐
│                      Common Layer                        │
│                       (共享服务层)                        │
│  - 会话管理 (ConversationService)                        │
│  - 配置管理 (ConfigService)                              │
└─────────────────────────────────────────────────────────┘
                          │
┌─────────────────────────────────────────────────────────┐
│                      Infrastructure Layer                │
│                       (基础设施层)                        │
│  - HTTP 客户端 (HttpService)                             │
│  - 日志服务 (Logger)                                     │
│  - 环境配置 (ConfigModule)                               │
└─────────────────────────────────────────────────────────┘
```

### 2.2 模块划分

项目采用 NestJS 的模块化设计，各模块职责清晰：

```
src/
├── core/                          # 核心基础设施层
│   ├── config/                    # 配置管理模块
│   │   ├── api-config.module.ts
│   │   └── api-config.service.ts
│   └── http/                      # HTTP 客户端模块
│       ├── http.module.ts
│       ├── http.service.ts
│       └── http.controller.ts
│
├── common/                        # 共享服务层
│   └── conversation/              # 会话管理模块
│       ├── conversation.module.ts
│       ├── conversation.service.ts
│       └── dto/
│
├── agent/                         # AI 智能服务层
│   ├── agent.module.ts
│   ├── agent.service.ts          # AI 对话核心服务
│   ├── agent-config.service.ts   # AI 配置管理
│   ├── agent.controller.ts
│   ├── dto/
│   └── interfaces/
│
├── modules/                       # 业务模块层
│   ├── message/                   # 消息接收模块
│   │   ├── message.module.ts
│   │   ├── message.service.ts    # 消息处理和AI回复编排
│   │   ├── message.controller.ts # 接收托管平台回调
│   │   └── dto/
│   ├── message-sender/            # 消息发送模块
│   │   ├── message-sender.module.ts
│   │   ├── message-sender.service.ts
│   │   ├── message-sender.controller.ts
│   │   └── dto/
│   ├── chat/                      # 会话查询模块
│   │   ├── chat.module.ts
│   │   ├── chat.service.ts
│   │   └── chat.controller.ts
│   ├── contact/                   # 联系人管理模块
│   ├── room/                      # 群聊管理模块
│   ├── customer/                  # 客户管理模块
│   ├── user/                      # 用户管理模块
│   └── bot/                       # 机器人管理模块
│
├── app.module.ts                  # 根模块
└── main.ts                        # 应用入口
```

### 2.3 模块依赖关系

```
┌─────────────────────────────────────────────────────────┐
│                       AppModule                          │
└───────────────────────┬─────────────────────────────────┘
                        │
        ┌───────────────┼───────────────┐
        │               │               │
        ▼               ▼               ▼
  ┌──────────┐    ┌──────────┐   ┌──────────┐
  │  Core    │    │ Common   │   │  Agent   │
  │  Layer   │    │  Layer   │   │  Layer   │
  └─────┬────┘    └────┬─────┘   └────┬─────┘
        │              │              │
        └──────────────┼──────────────┘
                       │
        ┌──────────────┼──────────────┐
        │              │              │
        ▼              ▼              ▼
  ┌──────────┐  ┌──────────┐  ┌──────────┐
  │ Message  │  │ Message  │  │  Chat    │
  │          │  │  Sender  │  │          │
  └──────────┘  └──────────┘  └──────────┘
        │              │              │
        └──────────────┼──────────────┘
                       │
        ┌──────────────┼──────────────┐
        ▼              ▼              ▼
  ┌──────────┐  ┌──────────┐  ┌──────────┐
  │ Contact  │  │  Room    │  │ Customer │
  └──────────┘  └──────────┘  └──────────┘
```

**依赖原则**：
- 业务模块可以依赖 Common 和 Core 层
- 业务模块之间可以相互依赖（如 Message 依赖 MessageSender）
- Core 和 Common 层不依赖业务模块
- 遵循依赖倒置原则，面向接口编程

---

## 3. 技术栈

### 3.1 核心框架

| 技术 | 版本 | 用途 |
|------|------|------|
| **NestJS** | 10.x | 后端框架，提供模块化架构和依赖注入 |
| **TypeScript** | 5.x | 开发语言，提供类型安全 |
| **Node.js** | 20.x+ | 运行时环境 |

### 3.2 核心依赖

| 库 | 用途 |
|------|------|
| **@nestjs/config** | 环境变量和配置管理 |
| **@nestjs/schedule** | 定时任务（如会话清理） |
| **@nestjs/swagger** | API 文档生成 |
| **axios** | HTTP 客户端，调用第三方 API |
| **class-validator** | DTO 参数验证 |
| **class-transformer** | 对象转换 |
| **winston** | 日志管理 |
| **winston-daily-rotate-file** | 日志按日期归档 |

### 3.3 开发工具

| 工具 | 用途 |
|------|------|
| **ESLint** | 代码静态检查 |
| **Prettier** | 代码格式化 |
| **Jest** | 单元测试和集成测试 |
| **Supertest** | API 端到端测试 |

---

## 4. 核心模块详解

### 4.1 Core Layer（核心层）

#### 4.1.1 HttpService - HTTP 客户端

**职责**：提供统一的 HTTP 请求能力，封装 axios

**核心特性**：
- 统一的请求/响应拦截器
- 自动日志记录
- 错误处理和重试
- 超时控制

**代码位置**：`src/core/http/http.service.ts`

**关键方法**：
```typescript
class HttpService {
  async get(url: string, params?: any): Promise<any>
  async post(url: string, data?: any): Promise<any>
}
```

**使用场景**：
- 调用托管平台 API
- 调用第三方服务

#### 4.1.2 ApiConfigService - API 配置管理

**职责**：集中管理第三方 API 的基础配置

**代码位置**：`src/core/config/api-config.service.ts`

**配置项**：
- 托管平台 API Base URL
- Agent API Base URL
- 超时时间
- 重试策略

---

### 4.2 Common Layer（共享层）

#### 4.2.1 ConversationService - 会话管理

**职责**：管理多轮对话的消息历史和上下文

**核心特性**：
- 会话 ID 生成（区分私聊/群聊）
- 消息历史存储（内存存储）
- 消息数量限制（最多 50 条）
- 会话超时清理（2 小时）
- 定时清理过期会话

**代码位置**：`src/common/conversation/conversation.service.ts`

**关键方法**：
```typescript
class ConversationService {
  // 生成会话 ID
  generateConversationId(fromUser: string, roomId?: string, isRoom?: boolean): string

  // 获取会话历史
  getHistory(conversationId: string): any[]

  // 添加消息
  addMessage(conversationId: string, message: any): void

  // 清空会话
  clearConversation(conversationId: string): void

  // 获取统计信息
  getStats(conversationId: string): ConversationStatsDto
}
```

**会话 ID 规则**：
- 私聊：`user_{wxid}`
- 群聊：`room_{roomId}`

**存储策略**：
```typescript
// 内存存储结构
private conversations = new Map<string, any[]>()
private lastActivity = new Map<string, number>()

// 限制参数
maxMessagesPerConversation = 50        // 最多 50 条消息
conversationTimeout = 2 * 60 * 60 * 1000  // 2 小时超时
```

---

### 4.3 Agent Layer（AI 层）

#### 4.3.1 AgentService - AI 对话服务

**职责**：调用 花卷agent AI API，处理智能对话

**核心特性**：
- 非流式对话（chat）
- 流式对话（chatStream）
- 自动管理会话历史
- 支持系统提示词
- 支持工具调用
- 健康检查

**代码位置**：`src/agent/agent.service.ts`

**关键方法**：

```typescript
class AgentService {
  // 非流式对话
  async chat(params: {
    conversationId: string
    userMessage: string
    model?: string
    systemPrompt?: string
    promptType?: string
    allowedTools?: string[]
    context?: any
    toolContext?: any
  }): Promise<ChatResponse>

  // 流式对话
  async chatStream(params: {
    conversationId: string
    userMessage: string
    // ... 其他参数
    onTextDelta?: (delta: string) => void
    onToolCall?: (toolName: string, args: any) => void
    onComplete?: (fullText: string) => void
    onError?: (error: any) => void
  }): Promise<string>

  // 简单回复（兼容旧接口）
  async generateReply(message: string, context?: any): Promise<{
    reply: string
    usage: any
    tools: any
  }>

  // 获取可用模型
  async getModels(): Promise<any>

  // 获取可用工具
  async getTools(): Promise<any>

  // 健康检查
  async healthCheck(): Promise<{
    status: string
    baseURL: string
    message: string
  }>
}
```

**AI API 配置**：
```typescript
private readonly apiKey: string        // API 密钥
private readonly baseURL: string       // API 地址
private readonly defaultModel: string  // 默认模型
```

**HTTP 客户端配置**：
```typescript
{
  baseURL: 'https://api.wolian.cc/api/v1',
  timeout: 60000,  // 60秒超时
  headers: {
    Authorization: `Bearer ${apiKey}`,
    'Content-Type': 'application/json'
  }
}
```

#### 4.3.2 AgentConfigService - AI 配置管理

**职责**：管理 AI 场景配置和系统提示词

**代码位置**：`src/agent/agent-config.service.ts`

**场景配置**：
```typescript
enum ScenarioType {
  GENERAL = 'general',        // 通用场景
  CUSTOMER_SERVICE = 'customer_service',  // 客服场景
  SALES = 'sales',            // 销售场景
  RECRUITMENT = 'recruitment' // 招聘场景
}
```

---

### 4.4 Modules Layer（业务模块层）

#### 4.4.1 MessageModule - 消息接收和处理

**职责**：接收托管平台的消息回调，编排 AI 回复流程

**核心流程**：
```
接收消息回调
    ↓
解析消息数据
    ↓
判断是否需要 AI 回复
    ↓
生成会话 ID
    ↓
调用 AgentService 生成回复
    ↓
调用 MessageSenderService 发送回复
    ↓
返回成功响应
```

**代码位置**：`src/modules/message/message.service.ts`

**关键方法**：
```typescript
class MessageService {
  // 处理消息回调
  async handleMessage(messageData: IncomingMessageData): Promise<{
    success: boolean
    message?: string
    error?: string
  }>

  // 使用 AI 处理消息
  private async processMessageWithAI(messageData: IncomingMessageData): Promise<void>

  // 解析消息数据（兼容新旧格式）
  private parseMessageData(messageData: any): ParsedMessageData
}
```

**消息过滤逻辑**：
```typescript
// 跳过机器人自己发送的消息
if (isSelf) return

// 只处理文本消息
if (messageType !== 7) return

// 群聊可选：只处理 @ 机器人的消息
// if (isRoom && !mentionSelf) return
```

**配置项**：
```typescript
ENABLE_AI_REPLY=true  // 是否启用 AI 自动回复
```

#### 4.4.2 MessageSenderModule - 消息发送

**职责**：调用托管平台 API 发送消息

**代码位置**：`src/modules/message-sender/message-sender.service.ts`

**关键方法**：
```typescript
class MessageSenderService {
  // 发送单条消息
  async sendMessage(dto: SendMessageDto): Promise<any>

  // 群发消息
  async broadcastMessage(dto: BroadcastMessageDto): Promise<any>
}
```

**消息类型**：
```typescript
enum MessageType {
  TEXT = 1,      // 文本
  IMAGE = 3,     // 图片
  VOICE = 34,    // 语音
  VIDEO = 43     // 视频
}
```

#### 4.4.3 ChatModule - 会话查询

**职责**：获取会话列表和聊天历史

**关键方法**：
```typescript
class ChatService {
  // 获取会话列表
  async getConversationList(params: {
    token: string
    pageSize?: number
    iterator?: string
  }): Promise<any>

  // 获取聊天历史
  async getChatHistory(params: {
    token: string
    snapshotDay: string
    pageSize?: number
    seq?: number
  }): Promise<any>
}
```

#### 4.4.4 ContactModule - 联系人管理

**职责**：好友添加、删除、列表查询

**关键方法**：
```typescript
class ContactService {
  async addContact(dto: AddContactDto): Promise<any>
  async deleteContact(dto: DeleteContactDto): Promise<any>
  async getContactList(token: string): Promise<any>
}
```

#### 4.4.5 RoomModule - 群聊管理

**职责**：群聊创建、成员管理、群公告

**关键方法**：
```typescript
class RoomService {
  async createRoom(dto: CreateRoomDto): Promise<any>
  async addMember(dto: AddMemberDto): Promise<any>
  async removeMember(dto: RemoveMemberDto): Promise<any>
  async setAnnouncement(dto: SetAnnouncementDto): Promise<any>
}
```

---

## 5. 数据流设计

### 5.1 消息接收和 AI 回复流程

```
┌─────────────────────┐
│   企业微信用户       │
│   发送消息          │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────────────────────┐
│   企业微信托管平台                   │
│   1. 接收企业微信消息                │
│   2. 触发消息回调                    │
└──────────┬──────────────────────────┘
           │ POST /message
           ▼
┌─────────────────────────────────────┐
│   MessageController                  │
│   接收托管平台回调                   │
└──────────┬──────────────────────────┘
           │
           ▼
┌─────────────────────────────────────┐
│   MessageService                     │
│   1. 解析消息数据                    │
│   2. 判断是否需要 AI 回复            │
│   3. 生成会话 ID                     │
└──────────┬──────────────────────────┘
           │
           ▼
┌─────────────────────────────────────┐
│   ConversationService                │
│   1. 生成 conversationId             │
│   2. 获取历史消息                    │
│   3. 添加用户消息到历史              │
└──────────┬──────────────────────────┘
           │
           ▼
┌─────────────────────────────────────┐
│   AgentService                       │
│   1. 构建 AI 请求                    │
│   2. 调用 花卷agent API            │
│   3. 获取 AI 回复                    │
│   4. 保存助手消息到历史              │
└──────────┬──────────────────────────┘
           │
           ▼
┌─────────────────────────────────────┐
│   MessageSenderService               │
│   1. 构建发送消息请求                │
│   2. 调用托管平台发送 API            │
└──────────┬──────────────────────────┘
           │
           ▼
┌─────────────────────────────────────┐
│   企业微信托管平台                   │
│   通过企业微信发送回复给用户         │
└──────────┬──────────────────────────┘
           │
           ▼
┌─────────────────────┐
│   企业微信用户       │
│   收到 AI 回复      │
└─────────────────────┘
```

### 5.2 会话管理数据流

```
┌──────────────────────────────────────────┐
│   第一轮对话                              │
├──────────────────────────────────────────┤
│                                          │
│   用户: "我叫张三"                        │
│          ↓                               │
│   ConversationService                    │
│   - conversationId: "user_wxid_123"     │
│   - messages: [                          │
│       { role: "user", content: "我叫张三" }│
│     ]                                    │
│          ↓                               │
│   AgentService                           │
│   - 调用 AI API                          │
│   - 返回: "你好张三，很高兴认识你"        │
│          ↓                               │
│   ConversationService                    │
│   - messages: [                          │
│       { role: "user", content: "我叫张三" },│
│       { role: "assistant", content: "你好张三..." }│
│     ]                                    │
└──────────────────────────────────────────┘

┌──────────────────────────────────────────┐
│   第二轮对话（上下文记忆）                 │
├──────────────────────────────────────────┤
│                                          │
│   用户: "我叫什么名字？"                  │
│          ↓                               │
│   ConversationService                    │
│   - conversationId: "user_wxid_123"     │
│   - 获取历史: [                          │
│       { role: "user", content: "我叫张三" },│
│       { role: "assistant", content: "..." },│
│       { role: "user", content: "我叫什么名字？" }│
│     ]                                    │
│          ↓                               │
│   AgentService                           │
│   - 带上历史消息调用 AI                   │
│   - AI 根据上下文回答: "你叫张三"         │
│          ↓                               │
│   ConversationService                    │
│   - 保存新的对话轮次                     │
└──────────────────────────────────────────┘
```

### 5.3 消息发送数据流

```
┌─────────────────────────────────────┐
│   业务层                             │
│   (MessageService/其他服务)         │
└─────────────┬───────────────────────┘
              │ sendMessage(dto)
              ▼
┌─────────────────────────────────────┐
│   MessageSenderService               │
│   1. 验证参数                        │
│   2. 构建请求体                      │
│   3. 调用 HttpService                │
└─────────────┬───────────────────────┘
              │
              ▼
┌─────────────────────────────────────┐
│   HttpService                        │
│   1. 添加请求拦截器                  │
│   2. 发送 POST 请求                  │
│   3. 处理响应                        │
└─────────────┬───────────────────────┘
              │ HTTP POST
              ▼
┌─────────────────────────────────────┐
│   企业微信托管平台 API               │
│   /api/wechat/sendMessage           │
└─────────────┬───────────────────────┘
              │
              ▼
┌─────────────────────────────────────┐
│   企业微信                           │
│   消息投递给用户                     │
└─────────────────────────────────────┘
```

---

## 6. 接口设计

### 6.1 RESTful API 设计原则

- **统一的响应格式**：所有接口返回统一的数据结构
- **语义化路径**：路径清晰表达资源和操作
- **HTTP 状态码**：正确使用状态码表示结果
- **版本控制**：预留版本控制能力（如 `/api/v1/`）

### 6.2 核心接口

#### 6.2.1 消息回调接口

```
POST /message
Content-Type: application/json

Request Body:
{
  "token": "group_token",           // 小组级 token
  "msgId": "msg-123",               // 消息 ID
  "contactId": "wxid_xxxxx",        // 发送者微信 ID
  "contactName": "张三",             // 发送者昵称
  "messageType": 7,                 // 消息类型（7=文本）
  "content": "用户发送的消息",       // 消息内容
  "roomId": "room_xxx@chatroom",    // 群聊 ID（群聊时）
  "roomName": "产品讨论群",          // 群名称（群聊时）
  "isRoom": false,                  // 是否群聊
  "chatId": "chat_123",             // 会话 ID
  "botWxid": "wxid_bot",            // 机器人微信 ID
  "isSelf": false,                  // 是否机器人自己发的
  "mentionSelf": false,             // 是否 @ 机器人
  "timestamp": 1697000000000        // 时间戳
}

Response:
{
  "success": true,
  "message": "Message processed successfully"
}
```

#### 6.2.2 AI 测试接口

```
POST /agent/test-chat
Content-Type: application/json

Request Body:
{
  "message": "你好",
  "conversationId": "test-user"
}

Response:
{
  "success": true,
  "data": {
    "messages": [
      {
        "role": "assistant",
        "parts": [
          { "type": "text", "text": "你好！有什么可以帮助你的吗？" }
        ]
      }
    ],
    "usage": {
      "promptTokens": 10,
      "completionTokens": 15,
      "totalTokens": 25
    }
  }
}
```

#### 6.2.3 消息发送接口

```
POST /message-sender/send
Content-Type: application/json

Request Body:
{
  "token": "group_token",
  "content": "消息内容",
  "toWxid": "wxid_xxxxx",
  "msgType": 1
}

Response:
{
  "success": true,
  "data": {
    "msgId": "msg-456"
  }
}
```

### 6.3 错误处理

**错误响应格式**：
```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "错误描述",
    "details": {}
  }
}
```

**常见错误码**：
- `INVALID_TOKEN`: Token 无效或过期
- `AI_SERVICE_ERROR`: AI 服务调用失败
- `MESSAGE_SEND_FAILED`: 消息发送失败
- `INVALID_PARAMS`: 参数验证失败

---

## 7. 部署架构

### 7.1 单机部署架构

```
┌────────────────────────────────────────────────┐
│                服务器 (Linux)                   │
├────────────────────────────────────────────────┤
│                                                │
│  ┌──────────────────────────────────────┐     │
│  │  Nginx (反向代理)                     │     │
│  │  - 端口: 80/443                       │     │
│  │  - SSL 证书                           │     │
│  │  - 负载均衡（可选）                    │     │
│  └──────────┬───────────────────────────┘     │
│             │                                  │
│             ▼                                  │
│  ┌──────────────────────────────────────┐     │
│  │  DuLiDay 企业微信服务 (PM2)          │     │
│  │  - 端口: 8080                         │     │
│  │  - 进程数: 2-4                        │     │
│  │  - 自动重启                           │     │
│  └──────────────────────────────────────┘     │
│                                                │
│  ┌──────────────────────────────────────┐     │
│  │  日志系统                             │     │
│  │  - Winston                            │     │
│  │  - logs/ 目录                         │     │
│  │  - 按日期归档                         │     │
│  └──────────────────────────────────────┘     │
│                                                │
└────────────────────────────────────────────────┘
         │                            │
         │ 外部 API 调用              │
         ▼                            ▼
┌─────────────────┐         ┌─────────────────┐
│ 企业微信托管平台 │         │ agent-computer  │
│ stride API      │         │ -user AI API    │
└─────────────────┘         └─────────────────┘
```

### 7.2 容器化部署架构

```
┌────────────────────────────────────────────────┐
│              Docker Host                       │
├────────────────────────────────────────────────┤
│                                                │
│  ┌──────────────────────────────────────┐     │
│  │  Nginx Container                      │     │
│  │  - 端口映射: 80:80, 443:443           │     │
│  └──────────┬───────────────────────────┘     │
│             │                                  │
│             ▼                                  │
│  ┌──────────────────────────────────────┐     │
│  │  App Container (DuLiDay Service)     │     │
│  │  - 端口映射: 8080:8080                │     │
│  │  - 挂载: ./logs:/app/logs             │     │
│  │  - 挂载: ./.env:/app/.env             │     │
│  │  - 重启策略: always                   │     │
│  └──────────────────────────────────────┘     │
│                                                │
└────────────────────────────────────────────────┘
```

**Docker Compose 配置**：
```yaml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "8080:8080"
    environment:
      - NODE_ENV=production
    env_file:
      - .env
    volumes:
      - ./logs:/app/logs
    restart: always
```

### 7.3 生产环境配置建议

**环境变量**：
```env
# 生产环境
NODE_ENV=production
PORT=8080

# Agent API
AGENT_API_KEY=prod_api_key
AGENT_API_BASE_URL=https://api.wolian.cc/api/v1
AGENT_DEFAULT_MODEL=anthropic/claude-3-7-sonnet-20250219
ENABLE_AI_REPLY=true

# 托管平台
STRIDE_API_BASE_URL=https://stride-bg.dpclouds.com
```

**Nginx 配置**：
```nginx
server {
    listen 80;
    server_name yourdomain.com;

    location / {
        proxy_pass http://localhost:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;

        # 超时配置（AI 回复可能较慢）
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
```

**PM2 配置**：
```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'duliday-wecom-service',
    script: 'dist/main.js',
    instances: 2,
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 8080
    },
    error_file: './logs/pm2-error.log',
    out_file: './logs/pm2-out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss',
    max_memory_restart: '500M'
  }]
}
```

---

## 8. 扩展性设计

### 8.1 模块扩展

**添加新的业务模块步骤**：

1. 创建模块目录和文件：
```bash
src/modules/your-module/
├── your-module.module.ts
├── your-module.service.ts
├── your-module.controller.ts
└── dto/
    └── your-module.dto.ts
```

2. 在 `app.module.ts` 中导入：
```typescript
@Module({
  imports: [
    // ... 其他模块
    YourModule,
  ],
})
export class AppModule {}
```

### 8.2 自定义消息处理逻辑

在 `MessageService` 中扩展：

```typescript
@Injectable()
export class MessageService {
  async processMessageWithAI(messageData: IncomingMessageData) {
    // 1. 自定义过滤逻辑
    if (this.shouldIgnore(messageData.content)) {
      this.logger.log('忽略此消息');
      return;
    }

    // 2. 自定义场景识别
    const scenario = this.detectScenario(messageData);

    // 3. 根据场景使用不同的系统提示词
    const systemPrompt = this.getSystemPrompt(scenario);

    // 4. 调用 AI 生成回复
    const reply = await this.agentService.chat({
      conversationId,
      userMessage: messageData.content,
      systemPrompt
    });

    // 5. 发送回复
    await this.messageSenderService.sendMessage({...});
  }

  private shouldIgnore(content: string): boolean {
    // 自定义过滤规则
    const ignoreKeywords = ['广告', '营销'];
    return ignoreKeywords.some(k => content.includes(k));
  }

  private detectScenario(messageData: any): ScenarioType {
    // 自定义场景识别逻辑
    if (messageData.roomName?.includes('客服')) {
      return ScenarioType.CUSTOMER_SERVICE;
    }
    return ScenarioType.GENERAL;
  }
}
```

### 8.3 集成新的 AI 服务

如果要替换或添加新的 AI 服务：

1. 创建新的 AI 服务：
```typescript
@Injectable()
export class NewAIService {
  async generateReply(message: string, context: any) {
    // 实现新的 AI 调用逻辑
  }
}
```

2. 在 `MessageService` 中切换：
```typescript
constructor(
  private readonly agentService: AgentService,
  private readonly newAIService: NewAIService,
) {}

async processMessageWithAI(messageData: IncomingMessageData) {
  // 根据配置选择 AI 服务
  const aiService = this.useNewAI
    ? this.newAIService
    : this.agentService;

  const reply = await aiService.generateReply(message, context);
}
```

### 8.4 存储扩展

当前会话管理使用内存存储，可以扩展为持久化存储：

**方案 1：Redis 存储**
```typescript
@Injectable()
export class RedisConversationService implements IConversationService {
  constructor(private readonly redis: RedisService) {}

  async getHistory(conversationId: string): Promise<any[]> {
    const data = await this.redis.get(`conversation:${conversationId}`);
    return JSON.parse(data || '[]');
  }

  async addMessage(conversationId: string, message: any): Promise<void> {
    const history = await this.getHistory(conversationId);
    history.push(message);
    await this.redis.set(
      `conversation:${conversationId}`,
      JSON.stringify(history),
      'EX',
      7200  // 2小时过期
    );
  }
}
```

**方案 2：数据库存储**
```typescript
@Injectable()
export class DatabaseConversationService implements IConversationService {
  constructor(
    @InjectRepository(Conversation)
    private readonly conversationRepo: Repository<Conversation>,
    @InjectRepository(Message)
    private readonly messageRepo: Repository<Message>,
  ) {}

  async getHistory(conversationId: string): Promise<any[]> {
    const messages = await this.messageRepo.find({
      where: { conversationId },
      order: { createdAt: 'ASC' }
    });
    return messages.map(m => ({
      role: m.role,
      content: m.content
    }));
  }
}
```

### 8.5 中间件和拦截器

**全局异常处理**：
```typescript
@Catch()
export class GlobalExceptionFilter implements ExceptionFilter {
  catch(exception: any, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse();

    response.status(500).json({
      success: false,
      error: {
        code: 'INTERNAL_ERROR',
        message: exception.message
      }
    });
  }
}
```

**请求日志中间件**：
```typescript
@Injectable()
export class LoggingInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    const req = context.switchToHttp().getRequest();
    const method = req.method;
    const url = req.url;

    console.log(`[${method}] ${url}`);

    return next.handle().pipe(
      tap(() => console.log(`[${method}] ${url} - Success`))
    );
  }
}
```

---

## 附录

### A. 环境变量清单

| 变量名 | 说明 | 默认值 | 必填 |
|--------|------|--------|------|
| `NODE_ENV` | 运行环境 | development | 否 |
| `PORT` | 服务端口 | 8080 | 否 |
| `AGENT_API_KEY` | AI API 密钥 | - | 是 |
| `AGENT_API_BASE_URL` | AI API 地址 | http://localhost:3000/api/v1 | 是 |
| `AGENT_DEFAULT_MODEL` | 默认 AI 模型 | anthropic/claude-3-7-sonnet-20250219 | 否 |
| `ENABLE_AI_REPLY` | 启用 AI 自动回复 | true | 否 |
| `STRIDE_API_BASE_URL` | 托管平台 API 地址 | - | 是 |

### B. API 端点清单

| 端点 | 方法 | 说明 |
|------|------|------|
| `/message` | POST | 接收托管平台消息回调 |
| `/agent/health` | GET | AI 服务健康检查 |
| `/agent/models` | GET | 获取可用 AI 模型 |
| `/agent/tools` | GET | 获取可用工具 |
| `/agent/test-chat` | POST | 测试 AI 对话 |
| `/message-sender/send` | POST | 发送单条消息 |
| `/message-sender/broadcast` | POST | 群发消息 |
| `/chat/list` | GET | 获取会话列表 |
| `/chat/history` | GET | 获取聊天历史 |
| `/contact/add` | POST | 添加好友 |
| `/contact/delete` | POST | 删除好友 |
| `/contact/list` | GET | 获取联系人列表 |
| `/room/create` | POST | 创建群聊 |
| `/room/add-member` | POST | 邀请入群 |
| `/room/remove-member` | POST | 移除成员 |

### C. 相关文档链接

- **NestJS 官方文档**：https://docs.nestjs.com/
- **企业微信托管平台 API**：
  - 企业级 API：https://s.apifox.cn/34adc635-40ac-4161-8abb-8cd1eea9f445
  - 小组级 API：https://s.apifox.cn/acec6592-fec1-443b-8563-10c4a10e64c4
- **Agent API 文档**：https://docs.wolian.cc/

---

**文档版本**：v1.0
**最后更新**：2025-10-14
**维护者**：DuLiDay Team
