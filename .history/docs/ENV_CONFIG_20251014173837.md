# 环境变量配置指南

## 概述

项目采用多环境配置方案，支持开发环境、测试环境和生产环境的独立配置。

## 配置文件说明

### 配置文件列表

| 文件名 | 用途 | 是否提交到 Git |
|--------|------|----------------|
| `.env.example` | 配置模板，包含所有可用的环境变量说明 | ✅ 提交 |
| `.env` | 本地开发覆盖配置（可选） | ❌ 不提交 |
| `.env.development` | 开发环境配置 | ✅ 提交 |
| `.env.production` | 生产环境配置（敏感信息需单独管理） | ⚠️ 谨慎提交 |
| `.env.test` | 测试环境配置 | ✅ 提交 |

### 配置加载顺序

应用启动时，会按以下优先级加载配置：

```
1. 系统环境变量（最高优先级）
   ↓
2. .env.${NODE_ENV} 文件（如 .env.production）
   ↓
3. .env 文件（默认配置）
```

## 环境变量清单

### 应用配置

| 变量名 | 说明 | 默认值 | 开发环境 | 生产环境 | 测试环境 |
|--------|------|--------|----------|----------|----------|
| `PORT` | 服务监听端口 | `8080` | `8080` | `8080` | `8081` |
| `NODE_ENV` | 运行环境 | `development` | `development` | `production` | `test` |

### Agent API 配置

| 变量名 | 说明 | 默认值 | 开发环境 | 生产环境 | 必填 |
|--------|------|--------|----------|----------|------|
| `AGENT_API_KEY` | AI Agent API 密钥 | - | `dev-test-token` | **需配置** | ✅ |
| `AGENT_API_BASE_URL` | API 基地址 | `http://localhost:3000/api/v1` | `http://localhost:3000/api/v1` | `https://api.wolian.cc/api/v1` | ✅ |
| `AGENT_DEFAULT_MODEL` | 默认 AI 模型 | `anthropic/claude-3-7-sonnet-20250219` | 同默认值 | 同默认值 | ❌ |
| `AGENT_API_TIMEOUT` | 请求超时时间（毫秒） | `60000` | `60000` | `60000` | ❌ |
| `ENABLE_AI_REPLY` | 是否启用 AI 自动回复 | `true` | `true` | `true` | ❌ |

### 托管平台 API 配置

| 变量名 | 说明 | 默认值 | 开发环境 | 生产环境 | 必填 |
|--------|------|--------|----------|----------|------|
| `STRIDE_API_BASE_URL` | Stride API 基地址 | `https://stride-bg.dpclouds.com` | 同默认值 | 同默认值 | ✅ |

### 会话管理配置

| 变量名 | 说明 | 默认值 | 开发环境 | 生产环境 |
|--------|------|--------|----------|----------|
| `CONVERSATION_MAX_MESSAGES` | 每个会话保留的最大消息数 | `20` | `20` | `50` |
| `CONVERSATION_TIMEOUT_MS` | 会话超时时间（毫秒） | `7200000`（2小时） | `7200000` | `14400000`（4小时） |
| `CONVERSATION_CLEANUP_INTERVAL_MS` | 会话清理检查间隔（毫秒） | `3600000`（1小时） | `3600000` | `3600000` |

### HTTP 客户端配置

| 变量名 | 说明 | 默认值 | 开发环境 | 生产环境 |
|--------|------|--------|----------|----------|
| `HTTP_CLIENT_TIMEOUT` | HTTP 请求超时时间（毫秒） | `10000` | `10000` | `30000` |

## 使用方法

### 1. 初始化配置

首次使用时，复制模板文件：

```bash
# 复制模板文件
cp .env.example .env

# 编辑配置文件，填入实际的 API Key 等敏感信息
vim .env
```

### 2. 启动不同环境

#### 开发环境

```bash
# 使用 .env.development 配置
npm run start:dev

# 或者手动指定
NODE_ENV=development npm start
```

#### 生产环境

```bash
# 使用 .env.production 配置
npm run start:prod

# 或者手动指定
NODE_ENV=production node dist/main
```

#### 测试环境

```bash
# 使用 .env.test 配置
npm run start:test

# 运行单元测试
npm run test
```

### 3. 环境变量覆盖

可以在启动时通过环境变量覆盖配置文件中的值：

```bash
# 覆盖端口号
PORT=9000 npm run start:dev

# 覆盖多个配置
PORT=9000 ENABLE_AI_REPLY=false npm run start:dev
```

## 配置最佳实践

### ✅ 推荐做法

1. **使用环境文件管理配置**
   - 所有配置项都在 `.env` 文件中定义
   - 不同环境使用不同的配置文件

2. **敏感信息安全管理**
   - `.env.production` 中的敏感信息（API Key）使用环境变量或密钥管理系统
   - 本地开发的 `.env` 文件不提交到 Git

3. **保持配置文件同步**
   - `.env.example` 始终保持最新
   - 添加新配置时同步更新所有环境的配置文件

4. **使用有意义的默认值**
   - 为每个配置提供合理的默认值
   - 必填配置在代码中做校验

### ❌ 避免的做法

1. **不要在代码中硬编码配置**
   ```typescript
   // ❌ 错误
   const apiUrl = 'https://api.example.com';
   
   // ✅ 正确
   const apiUrl = this.configService.get<string>('API_URL');
   ```

2. **不要提交敏感信息到 Git**
   - API Key、数据库密码等敏感信息不要直接写在配置文件中
   - 使用占位符或环境变量

3. **不要在多处读取环境变量**
   ```typescript
   // ❌ 错误
   const apiKey = process.env.AGENT_API_KEY;
   
   // ✅ 正确
   const apiKey = this.configService.get<string>('AGENT_API_KEY');
   ```

## 配置验证

### 必填配置检查

启动时会自动校验关键配置，确保生产环境的配置完整性：

```typescript
// 在服务构造函数中验证
constructor(private readonly configService: ConfigService) {
  const apiKey = this.configService.get<string>('AGENT_API_KEY');
  if (!apiKey && process.env.NODE_ENV === 'production') {
    throw new Error('生产环境必须配置 AGENT_API_KEY');
  }
}
```

### 配置检查清单

部署前检查以下配置：

- [ ] `AGENT_API_KEY` - 已配置有效的 API Key
- [ ] `AGENT_API_BASE_URL` - 指向正确的 API 地址
- [ ] `STRIDE_API_BASE_URL` - 指向正确的托管平台地址
- [ ] `NODE_ENV` - 设置为 `production`
- [ ] 超时配置 - 根据实际情况调整
- [ ] 会话配置 - 根据业务需求调整

## 生产环境部署

### 方式一：使用环境变量（推荐）

```bash
# 在服务器上设置环境变量
export NODE_ENV=production
export AGENT_API_KEY=your-production-api-key
export AGENT_API_BASE_URL=https://api.wolian.cc/api/v1

# 启动服务
npm run start:prod
```

### 方式二：使用 .env.production 文件

```bash
# 在服务器上创建 .env.production 文件
cat > .env.production << EOF
NODE_ENV=production
AGENT_API_KEY=your-production-api-key
AGENT_API_BASE_URL=https://api.wolian.cc/api/v1
EOF

# 启动服务
npm run start:prod
```

### 方式三：使用 Docker（推荐）

```dockerfile
# Dockerfile
FROM node:20-alpine
WORKDIR /app
COPY . .
RUN npm install && npm run build

# 使用环境变量
ENV NODE_ENV=production

CMD ["node", "dist/main"]
```

```bash
# docker-compose.yml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "8080:8080"
    environment:
      - NODE_ENV=production
      - AGENT_API_KEY=${AGENT_API_KEY}
      - AGENT_API_BASE_URL=${AGENT_API_BASE_URL}
```

## 故障排查

### 问题：配置未生效

**可能原因：**
1. 环境变量优先级问题
2. 配置文件未正确加载
3. NODE_ENV 设置错误

**解决方法：**
```bash
# 查看当前使用的配置
console.log('NODE_ENV:', process.env.NODE_ENV);
console.log('PORT:', this.configService.get('PORT'));

# 检查配置文件是否存在
ls -la .env*
```

### 问题：敏感信息泄露

**预防措施：**
1. 检查 `.gitignore` 包含 `.env` 文件
2. 使用 `git secrets` 工具扫描
3. 定期轮换 API Key

## 相关文档

- [API 配置管理](./API_CONFIG.md)
- [架构设计](./ARCHITECTURE.md)
- [快速开始](../README.md)

## 更新日志

- **2025-10-14**: 初始版本，支持多环境配置
- 新增开发、生产、测试环境配置文件
- 移除所有硬编码配置
- 统一使用 ConfigService 管理配置

