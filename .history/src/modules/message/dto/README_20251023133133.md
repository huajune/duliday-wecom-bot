# 消息 DTO 结构说明

本文档说明企微机器人托管平台消息回调的数据结构和使用方法。

## API 文档

完整的 API 文档请参考：https://s.apifox.cn/acec6592-fec1-443b-8563-10c4a10e64c4/315431403e0

## 核心类型定义

### IncomingMessageData

接收消息的主接口，所有数据都在 `data` 字段中。

```typescript
interface IncomingMessageData {
  data: {
    // 基本信息
    messageId: string;        // 消息唯一标识
    chatId: string;           // 对话ID
    timestamp: string;        // 消息时间戳
    type: MessageType;        // 消息类型
    payload: any;             // 消息内容详情

    // 机器人信息
    botId: string;            // bot账号ID
    botWxid: string;          // 托管账号系统wxid
    botWeixin: string;        // 托管账号IM员工ID
    token: string;            // 小组级token

    // 联系人信息
    contactName: string;      // 客户姓名
    contactId: string;        // 客户系统wxid
    externalUserId: string;   // IM联系人ID
    chatExternalUserId: string; // 客户externalUserId
    contactType: ContactType; // 客户类型
    coworker: boolean;        // 是否内部员工

    // 群聊信息（群聊消息时存在）
    roomId?: string;          // 群聊系统wxid
    roomTopic?: string;       // 群名称
    roomWecomChatId?: string; // IM群聊ID

    // 消息状态
    isSelf: boolean;          // 是否托管账号自己发送
    mentionSelf: boolean;     // 是否@托管账号
    source?: MessageSource;   // 消息来源

    // 其他信息
    avatar?: string;          // 头像URL
    sendBy?: string;          // 发送者秒回ID
  };
}
```

## 消息类型枚举

### MessageType

| 值 | 类型 | Payload 类型 | 说明 |
|----|------|--------------|------|
| 1 | FILE | `FilePayload` | 文件 |
| 2 | VOICE | `VoicePayload` | 语音 |
| 3 | CONTACT_CARD | `ContactCardPayload` | 名片 |
| 4 | CHAT_HISTORY | `string` | 聊天历史 |
| 5 | EMOTION | `ImagePayload` | 表情 |
| 6 | IMAGE | `ImagePayload` | 图片 |
| 7 | TEXT | `TextPayload` | 文字 |
| 8 | LOCATION | `LocationPayload` | 位置 |
| 9 | MINI_PROGRAM | `MiniProgramPayload` | 小程序 |
| 10 | MONEY | `string` | 钱相关 |
| 11 | REVOKE | `string` | 撤回消息 |
| 12 | LINK | `LinkPayload` | 图文消息 |
| 13 | VIDEO | `VideoPayload` | 视频 |
| 14 | CHANNELS | `ChannelsPayload` | 视频号 |
| 15 | CALL_RECORD | `CallRecordPayload` | 通话记录 |
| 16 | GROUP_SOLITAIRE | - | 群聊接龙 |
| 9999 | ROOM_INVITE | `RoomInvitePayload` | 入群邀请 |
| 10000 | SYSTEM | `any` | 系统消息 |
| 10001 | WECOM_SYSTEM | `WecomSystemPayload` | 企微系统消息 |

### ContactType（客户类型）

```typescript
enum ContactType {
  UNKNOWN = 0,              // 未知
  EXTERNAL_CUSTOMER = 1,    // 外部客户
  INTERNAL_EMPLOYEE = 2,    // 内部员工
  GROUP = 3,                // 群聊
}
```

### MessageSource（消息来源）

```typescript
enum MessageSource {
  MOBILE_PUSH = 0,                  // 手机推送
  AGGREGATED_CHAT_MANUAL = 1,       // 聚合聊天手动发送
  ADVANCED_GROUP_SEND_SOP = 2,      // 高级群发/SOP
  AUTO_REPLY = 3,                   // 自动回复
  CREATE_GROUP = 4,                 // 创建群聊
  OTHER_BOT_REPLY = 5,              // 其他机器人回复
  API_SEND = 6,                     // API发消息
  NEW_CUSTOMER_ANSWER_SOP = 7,      // 新客户应答SOP
  API_GROUP_SEND = 8,               // API群发
  TAG_SOP = 9,                      // 标签SOP
  MULTI_GROUP_FORWARD = 11,         // 多群转播
  MULTI_GROUP_REPLAY = 12,          // 多群重播
  AUTO_END_CONVERSATION = 13,       // 自动结束会话
  SCHEDULED_MESSAGE = 14,           // 定时消息
  AI_REPLY = 15,                    // AI回复
}
```

## 常用 Payload 类型

### TextPayload（文本消息）

```typescript
interface TextPayload {
  text: string;              // 消息内容
  pureText?: string;         // 不含艾特信息的纯文本
  mention?: string[];        // 被@人的wxid列表
  quoteMessage?: QuoteMessage; // 引用消息
}
```

### ImagePayload（图片消息）

```typescript
interface ImagePayload {
  imageUrl: string;          // 压缩图片URL
  width: string;             // 缩略图宽度
  height: number;            // 缩略图高度
  size?: number;             // 文件大小
  artwork?: {                // 原图数据
    url: string;
    width: string;
    height: string;
  };
}
```

### WecomSystemPayload（企微系统消息）

```typescript
interface WecomSystemPayload {
  wechatSystemPayloadType: 0 | 1 | 2; // 0-入群, 1-离群, 2-修改群名
  subPayload: WecomSystemJoinPayload |
              WecomSystemLeavePayload |
              WecomSystemRenamePayload;
}
```

## 类型守卫函数

使用类型守卫函数可以安全地处理不同类型的消息：

```typescript
import { isTextPayload, isImagePayload, MessageType } from './dto/send-message.dto';

// 判断是否为文本消息
if (isTextPayload(data.type, data.payload)) {
  // TypeScript 自动推断 payload 类型为 TextPayload
  const text = data.payload.text;
  const pureText = data.payload.pureText;
}

// 判断是否为图片消息
if (isImagePayload(data.type, data.payload)) {
  // TypeScript 自动推断 payload 类型为 ImagePayload
  const imageUrl = data.payload.imageUrl;
}
```

## 使用示例

### 处理文本消息

```typescript
import {
  IncomingMessageData,
  MessageType,
  isTextPayload
} from './dto/send-message.dto';

function handleMessage(messageData: IncomingMessageData) {
  const { data } = messageData;

  // 跳过机器人自己发送的消息
  if (data.isSelf) {
    return;
  }

  // 处理文本消息
  if (isTextPayload(data.type, data.payload)) {
    const content = data.payload.pureText || data.payload.text;
    console.log(`收到消息: ${content}`);

    // 检查是否被@
    if (data.mentionSelf) {
      console.log('机器人被@了');
    }
  }
}
```

### 处理群聊消息

```typescript
function handleGroupMessage(messageData: IncomingMessageData) {
  const { data } = messageData;

  // 判断是否为群聊消息
  const isGroup = !!data.roomId;

  if (isGroup) {
    console.log(`群聊消息 - 群名: ${data.roomTopic}`);
    console.log(`发送者: ${data.contactName}`);

    // 只处理被@的消息
    if (data.mentionSelf && isTextPayload(data.type, data.payload)) {
      const content = data.payload.pureText || data.payload.text;
      // 处理群聊中的@消息
    }
  }
}
```

### 处理企微系统消息

```typescript
import {
  isWecomSystemPayload,
  WecomSystemJoinPayload
} from './dto/send-message.dto';

function handleSystemMessage(messageData: IncomingMessageData) {
  const { data } = messageData;

  if (isWecomSystemPayload(data.type, data.payload)) {
    const { wechatSystemPayloadType, subPayload } = data.payload;

    switch (wechatSystemPayloadType) {
      case 0: // 入群
        const joinPayload = subPayload as WecomSystemJoinPayload;
        console.log(`新成员入群: ${joinPayload.inviteeList.map(i => i.nickname).join(', ')}`);
        break;

      case 1: // 离群
        // 处理离群事件
        break;

      case 2: // 修改群名
        // 处理群名修改事件
        break;
    }
  }
}
```

### 根据消息来源过滤

```typescript
import { MessageSource } from './enums/message-source.enum';

function shouldProcessMessage(messageData: IncomingMessageData): boolean {
  const { data } = messageData;

  // 只处理手机推送和新客户应答SOP的消息
  return data.source === MessageSource.MOBILE_PUSH ||
         data.source === MessageSource.NEW_CUSTOMER_ANSWER_SOP;
}
```

## 完整示例

查看 [message-examples.ts](./message-examples.ts) 获取完整的示例数据。

## 注意事项

1. **必填字段**: `timestamp`、`mentionSelf`、`chatExternalUserId` 是必填字段
2. **群聊识别**: 通过 `roomId` 是否存在判断是否为群聊消息
3. **消息来源**: 根据 `source` 字段判断消息来源，决定是否处理
4. **自发消息**: 通过 `isSelf` 判断是否为机器人自己发送的消息，避免循环
5. **脱敏处理**: 生产环境日志会自动脱敏 token、wxid 等敏感信息
6. **类型安全**: 使用类型守卫函数确保 payload 类型安全
7. **时间戳**: `timestamp` 字段是字符串格式的毫秒时间戳，需要使用 `parseInt()` 转换

## 字段废弃说明

- `roomName`: 已废弃，请使用 `roomTopic`
- 旧格式的顶层字段已不再支持，所有数据现在都在 `data` 字段中

## 更新日志


